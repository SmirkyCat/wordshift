<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="theme-color" content="#0f1220" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Wordshift" />
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>Wordshift â€” Proximity Word Game (Compat + Diag)</title>
<style>
:root{
  --bg:#0f1220;--bg2:#0b0f20;--fg:#eaf0ff;--muted:#a7b0cb;
  --neutral:#2f3347; --neutral-brd:#444a66;
  --correct:#6aaa64;--near:#c9b458;--key:#2b2d39;--panel:#121630;--accent:#7c8cff;
  --vh:100dvh; --headerH:56px;
}
:root[data-theme="classic"]{--bg:#0f1220;--bg2:#0b0f20;--fg:#eaf0ff;--muted:#a7b0cb;--correct:#6aaa64;--near:#c9b458;--accent:#7c8cff;--key:#2b2d39;--panel:#121630}
:root[data-theme="ocean"]  {--bg:#02131f;--bg2:#01202e;--fg:#e6fbff;--muted:#9bd0dd;--correct:#00b894;--near:#00cec9;--accent:#0984e3;--key:#072636;--panel:#0a3042}
:root[data-theme="sunset"] {--bg:#220a21;--bg2:#2d0f1e;--fg:#ffeef6;--muted:#f3b7d1;--correct:#ff7675;--near:#fdcb6e;--accent:#e17055;--key:#3a1a2f;--panel:#421b2c}
:root[data-theme="neo"]    {--bg:#0b0b12;--bg2:#10101a;--fg:#f6f7ff;--muted:#a8acf0;--correct:#6ee7b7;--near:#fbbf24;--accent:#a78bfa;--key:#17172a;--panel:#131328}
:root[data-theme="pastel"] {--bg:#191a23;--bg2:#1f202a;--fg:#fafaff;--muted:#c9d0ff;--correct:#a6e3a1;--near:#f9e2af;--accent:#b4befe;--key:#2a2b3d;--panel:#23243a}
:root[data-theme="contrast"]{--bg:#000;--bg2:#050505;--fg:#fff;--muted:#bbb;--correct:#00ff66;--near:#ffff00;--accent:#00aaff;--key:#111;--panel:#0d0d0d}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
#app{height:var(--vh);display:flex;flex-direction:column;align-items:center;gap:10px;
  padding:max(8px,env(safe-area-inset-top)) 8px max(8px,env(safe-area-inset-bottom));overflow:hidden}
#app.screen{display:flex}
#app.screen.active{display:flex}
.screen{
  position:fixed;inset:0;min-height:var(--vh);width:100%;
  opacity:0;pointer-events:none;transform:translateY(10px) scale(.985);
  transition:opacity .28s ease, transform .35s ease
}
.screen.active{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
#menuScreen{display:flex;align-items:center;justify-content:center;padding:16px}
#campaignMenuScreen{display:flex;align-items:center;justify-content:center;padding:16px}
.menu-card{
  width:min(92vw,640px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);
  border-radius:20px;padding:28px 24px 32px;box-shadow:0 20px 70px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.03) inset;text-align:center;
  backdrop-filter:blur(8px);
}
.menu-title{font-size:1.7rem;letter-spacing:.24em;margin:8px 0 6px;font-weight:900;text-shadow:0 2px 12px rgba(0,0,0,.3)}
.menu-sub{color:var(--muted);margin:0 0 20px;font-size:.95rem;line-height:1.5}
.menu-actions{display:grid;gap:10px;margin-top:12px}
.menu-section{margin-top:12px;text-align:left}
.menu-section h3{margin:8px 0 6px;font-size:.95rem;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
.menu-grid{display:grid;grid-template-columns:1fr;gap:8px}
.menu-pill{display:flex;justify-content:space-between;gap:12px;align-items:center}
.menu-pill small{opacity:.7;letter-spacing:.1em}
.menu-scroll{max-height:52svh;overflow-y:auto;padding-right:4px}
.menu-scroll::-webkit-scrollbar{width:8px}
.menu-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:999px}
.menu-pill .pill-left{display:flex;gap:10px;align-items:center}
.menu-pill .reset-btn{
  width:28px;height:28px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.2);color:var(--muted);cursor:pointer;line-height:1
}
.menu-pill .reset-btn:active{transform:scale(.96)}
.menu-pill.disabled{opacity:.45;filter:saturate(.6)}
.menu-badge{display:inline-flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.12em}
.menu-coin{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);font-size:.8rem}
.menu-meta{display:flex;gap:8px;align-items:center}
.menu-lock{opacity:.7}
.map-wrap{
  width:min(94vw,980px);
  background:rgba(3,8,18,.55);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:14px;
  box-shadow:0 16px 60px rgba(0,0,0,.45);
}
.map-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.map-title{font-size:1.1rem;letter-spacing:.14em;margin:0;text-transform:uppercase}
.map-sub{color:var(--muted);margin:0;font-size:.9rem}
#campaignMap{
  position:relative;
  height:min(62svh,520px);
  border-radius:14px;
  overflow:hidden;
  user-select:none;
  -webkit-user-select:none;
  touch-action:none;
  --parallax-x:0px;
  --parallax-y:0px;
  --parallax-x2:0px;
  --parallax-y2:0px;
  --cluster-hue:0deg;
  background:
    radial-gradient(320px 240px at 65% 40%, rgba(18,52,80,.3), transparent 70%),
    radial-gradient(260px 200px at 28% 72%, rgba(12,60,72,.28), transparent 72%),
    radial-gradient(200px 160px at 78% 22%, rgba(18,32,60,.32), transparent 70%),
    radial-gradient(180px 140px at 18% 20%, rgba(8,20,38,.5), transparent 70%),
    linear-gradient(180deg, rgba(3,6,14,.98), rgba(2,4,10,1));
}
#campaignMap *{
  user-select:none;
  -webkit-user-select:none;
}
#campaignMap::before{
  content:'';position:absolute;inset:-12%;pointer-events:none;z-index:0;
  background:
    radial-gradient(180px 120px at 56% 44%, rgba(210,230,255,.28), transparent 70%),
    radial-gradient(260px 210px at 40% 64%, rgba(70,140,175,.2), transparent 72%),
    radial-gradient(220px 170px at 74% 58%, rgba(50,110,150,.18), transparent 72%),
    conic-gradient(from 140deg at 56% 46%, rgba(60,120,150,.2), rgba(0,0,0,0) 35%, rgba(50,110,150,.22) 55%, rgba(0,0,0,0) 76%, rgba(70,150,170,.18) 100%);
  transform:translate3d(var(--parallax-x2), var(--parallax-y2), 0);
  will-change:transform;
  mix-blend-mode:screen;
  opacity:.85;
}
#campaignMap::after{
  content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(1px 1px at 6% 12%, rgba(255,255,255,.95), transparent 60%),
    radial-gradient(1px 1px at 14% 40%, rgba(200,235,255,.75), transparent 60%),
    radial-gradient(1px 1px at 18% 22%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(1px 1px at 24% 8%, rgba(210,235,255,.8), transparent 60%),
    radial-gradient(2px 2px at 28% 72%, rgba(255,255,255,.75), transparent 70%),
    radial-gradient(1px 1px at 32% 38%, rgba(190,225,255,.7), transparent 60%),
    radial-gradient(1px 1px at 38% 72%, rgba(255,255,255,.92), transparent 60%),
    radial-gradient(1px 1px at 40% 16%, rgba(210,235,255,.82), transparent 60%),
    radial-gradient(2px 2px at 46% 86%, rgba(255,255,255,.72), transparent 70%),
    radial-gradient(1px 1px at 48% 54%, rgba(200,230,255,.78), transparent 60%),
    radial-gradient(1px 1px at 54% 74%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2px 2px at 58% 18%, rgba(220,240,255,.7), transparent 70%),
    radial-gradient(1px 1px at 62% 12%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(1px 1px at 68% 44%, rgba(200,230,255,.76), transparent 60%),
    radial-gradient(2px 2px at 70% 30%, rgba(255,255,255,.75), transparent 70%),
    radial-gradient(1px 1px at 74% 68%, rgba(210,235,255,.82), transparent 60%),
    radial-gradient(1px 1px at 76% 50%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2px 2px at 82% 26%, rgba(200,235,255,.7), transparent 70%),
    radial-gradient(1px 1px at 84% 80%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(3px 3px at 86% 40%, rgba(210,235,255,.52), transparent 72%),
    radial-gradient(1px 1px at 88% 64%, rgba(255,255,255,.88), transparent 60%),
    radial-gradient(2px 2px at 90% 12%, rgba(210,235,255,.7), transparent 70%),
    radial-gradient(1px 1px at 92% 66%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2px 2px at 12% 70%, rgba(220,240,255,.7), transparent 70%),
    radial-gradient(1px 1px at 20% 54%, rgba(255,255,255,.82), transparent 60%),
    radial-gradient(1px 1px at 30% 88%, rgba(200,235,255,.75), transparent 60%),
    radial-gradient(1px 1px at 56% 30%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2px 2px at 60% 90%, rgba(210,235,255,.6), transparent 70%),
    radial-gradient(10px 10px at 22% 28%, rgba(120,170,255,.18), transparent 70%),
    radial-gradient(12px 12px at 72% 36%, rgba(140,190,255,.16), transparent 72%),
    radial-gradient(14px 14px at 52% 82%, rgba(110,160,255,.15), transparent 72%),
    radial-gradient(10px 10px at 78% 76%, rgba(150,200,255,.12), transparent 72%);
  background-repeat:no-repeat;
  opacity:.95;mix-blend-mode:screen;
  filter:hue-rotate(var(--cluster-hue,0deg)) drop-shadow(0 0 6px rgba(140,200,255,.55)) drop-shadow(0 0 14px rgba(90,150,255,.35));
  transform:translate3d(var(--parallax-x), var(--parallax-y), 0);
  will-change:transform;
}
#campaignPan{
  position:absolute;inset:0;
  width:170%;
  height:170%;
  transform:translate(0,0);
  touch-action:none;
  z-index:1;
}
#campaignSvg{
  position:absolute;inset:0;z-index:1;
  width:100%;height:100%;
  pointer-events:none;
  overflow:visible;
  display:block;
}
#campaignSvg line{vector-effect:non-scaling-stroke}
#campaignSvg circle{vector-effect:non-scaling-stroke}
#campaignNodes{position:absolute;inset:0;z-index:2}
.map-node{
  position:absolute;transform:translate(-50%,-50%);
  min-width:130px;max-width:170px;padding:8px 12px;border-radius:999px;
  border:2px solid rgba(255,255,255,.3);background:linear-gradient(135deg,rgba(18,22,40,.95),rgba(9,12,24,.95));
  color:var(--fg);font-weight:900;letter-spacing:.1em;text-transform:uppercase;
  cursor:pointer;text-align:center;font-size:.8rem;
  box-shadow:0 6px 20px rgba(100,140,255,.4), 0 0 0 1px rgba(255,255,255,.1) inset;
  backdrop-filter:blur(8px);transition:all .2s ease;
}
.map-node:hover{transform:translate(-50%,-50%) scale(1.05);box-shadow:0 8px 24px rgba(100,140,255,.5), 0 0 0 1px rgba(255,255,255,.15) inset}
.map-diff{
  position:absolute;left:50%;top:-8px;transform:translate(-50%,-100%);
  font-size:.62rem;letter-spacing:.18em;text-transform:uppercase;
  color:rgba(230,236,255,.85);pointer-events:none;
  padding:2px 8px;border-radius:999px;
  background:rgba(8,12,22,.8);border:1px solid rgba(255,255,255,.12)
}
.map-node.locked{opacity:.5;filter:saturate(.6);cursor:not-allowed}
.map-node.locked.teaser{opacity:.8;filter:saturate(.9);border-style:dashed}
.map-node.locked .map-diff{opacity:.7}
.map-node.locked.teaser .map-diff{opacity:.85}
.map-node.locked.choice-locked{
  opacity:.92;
  filter:saturate(1.02);
  border-style:solid;
}
.map-node.choice-locked{
  border-color:rgba(255,112,112,.82);
  background:
    radial-gradient(120% 110% at 20% 12%, rgba(255,174,174,.3), rgba(255,174,174,0) 58%),
    linear-gradient(145deg,rgba(66,20,20,.95),rgba(22,10,10,.96));
  box-shadow:
    0 8px 22px rgba(255,105,105,.3),
    0 0 0 1px rgba(255,180,180,.2) inset,
    0 0 16px rgba(255,120,120,.2);
}
.map-node.choice-locked::before{
  content:'\00d7';
  position:absolute;
  right:9px;
  top:6px;
  width:16px;
  height:16px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.72rem;
  font-weight:900;
  color:rgba(255,230,230,.95);
  background:rgba(110,26,26,.8);
  border:1px solid rgba(255,188,188,.35);
  box-shadow:0 0 8px rgba(255,116,116,.45);
}
.map-node.choice-locked .map-diff{
  color:rgba(255,222,222,.95);
  border-color:rgba(255,142,142,.42);
  background:rgba(40,12,12,.86);
}
.map-node.complete{border-color:rgba(120,255,170,.55);box-shadow:0 0 14px rgba(120,255,170,.35)}
.map-node.resume{border-color:rgba(255,210,120,.6);box-shadow:0 0 14px rgba(255,210,120,.35)}
.map-node .dot{
  display:inline-block;width:10px;height:10px;border-radius:50%;
  margin-right:6px;vertical-align:middle;background:var(--accent);
  box-shadow:0 0 10px rgba(124,140,255,.8);
}
.map-node.complete .dot{background:#6ee7b7;box-shadow:0 0 12px rgba(110,231,183,.8)}
.map-node.resume .dot{background:#ffd166;box-shadow:0 0 12px rgba(255,209,102,.8)}
.map-node.locked .dot{background:#65708c;box-shadow:none}
.map-node.locked.teaser .dot{background:rgba(124,140,255,.7);box-shadow:0 0 10px rgba(124,140,255,.45)}
.map-node.choice-locked .dot{background:#ff9f9f;box-shadow:0 0 11px rgba(255,143,143,.72)}
.map-node.upgrade-node{
  min-width:112px;
  max-width:148px;
  padding:8px 10px;
  font-size:.74rem;
  border-color:rgba(255,169,77,.85);
  background:
    radial-gradient(130% 120% at 18% 10%, rgba(255,236,184,.32), rgba(255,236,184,0) 56%),
    linear-gradient(145deg,rgba(82,44,18,.96),rgba(26,15,10,.96));
  box-shadow:
    0 8px 24px rgba(255,170,90,.36),
    0 0 0 1px rgba(255,212,160,.25) inset,
    0 0 18px rgba(255,186,118,.22);
  border-radius:18px;
  letter-spacing:.12em;
  animation:upgradeNodePulse 2.8s ease-in-out infinite;
}
.map-node.upgrade-node::before{
  content:'';
  position:absolute;inset:-4px;
  border-radius:22px;
  border:1px solid rgba(255,210,145,.35);
  box-shadow:0 0 14px rgba(255,196,130,.28);
  pointer-events:none;
}
.map-node.upgrade-node::after{
  content:'';
  position:absolute;inset:-10px;
  border-radius:26px;
  border:1px dashed rgba(255,196,130,.38);
  opacity:.65;
  animation:upgradeOrbit 8s linear infinite;
  pointer-events:none;
}
.map-node.upgrade-node:hover{
  box-shadow:
    0 11px 32px rgba(255,170,90,.5),
    0 0 0 1px rgba(255,222,170,.28) inset,
    0 0 24px rgba(255,188,120,.28);
}
.map-node.upgrade-node .dot{
  background:#ffd091;
  box-shadow:0 0 14px rgba(255,198,132,.95);
}
.map-node.upgrade-node .map-diff{
  border-color:rgba(255,181,104,.45);
  color:rgba(255,219,178,.95);
  background:rgba(36,22,12,.86);
}
.map-node.elite-node{
  min-width:132px;
  max-width:176px;
  border-color:rgba(255,108,108,.88);
  background:
    radial-gradient(130% 110% at 20% 8%, rgba(255,200,170,.34), rgba(255,180,160,0) 56%),
    linear-gradient(145deg,rgba(74,20,22,.96),rgba(26,10,12,.96));
  box-shadow:
    0 10px 28px rgba(255,96,96,.36),
    0 0 0 1px rgba(255,180,170,.22) inset,
    0 0 20px rgba(255,110,110,.24);
}
.map-node.elite-node .dot{background:#ff8f8f;box-shadow:0 0 13px rgba(255,138,138,.9)}
.map-node.elite-node .map-diff{
  color:rgba(255,226,226,.95);
  border-color:rgba(255,144,144,.45);
  background:rgba(42,12,12,.86);
}
#campaignSvg .campaign-link-elite{
  stroke:rgba(255,118,118,.9);
  stroke-width:2.8;
  stroke-linecap:round;
  stroke-dasharray:5 6;
  filter:drop-shadow(0 0 5px rgba(255,120,120,.45));
}
.map-link-dot-elite{
  filter:drop-shadow(0 0 4px rgba(255,124,124,.7));
  animation:upgradeDotPulse 1.4s ease-in-out infinite;
}
@keyframes upgradeNodePulse{
  0%,100%{box-shadow:0 8px 24px rgba(255,170,90,.32), 0 0 0 1px rgba(255,212,160,.24) inset, 0 0 16px rgba(255,186,118,.2)}
  50%{box-shadow:0 10px 28px rgba(255,178,98,.48), 0 0 0 1px rgba(255,222,170,.3) inset, 0 0 24px rgba(255,196,130,.34)}
}
@keyframes upgradeOrbit{
  0%{transform:rotate(0deg);opacity:.5}
  50%{opacity:.8}
  100%{transform:rotate(360deg);opacity:.5}
}
#campaignSvg .campaign-link-pack{
  stroke:rgba(130,180,255,.85);
  stroke-width:2.2;
  stroke-linecap:round;
}
#campaignSvg .campaign-link-upgrade{
  stroke:rgba(255,176,102,.92);
  stroke-width:2.8;
  stroke-linecap:round;
  stroke-dasharray:9 7;
  filter:drop-shadow(0 0 5px rgba(255,190,130,.45));
  animation:upgradeLinkFlow 8s linear infinite;
}
#campaignSvg .campaign-link-choice-locked{
  stroke:rgba(255,120,120,.85);
  stroke-width:2.7;
  stroke-linecap:round;
  stroke-dasharray:8 8;
  filter:drop-shadow(0 0 5px rgba(255,120,120,.35));
}
@keyframes upgradeLinkFlow{
  to{stroke-dashoffset:-128}
}
.map-link-dot-upgrade{
  filter:drop-shadow(0 0 4px rgba(255,196,130,.65));
  animation:upgradeDotPulse 1.8s ease-in-out infinite;
}
.map-link-dot-choice-locked{
  filter:drop-shadow(0 0 4px rgba(255,128,128,.62));
}
@keyframes upgradeDotPulse{
  0%,100%{opacity:.55}
  50%{opacity:1}
}
.map-legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;color:var(--muted);font-size:.8rem}
.map-legend span{display:inline-flex;align-items:center;gap:6px}
.map-legend i{display:inline-block;width:8px;height:8px;border-radius:50%}
.map-legend .l1 i{background:var(--accent)}
.map-legend .l2 i{background:#ffd166}
.map-legend .l3 i{background:#6ee7b7}
.map-legend .l4 i{background:#65708c}
.map-legend .l5 i{background:#ffb86b}
.map-legend .l6 i{background:#ff8b8b}
.map-legend .l7 i{background:#ff8f8f}
.menu-btn{
  padding:16px 20px;border-radius:16px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02)) var(--key);
  color:var(--fg);font-weight:900;text-transform:uppercase;letter-spacing:.16em;cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.1) inset;
  transition:all .15s ease;
}
.menu-btn.primary{background:linear-gradient(135deg,var(--accent),rgba(0,0,0,.15)) var(--accent);color:#fff;
  border-color:rgba(255,255,255,.25);box-shadow:0 6px 18px rgba(124,140,255,.35), 0 1px 0 rgba(255,255,255,.2) inset}
.menu-btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.3), 0 1px 0 rgba(255,255,255,.12) inset}
.menu-btn:active{transform:translateY(0) scale(.98)}
.menu-note{font-size:.9rem;color:var(--muted);margin:12px 0 0}
body.mode-campaign header .controls{display:none}
body.mode-campaign #btnDiag{display:none}
body.mode-campaign #btnMenu{display:inline-flex}
body.mode-sandbox #btnMenu{display:inline-flex}
body.mode-sandbox h1{display:none}
body.mode-campaign .main{grid-template-columns:1fr}
body.mode-campaign{
  --bg:#0a0d1a;--bg2:#05070f;--panel:#0e1326;--key:#1f2233;
  --neutral:#262b3f;--neutral-brd:#363b54;
}
body.mode-atlas{
  --bg:#0a0d1a;--bg2:#05070f;--panel:#0e1326;--key:#1f2233;
  --neutral:#262b3f;--neutral-brd:#363b54;
}
body.mode-hotseat #btnSettings,
body.mode-hotseat #btnSearch,
body.mode-hotseat #btnRandom{display:none}
body.mode-hotseat #guessLeft,
body.mode-hotseat #countdownBar,
body.mode-hotseat #countdownLabel{display:none}

#hotseatBar{display:none}
body.mode-hotseat #hotseatBar{display:flex}
.hotseat-bar{
  display:flex;gap:10px;align-items:stretch;justify-content:space-between;
  margin:6px 4px 4px;padding:8px;border-radius:14px;
  background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);
  flex-wrap:wrap
}
.hs-team{
  flex:1;display:flex;flex-direction:column;gap:2px;
  padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04)
}
.hs-team.red{border-color:rgba(255,90,90,.5);box-shadow:0 0 16px rgba(255,80,80,.15) inset}
.hs-team.blue{border-color:rgba(90,160,255,.5);box-shadow:0 0 16px rgba(90,160,255,.15) inset}
.hs-name{font-weight:900;letter-spacing:.2em;font-size:.8rem}
.hs-meta{font-size:.8rem;color:var(--muted)}
.hs-mid{
  min-width:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--fg)
}
.hs-round{font-size:.7rem;opacity:.8}
.hs-turn{font-size:.8rem;margin-top:2px}
@media (max-width:520px){
  .hs-mid{width:100%;order:3}
}

.tile.owner-red{border-color:rgba(255,90,90,.8)!important;box-shadow:0 0 14px rgba(255,90,90,.35)}
.tile.owner-blue{border-color:rgba(90,160,255,.85)!important;box-shadow:0 0 14px rgba(90,160,255,.35)}
body.mode-hotseat.hs-turn-red .tile.owner-red{box-shadow:0 0 18px rgba(255,90,90,.55)}
body.mode-hotseat.hs-turn-blue .tile.owner-blue{box-shadow:0 0 18px rgba(90,160,255,.55)}
.tile.borrowed{border-style:dashed}
.tile.cursor{outline:2px solid rgba(255,255,255,.6);outline-offset:-2px}

.pass-overlay{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:80
}
.pass-overlay.open{display:flex}
.pass-card{
  min-width:240px;padding:20px 22px;border-radius:16px;text-align:center;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02)) var(--panel);
  border:1px solid rgba(255,255,255,.15);box-shadow:0 20px 60px rgba(0,0,0,.5)
}
.pass-title{font-size:.75rem;letter-spacing:.28em;text-transform:uppercase;color:var(--muted)}
.pass-player{font-size:1.4rem;font-weight:900;letter-spacing:.18em;margin:6px 0}
.pass-sub{font-size:.85rem;color:var(--muted)}
.win-burst{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  pointer-events:none;opacity:0;z-index:55;mix-blend-mode:screen;
  --burst-h:210;
  --burst-core:hsla(var(--burst-h),90%,85%,.95);
  --burst-mid:hsla(var(--burst-h),85%,68%,.45);
  --burst-edge:hsla(var(--burst-h),60%,40%,.25);
  --burst-ray:hsla(var(--burst-h),80%,70%,.35);
  --burst-ring:hsla(var(--burst-h),90%,80%,.8);
  --burst-ring2:hsla(var(--burst-h),80%,70%,.7);
  --burst-star:hsla(var(--burst-h),80%,92%,.85);
  --burst-star2:hsla(var(--burst-h),70%,80%,.75);
}
.win-burst::before{
  content:'';position:absolute;width:58vmin;height:58vmin;border-radius:50%;
  background:radial-gradient(circle, var(--burst-core) 0%, var(--burst-mid) 35%, var(--burst-edge) 58%, rgba(0,0,0,0) 72%);
  transform:scale(.25);opacity:0;filter:blur(.2px);
}
.win-burst::after{
  content:'';position:absolute;width:82vmin;height:82vmin;border-radius:50%;
  background:repeating-conic-gradient(from 0deg, var(--burst-ray) 0 12deg, rgba(0,0,0,0) 12deg 22deg);
  transform:scale(.3) rotate(0deg);opacity:0;filter:blur(.4px);
}
.win-burst .burst-ring{
  position:absolute;width:46vmin;height:46vmin;border-radius:50%;
  border:1px solid var(--burst-ring);opacity:0;
  box-shadow:0 0 24px hsla(var(--burst-h),80%,70%,.65), inset 0 0 18px hsla(var(--burst-h),55%,45%,.35);
}
.win-burst .burst-ring.ring-b{
  width:62vmin;height:62vmin;border-color:var(--burst-ring2);
  box-shadow:0 0 36px hsla(var(--burst-h),75%,65%,.55), inset 0 0 26px hsla(var(--burst-h),45%,40%,.3);
}
.win-burst .burst-stars{
  position:absolute;width:88vmin;height:88vmin;border-radius:50%;opacity:0;
  background:
    radial-gradient(2px 2px at 18% 24%, var(--burst-star), transparent 70%),
    radial-gradient(1.5px 1.5px at 76% 22%, var(--burst-star2), transparent 70%),
    radial-gradient(1.5px 1.5px at 64% 68%, var(--burst-star), transparent 70%),
    radial-gradient(2px 2px at 28% 72%, var(--burst-star2), transparent 70%),
    radial-gradient(1.5px 1.5px at 52% 44%, var(--burst-star), transparent 70%),
    radial-gradient(1.5px 1.5px at 42% 18%, var(--burst-star2), transparent 70%),
    radial-gradient(2px 2px at 84% 52%, var(--burst-star), transparent 70%),
    radial-gradient(1.5px 1.5px at 12% 58%, var(--burst-star2), transparent 70%);
  filter:blur(.2px);
}
.win-burst.play{animation:spaceFade 1.35s ease}
.win-burst.play::before{animation:spacePulse 1.2s ease}
.win-burst.play::after{animation:spaceRays 1.25s ease}
.win-burst.play .burst-ring.ring-a{animation:spaceRing 1.25s ease}
.win-burst.play .burst-ring.ring-b{animation:spaceRing 1.35s ease .05s}
.win-burst.play .burst-stars{animation:spaceStars 1.25s ease}
@keyframes spacePulse{0%{transform:scale(.25);opacity:0}35%{opacity:1;transform:scale(1.05)}100%{transform:scale(1.6);opacity:0}}
@keyframes spaceRays{0%{transform:scale(.3) rotate(0deg);opacity:0}30%{opacity:.9}100%{transform:scale(1.7) rotate(120deg);opacity:0}}
@keyframes spaceRing{0%{transform:scale(.2);opacity:0}18%{opacity:.95}100%{transform:scale(1.85);opacity:0}}
@keyframes spaceStars{0%{transform:scale(.7) rotate(-6deg);opacity:0}45%{opacity:.9}100%{transform:scale(1.2) rotate(10deg);opacity:0}}
@keyframes spaceFade{0%{opacity:0}20%{opacity:1}100%{opacity:0}}
header{width:100%;max-width:1200px;display:flex;align-items:center;justify-content:space-between;padding:4px 8px;position:relative}
h1{font-size:1.05rem;letter-spacing:.12em;font-weight:800;margin:0}
.campaign-progress{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  font-size:.85rem;letter-spacing:.2em;text-transform:uppercase;font-weight:800;
  color:rgba(230,236,255,.85);pointer-events:none;display:none
}
body.mode-campaign .campaign-progress{display:block}
.controls{display:flex;gap:8px;align-items:center}
button.icon{background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02)) transparent;border:1.5px solid rgba(255,255,255,.18);color:var(--fg);
  border-radius:14px;padding:10px;font-size:18px;line-height:0;cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.08);transition:all .15s ease}
button.icon:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);box-shadow:0 4px 12px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.12)}
button.icon:active{transform:scale(.96)}
.tight-board header{height:0;padding:0;margin:0}
.tight-board header h1{display:none}
.tight-board .controls{display:none}
.tight-board #btnDiag{display:none}
.tight-board #btnMenu{
  position:fixed;top:12px;left:12px;z-index:70
}

.main{width:min(100dvw,1200px);height:calc(var(--vh) - var(--headerH) - 12px);display:grid;
  grid-template-columns:1.05fr .95fr;gap:12px;align-items:stretch}
@media (orientation:portrait){
  .main{grid-template-columns:1fr;grid-template-rows:1fr auto}
  header{flex-wrap:wrap;row-gap:6px}
  .controls{flex-wrap:wrap;justify-content:flex-end}
  .controls{margin-left:auto;align-self:flex-end}
  h1{display:none}
  button.icon{padding:7px;font-size:16px}
}
.section{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);
  border-radius:18px;padding:10px;display:flex;min-height:0;
  box-shadow:0 8px 24px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.02) inset}
.board-wrap{position:relative;flex:1;display:flex;flex-direction:column;overflow:visible}
#overlayTitle{
  position:absolute;top:12px;left:56px;right:12px;transform:none;
  font-size:.9rem;letter-spacing:.22em;font-weight:800;opacity:.7;display:none;
  text-transform:uppercase;pointer-events:none;text-align:left
}
.tight-board #overlayTitle{display:block}
.board-scroll{flex:1;display:flex;justify-content:center;align-items:flex-start;overflow:hidden;padding-bottom:26px}
.board-scroll.centered{align-items:center;padding-top:24px}
.board-scroll.scroll{overflow-y:auto;overflow-x:hidden}
#guessLeft{
  position:absolute;left:50%;bottom:6px;transform:translate(-50%, 0);pointer-events:none;
  font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.35);
  text-shadow:0 1px 8px rgba(0,0,0,.5);transition:opacity .2s;z-index:6;
  background:rgba(0,0,0,.35);padding:4px 10px;border-radius:999px;
  will-change:transform,opacity;white-space:normal;max-width:calc(100% - 16px);text-align:center;
}
#countdownBar{
  position:absolute;left:50%;top:6px;transform:translateX(-50%);
  width:min(280px, 80%);height:8px;border-radius:999px;
  background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);
  overflow:hidden;z-index:7;opacity:0;transition:opacity .2s;
}
#countdownBar.active{opacity:1}
#countdownBar .bar-fill{
  height:100%;background:linear-gradient(90deg, var(--accent), var(--correct));
  border-radius:999px;transition:width .1s linear;
  box-shadow:0 0 8px rgba(124,140,255,.5);
}
#countdownBar.danger .bar-fill{
  background:linear-gradient(90deg, #ff5c5c, #ff8c42);
  box-shadow:0 0 12px rgba(255,92,92,.6);
}
#countdownLabel{
  position:absolute;left:50%;top:18px;transform:translateX(-50%);
  font-size:11px;letter-spacing:.14em;text-transform:uppercase;
  color:rgba(255,255,255,.6);z-index:7;opacity:0;transition:opacity .2s;
}
#countdownLabel.active{opacity:1}
.board-scroll.centered + #guessLeft{
  top:8px;bottom:auto;transform:translate(-50%,0);
}
#wrap.countdown-on .board-scroll.centered + #guessLeft{
  top:34px;
}
body.wildcard-on #guessLeft{pointer-events:auto;cursor:pointer}
#guessLeft.bump{animation:guessBump .45s ease}
@keyframes guessBump{
  0%{transform:translate(-50%, 0);opacity:.35}
  35%{transform:translate(-50%, -4px);opacity:.75}
  100%{transform:translate(-50%, 0);opacity:.35}
}
.board-wrap.danger .tile{
  animation:tileJitter .2s ease-in-out infinite;
}
.board-wrap.danger .tile .tile-letter{
  animation:tileJitterCounter .2s ease-in-out infinite;
}
@keyframes tileJitter{
  0%{transform:rotate(0)}
  35%{transform:rotate(var(--tilt, 0deg))}
  70%{transform:rotate(calc(var(--tilt, 0deg) * -1))}
  100%{transform:rotate(0)}
}
@keyframes tileJitterCounter{
  0%{transform:rotate(0)}
  35%{transform:rotate(calc(var(--tilt, 0deg) * -1))}
  70%{transform:rotate(var(--tilt, 0deg))}
  100%{transform:rotate(0)}
}
#board{
  position:relative;
  display:grid;gap:8px;
}
.board-wrap.danger .board-scroll{
  background:linear-gradient(180deg,rgba(170,30,30,.5),rgba(60,0,0,.2));
  border-radius:16px;
}
body.campaign-boss #wrap{
  border:1px solid rgba(255,126,126,.45);
  box-shadow:0 0 0 1px rgba(255,184,184,.2) inset, 0 0 26px rgba(255,88,88,.24);
  overflow:hidden;
}
body.campaign-boss #wrap::before{
  content:'';
  position:absolute;
  inset:-22%;
  border-radius:50%;
  background:conic-gradient(from 0deg, rgba(255,98,98,.22), rgba(255,196,108,.18), rgba(126,160,255,.14), rgba(255,98,98,.22));
  filter:blur(18px);
  opacity:.72;
  pointer-events:none;
  z-index:0;
  animation:bossAuraSpin 11s linear infinite;
}
body.campaign-boss #wrap::after{
  content:'';
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:0;
  background:linear-gradient(180deg, rgba(255,82,82,.12), rgba(255,82,82,0));
  animation:bossAuraPulse 2.4s ease-in-out infinite;
}
body.campaign-boss #board,
body.campaign-boss .keyboard,
body.campaign-boss #countdownBar,
body.campaign-boss #countdownLabel,
body.campaign-boss #guessLeft,
body.campaign-boss #hotseatBar{
  position:relative;
  z-index:1;
}
body.campaign-boss #board .tile:not(.hidden):not(.skipped){
  animation:bossTilePulse 2.2s ease-in-out infinite;
}
body.campaign-boss #countdownBar .bar-fill{
  background:linear-gradient(90deg, #ff5f5f, #ff9c3f, #ffd166);
  box-shadow:0 0 14px rgba(255,108,108,.62);
  animation:bossBarFlow 1.4s linear infinite;
}
body.campaign-boss #overlayTitle::after{
  content:'BOSS SIGNAL';
  margin-left:10px;
  font-size:.7rem;
  letter-spacing:.24em;
  color:rgba(255,186,186,.88);
  text-shadow:0 0 9px rgba(255,96,96,.7);
  animation:bossLabelBlink 1.1s steps(2,end) infinite;
}
@keyframes bossAuraSpin{
  0%{transform:rotate(0deg) scale(1)}
  100%{transform:rotate(360deg) scale(1.04)}
}
@keyframes bossAuraPulse{
  0%,100%{opacity:.26}
  50%{opacity:.62}
}
@keyframes bossTilePulse{
  0%,100%{filter:brightness(1)}
  50%{filter:brightness(1.14)}
}
@keyframes bossBarFlow{
  0%{filter:hue-rotate(0deg)}
  100%{filter:hue-rotate(20deg)}
}
@keyframes bossLabelBlink{
  0%,45%{opacity:.25}
  46%,100%{opacity:1}
}
.tile{
  width:var(--tile);height:var(--tile);display:flex;align-items:center;justify-content:center;
  border:2px solid var(--neutral-brd); border-radius:clamp(6px, calc(var(--tile)*0.16), 16px);
  font-weight:900;text-transform:uppercase;letter-spacing:.02em;
  font-size:calc(var(--tile)*0.57);
  line-height:1;
  color:#fff;background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02)) var(--neutral);
  position:relative;z-index:1;box-shadow:inset 0 1px 0 rgba(255,255,255,.12), 0 6px 18px rgba(0,0,0,.35);
  transition:opacity .2s ease, transform .2s ease;
  user-select:none;-webkit-user-select:none;-ms-user-select:none;
  -webkit-touch-callout:none;
}
.tile *{user-select:none;-webkit-user-select:none;-ms-user-select:none}
.tile-letter{position:relative;display:block;transform:rotate(0);z-index:2}
.tile-note{
  position:absolute;
  left:6px;
  bottom:4px;
  font-size:11px;
  font-weight:900;
  line-height:1;
  color:#ffe07a;
  text-shadow:0 1px 4px rgba(0,0,0,.65);
  z-index:3;
  opacity:0;
  pointer-events:none;
}
.tile.budget-focus{
  box-shadow:0 0 0 2px rgba(255,214,92,.34), 0 0 20px rgba(255,214,92,.42), inset 0 1px 0 rgba(255,255,255,.14);
  border-color:#f6cb50;
}
.tile.budget-focus .tile-note{opacity:1}
.tile.min-distance-fit{
  box-shadow:0 0 0 2px rgba(110,230,183,.24), 0 0 14px rgba(110,230,183,.3), inset 0 1px 0 rgba(255,255,255,.12);
}
.tile.min-distance-ready{
  border-color:#62d8a7;
  box-shadow:0 0 0 2px rgba(110,230,183,.36), 0 0 20px rgba(110,230,183,.46), inset 0 1px 0 rgba(255,255,255,.14);
}
.tile.copycat-linked{
  border-color:#7dafff;
  box-shadow:0 0 0 2px rgba(125,175,255,.28), 0 0 16px rgba(125,175,255,.35), inset 0 1px 0 rgba(255,255,255,.14);
}
.tile.copycat-ready{
  border-color:#9ef3be;
  box-shadow:0 0 0 2px rgba(120,238,170,.34), 0 0 20px rgba(120,238,170,.42), inset 0 1px 0 rgba(255,255,255,.16);
}
.tile.grayed{opacity:.55}
.tile.hidden{opacity:0;transform:scale(.7) rotateX(60deg);pointer-events:none}
.tile.skipped{opacity:0;transform:scale(.7) rotateX(60deg);pointer-events:none}
.tile.appear{animation:tileIn .7s ease both}
@keyframes tileIn{
  0%{opacity:0;transform:scale(.7) rotateX(60deg)}
  100%{opacity:1;transform:scale(1) rotateX(0)}
}
.tile.mirror-pop{animation:mirrorPop .45s ease}
@keyframes mirrorPop{
  0%{transform:scale(.9);filter:brightness(1.1)}
  100%{transform:scale(1)}
}
.campaign-intro .tile:not(.hidden){
  animation:campaignTileIn .95s cubic-bezier(.22,.85,.18,1) var(--intro-delay,0s) both;
  will-change:transform,opacity,filter;
}
@keyframes campaignTileIn{
  0%{opacity:0;transform:translateY(18px) scale(.9) rotateX(22deg);filter:brightness(1.35)}
  55%{opacity:1;transform:translateY(-4px) scale(1.03);filter:brightness(1.15)}
  100%{opacity:1;transform:translateY(0) scale(1);filter:brightness(1)}
}
body.campaign-intro #kbd .key{
  animation:campaignKeyIn .75s cubic-bezier(.2,.8,.2,1) var(--kbd-delay,0s) both;
  opacity:0;will-change:transform,opacity;
}
@keyframes campaignKeyIn{
  0%{opacity:0;transform:translateY(16px) scale(.92)}
  60%{opacity:1;transform:translateY(-2px) scale(1.02)}
  100%{opacity:1;transform:translateY(0) scale(1)}
}
.tile.mirror-base{
  background:transparent;border-color:transparent;box-shadow:none;
}
.tile.fogged{
  color:transparent;
  background:linear-gradient(180deg,rgba(44,44,50,.95),rgba(18,18,22,.92));
  border-color:#2a2a30;
  box-shadow:inset 0 0 12px rgba(0,0,0,.45), 0 6px 18px rgba(0,0,0,.25);
  animation:fogPulse 1.2s ease-in-out infinite;
}
.tile.fogged .tile-letter{animation:none}
.tile.fogged.noisy{animation:fogPulse 1.2s ease-in-out infinite}
.tile.fogged::after{content:''}
@keyframes fogPulse{
  0%{filter:brightness(.9)}
  50%{filter:brightness(1.15)}
  100%{filter:brightness(.9)}
}
.hint-overlay{
  position:absolute;inset:0;pointer-events:none;z-index:0;
}
.hint-overlay .tile .tile-letter{display:none}
.hint-overlay .tile{
  position:absolute;margin:0;transform:translate(0,0);
  transition:transform .65s cubic-bezier(.2,.7,.25,1);
}
.tile.correct{background:linear-gradient(135deg,rgba(255,255,255,.2),rgba(255,255,255,.06)) var(--correct);border-color:#5b8e55;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.18), 0 6px 20px rgba(106,170,100,.25), 0 0 0 1px rgba(106,170,100,.3)}
.tile.near{background:linear-gradient(135deg,rgba(255,255,255,.16),rgba(255,255,255,.04)) var(--near);border-color:#a89643;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.14), 0 6px 20px rgba(201,180,88,.2)}
.tile.decoy-red{
  border-color:#ff4a4a;
  box-shadow:0 0 0 2px rgba(255,72,72,.6), 0 0 18px rgba(255,72,72,.35);
}
.tile.double-shadow{
  box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 8px 22px rgba(0,0,0,.32), 6px 6px 0 rgba(0,0,0,.55);
  animation:doubleWiggle .6s ease-in-out infinite;
}
@keyframes doubleWiggle{
  0%{transform:translate(0,0)}
  25%{transform:translate(1px,-1px)}
  50%{transform:translate(-1px,1px)}
  75%{transform:translate(1px,1px)}
  100%{transform:translate(0,0)}
}
.tile.wildcard{
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.04)) #2c4b6b;
  border-color:#5aa0ff;
  box-shadow:0 0 0 2px rgba(90,160,255,.25), 0 0 20px rgba(90,160,255,.35);
}
.tile.wildcard::before{
  content:'*';position:absolute;left:6px;top:4px;font-size:12px;
  color:#cfe6ff;text-shadow:0 2px 8px rgba(0,0,0,.5);
}
.tile.locked{
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.04)) #f7d24c;
  border-color:#f5c233;
  box-shadow:0 0 0 2px rgba(247,210,76,.25), 0 0 18px rgba(247,210,76,.35);
  animation:lockPulse .9s ease-in-out infinite;
}
.tile.potato-lock{
  border-color:#ff8a8a;
  box-shadow:0 0 0 2px rgba(255,138,138,.28), 0 0 14px rgba(255,90,90,.32);
}
.tile.noisy{
  animation:noisyPulse .2s linear infinite;
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04)) #2f3646;
  border-color:#394259;
  color:rgba(255,255,255,.6);
}
.tile.noisy .tile-letter{
  animation:noisyLetter .16s ease-in-out infinite;
}
@keyframes noisyPulse{
  0%{filter:brightness(.95)}
  50%{filter:brightness(1.25)}
  100%{filter:brightness(.95)}
}
@keyframes noisyLetter{
  0%{opacity:1;transform:scale(.97);color:#bfc6d6}
  50%{opacity:1;transform:scale(1.02);color:#fff}
  100%{opacity:1;transform:scale(.98);color:#c7cedd}
}
.tile.noisy.dir::after{
  animation:noisyArrowSpin var(--arrow-speed, .4s) linear infinite;
  transform:rotate(var(--arrow-tilt, 0deg));
  color:#fff;
  text-shadow:0 2px 10px rgba(0,0,0,.6);
}
@keyframes noisyArrowSpin{
  0%{transform:rotate(var(--arrow-tilt, 0deg))}
  50%{transform:rotate(calc(var(--arrow-tilt, 0deg) + 180deg))}
  100%{transform:rotate(calc(var(--arrow-tilt, 0deg) + 360deg))}
}
@keyframes lockPulse{
  0%{filter:brightness(1)}
  50%{filter:brightness(1.2)}
  100%{filter:brightness(1)}
}
.tile.dir::after{
  content:attr(data-dir);position:absolute;right:6px;bottom:4px;font-size:12px;
  color:#000;opacity:.95;text-shadow:0 1px 0 rgba(255,255,255,.4);
}
.tile.grayed.dir::after{
  color:#fff;opacity:.9;text-shadow:0 2px 6px rgba(0,0,0,.5)
}
.tile, .tile::after { backface-visibility:hidden; transform-style:preserve-3d }
@keyframes flip{0%{transform:rotateX(0)}49%{transform:rotateX(90deg)}51%{transform:rotateX(90deg)}100%{transform:rotateX(0)}}
.reveal{animation:flip .6s var(--delay) both}
.reveal.double-shadow{animation:flip .6s var(--delay) both, doubleWiggle .6s ease-in-out infinite}
.shake{animation:shake .4s both}
@keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(3px)}30%,50%,70%{transform:translateX(-5px)}40%,60%{transform:translateX(5px)}}
.pane{position:relative;flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column}
.pane .keyboard{width:100%;margin-top:auto}

.swipe-trace{
  position:absolute;left:0;top:0;pointer-events:none;opacity:0;transition:opacity .2s ease;
  z-index:3;
}
.keyboard{position:relative;z-index:1}
.swipe-trace.active{opacity:.55}
.swipe-trace.active{opacity:1}
.swipe-bar{
  width:100%;
  display:flex;gap:8px;justify-content:center;align-items:center;
  padding:6px 6px 2px;transition:opacity .2s ease, transform .2s ease;
}
.swipe-bar.hidden{opacity:0;pointer-events:none;transform:translateY(6px)}
.swipe-suggest{
  flex:1 1 0;max-width:140px;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);color:var(--fg);font-weight:800;letter-spacing:.08em;text-transform:uppercase;cursor:pointer
}
.swipe-suggest:active{transform:translateY(1px) scale(.98)}
.keyboard{display:flex;flex-direction:column;gap:8px;padding:6px;touch-action:none}
.krow{display:flex;gap:6px;justify-content:center}
.key{user-select:none;-webkit-tap-highlight-color:transparent;flex:1 1 0;min-width:0;padding:14px 8px;
  border-radius:14px;text-transform:uppercase;text-align:center;background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02)) var(--key);color:var(--fg);
  font-weight:900;border:1.5px solid rgba(255,255,255,.12);font-size:clamp(12px,1.6vw,18px);cursor:pointer;position:relative;
  box-shadow:0 3px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);transition:all .1s ease}
.key.wide{flex:1.4 1 0}
.key:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.12)}
.key:active,.key.active-sim{transform:translateY(1px) scale(.98);filter:saturate(1.1);box-shadow:0 2px 4px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.08)}
.key.correct{background:linear-gradient(135deg,rgba(255,255,255,.2),rgba(255,255,255,.06)) var(--correct);border-color:var(--correct);color:#fff;
  box-shadow:0 4px 12px rgba(106,170,100,.4), inset 0 1px 0 rgba(255,255,255,.2)}
.key.near{background:linear-gradient(135deg,rgba(255,255,255,.16),rgba(255,255,255,.04)) var(--near);border-color:var(--near);color:#fff;
  box-shadow:0 4px 12px rgba(201,180,88,.35), inset 0 1px 0 rgba(255,255,255,.16)}
.kbd-hints-on .key[data-key].nocand{opacity:.33;filter:saturate(.7)}
.kbd-hints-on .key[data-key].cand{outline:2px solid var(--accent);box-shadow:0 0 0 2px rgba(0,0,0,.35), 0 6px 18px rgba(0,0,0,.35)}
.key.flash{outline:2px solid var(--accent);box-shadow:0 0 0 2px rgba(0,0,0,.35), 0 6px 18px rgba(0,0,0,.35)}
.kbd-preview-on .key[data-key].pcand{
  border-color:#6aaa64;outline:2px solid rgba(106,170,100,.85);
  box-shadow:0 0 0 2px rgba(0,0,0,.25), 0 6px 16px rgba(0,0,0,.3)
}
.kbd-preview-on .key[data-key].pnocand{
  border-color:#ff5c5c;outline:2px solid rgba(255,92,92,.85);
  box-shadow:0 0 0 2px rgba(0,0,0,.25), 0 6px 16px rgba(0,0,0,.3)
}
@media (orientation:portrait){
  .key{font-size:clamp(14px,3.6vw,22px);padding:14px 8px}
  .krow{gap:8px}
}
@media (orientation:landscape) and (max-height:520px){
  :root{--headerH:44px}
  #menuScreen,#campaignMenuScreen{align-items:flex-start;padding:10px 12px;overflow-y:auto}
  .menu-card{max-height:calc(var(--vh) - 20px);overflow:auto}
  .menu-scroll{max-height:36svh}
  header{padding:2px 6px}
  h1{font-size:.95rem}
  .main{
    grid-template-columns:1fr;
    grid-template-rows:1fr auto;
    height:calc(var(--vh) - var(--headerH) - 8px);
  }
  .section{padding:6px}
  .board-scroll{padding-bottom:18px}
  .swipe-bar{gap:6px;padding:4px 4px 0}
  .swipe-suggest{padding:6px 8px;font-size:.8rem}
  .keyboard{gap:6px;padding:4px}
  .krow{gap:4px}
  .key{padding:8px 4px;font-size:clamp(11px,2.4vw,16px);border-radius:10px}
}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + env(safe-area-inset-bottom));
  background:linear-gradient(135deg,rgba(18,22,40,.95),rgba(10,14,30,.95));border:1px solid rgba(255,255,255,.2);padding:12px 18px;z-index:60;border-radius:14px;
  box-shadow:0 12px 48px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08) inset;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;
  backdrop-filter:blur(12px);font-weight:600;letter-spacing:.04em}
.toast.show{opacity:1;transform:translate(-50%,-8px)}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
.modal.open{display:flex}
.card{width:min(96svw,880px);max-height:min(92svh,700px);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01)) var(--panel);color:var(--fg);
  border-radius:20px;padding:24px;border:1px solid rgba(255,255,255,.18);box-shadow:0 16px 70px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04) inset;overflow:auto;
  backdrop-filter:blur(10px)}
.card h2{margin:10px 0 16px;font-size:1.2rem;font-weight:900;letter-spacing:.05em}
.intro-desc{color:var(--muted);margin:6px 0 12px;line-height:1.4}
.intro-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.intro-head h2{margin:8px 0}
.intro-head #introClear{margin-left:auto}
.intro-meta{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:8px;margin:4px 0 12px
}
.intro-item{
  background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);
  border-radius:12px;padding:8px 10px;font-size:.82rem
}
.intro-item span{
  display:block;color:var(--muted);font-size:.66rem;letter-spacing:.14em;
  text-transform:uppercase;margin-bottom:4px
}
.intro-val{font-weight:700;letter-spacing:.04em}
.intro-tags{display:flex;flex-wrap:wrap;gap:6px}
.intro-tag{
  font-size:.68rem;padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.04);
  letter-spacing:.08em;text-transform:uppercase;cursor:pointer;font:inherit
}
.row{display:grid;grid-template-columns:minmax(160px,220px) 1fr;gap:10px;align-items:center;margin:8px 0}
.row label{color:var(--muted);cursor:pointer}
input[type=text],input[type=number],input[type=url],select{width:100%;font-size:1rem;padding:12px;background:var(--bg2);
  color:var(--fg);border:1px solid rgba(255,255,255,.18);border-radius:12px;letter-spacing:.08em}
.switch{
  position:relative;width:62px;height:34px;background:var(--bg2);border:1px solid rgba(255,255,255,.18);
  border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;justify-content:flex-start;
  transition:background .2s ease,border-color .2s ease;box-shadow:inset 0 2px 6px rgba(0,0,0,.25)
}
.switch input{display:none}
.knob{
  position:absolute;top:3px;left:3px;width:28px;height:28px;background:#fff;border-radius:999px;
  transition:left .2s,background .2s;box-shadow:0 2px 8px rgba(0,0,0,.35)
}
.switch.on{background:var(--accent);border-color:rgba(255,255,255,.35)}
.switch.on .knob{left:31px;background:var(--bg2)}
.seg-radio{display:flex;gap:8px;flex-wrap:wrap}
.seg-opt{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);cursor:pointer;font-size:.92rem
}
.seg-opt input{accent-color:var(--accent)}
.seg-note{color:var(--muted);font-size:.92rem}
.mut-help{
  display:inline-flex;align-items:center;justify-content:center;margin-left:6px;
  width:18px;height:18px;border-radius:50%;
  border:1px solid rgba(255,255,255,.25);color:var(--muted);
  font-size:12px;line-height:1;cursor:help;vertical-align:middle;
}
@media (pointer:coarse){
  .mut-help{width:24px;height:24px;font-size:14px}
}
.mut-section{
  margin-top:12px;border-top:1px solid rgba(255,255,255,.08);padding-top:8px;
}
.mut-section summary{
  list-style:none;cursor:pointer;font-weight:800;letter-spacing:.12em;text-transform:uppercase;
  color:var(--muted);padding:6px 0;
}
.mut-section summary::-webkit-details-marker{display:none}
.mut-section summary::after{
  content:'â–¾';float:right;color:var(--muted);transition:transform .2s;
}
.mut-section[open] summary::after{transform:rotate(180deg)}
.difficulty-info{margin:8px 0 0}
.info-box{
  background:rgba(124,140,255,.08);border:1px solid rgba(124,140,255,.25);
  border-radius:12px;padding:10px 14px;font-size:.88rem;line-height:1.5;
  color:var(--fg)
}
.mutator-search-wrap input{
  width:100%;font-size:.95rem;padding:10px 12px;
  background:var(--bg2);color:var(--fg);
  border:1px solid rgba(255,255,255,.2);border-radius:10px
}
.mutator-list{
  max-height:320px;overflow-y:auto;
  background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.1);
  border-radius:12px;padding:8px
}
.mutator-list::-webkit-scrollbar{width:8px}
.mutator-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:999px}
.mutator-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;margin-bottom:6px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);
  border-radius:10px;transition:all .15s ease
}
.mutator-item:hover{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.12)}
.mutator-item.mutator-config{
  background:rgba(124,140,255,.06);border-color:rgba(124,140,255,.15)
}
.mutator-label{display:flex;flex-direction:column;gap:2px;flex:1;cursor:pointer}
.mutator-name{font-weight:700;font-size:.9rem;letter-spacing:.02em}
.mutator-desc{font-size:.78rem;color:var(--muted);line-height:1.3}
.mutator-item.hidden{display:none}
.mutator-config-inline{
  display:flex;align-items:center;gap:8px;margin-top:6px;
}
.mutator-config-inline label{
  font-size:.75rem;color:var(--muted);letter-spacing:.06em;margin:0;
}
.mutator-config-inline input{
  width:70px;padding:6px 8px;font-size:.85rem;
  background:var(--bg2);color:var(--fg);
  border:1px solid rgba(255,255,255,.18);border-radius:8px;
}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
button.primary{background:linear-gradient(135deg,var(--accent),rgba(0,0,0,.15)) var(--accent);border:0;color:#fff;padding:12px 18px;border-radius:14px;font-weight:900;cursor:pointer;
  box-shadow:0 4px 14px rgba(124,140,255,.35), inset 0 1px 0 rgba(255,255,255,.2);transition:all .15s ease}
button.primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(124,140,255,.45), inset 0 1px 0 rgba(255,255,255,.25)}
button.secondary{background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.22);color:var(--fg);padding:12px 18px;border-radius:14px;font-weight:800;cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,.25);transition:all .15s ease}
button.secondary:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.3);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
button.danger{background:rgba(120,20,20,.2);border:1px solid rgba(255,120,120,.55);color:#ffb9b9}
button.primary.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.1)}

#confetti{position:fixed;inset:0;pointer-events:none;z-index:55}
.titlewrap{display:flex;align-items:center;gap:8px}
#diag{position:fixed;inset:0;display:none;z-index:90;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
#diag.open{display:flex;align-items:center;justify-content:center}
#diag .panel{width:min(96svw,940px);height:min(90svh,620px);background:#0b0e1a;color:#e6ebff;border-radius:14px;border:1px solid #2a3555;
  display:flex;flex-direction:column;box-shadow:0 14px 60px rgba(0,0,0,.6)}
#diag header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #223;gap:8px}
#diag header h3{margin:0;font-size:16px;letter-spacing:.06em}
#diag .log{flex:1;overflow:auto;font-family:ui-monospace,Consolas,monospace;background:#0a0d18;padding:10px 12px;line-height:1.25}
#diag .log .e{color:#ffb4b4} .w{color:#ffdca8} .i{color:#c9d7ff}
#diag .log .prev{color:#7e89a6}
#diag footer{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid #223}
#diag button{background:#16203a;color:#dce4ff;border:1px solid #2a3555;border-radius:10px;padding:8px 12px;cursor:pointer}
#diag button.primary{background:#3a4aff;border-color:#3a4aff;color:#fff}

/* Word list modal polish */
#words .card{
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)) var(--panel);
  border-color:rgba(255,255,255,.18);
}
#words .row{margin:6px 0 10px}
#words #wcount{opacity:.7;letter-spacing:.08em}
#wlist{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;
  padding:8px;background:rgba(0,0,0,.18);border-radius:12px;border:1px solid rgba(255,255,255,.08)
}
.word-item{
  font-family:ui-monospace,Consolas,monospace;text-transform:uppercase;letter-spacing:.06em;
  background:var(--key);border:1px solid rgba(255,255,255,.12);color:var(--fg);
  border-radius:10px;padding:8px 10px;text-align:center;cursor:pointer;
  transition:transform .08s, box-shadow .18s, border-color .18s;
}
.word-item:hover{border-color:var(--accent);box-shadow:0 6px 16px rgba(0,0,0,.35)}
.word-item:active{transform:translateY(1px) scale(.98)}
#campaignShop .card{
  width:min(96svw,980px);
}
#wordReviewModal .card{
  width:min(96svw,840px);
}
.word-review-list{
  margin:10px 0 8px;
  display:grid;
  gap:8px;
}
.word-review-row{
  display:grid;
  grid-template-columns:minmax(0,1fr) auto;
  gap:8px;
  align-items:center;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.2);
}
.word-review-row .word-main{
  min-width:0;
}
.word-review-word{
  font-family:ui-monospace,Consolas,monospace;
  font-size:clamp(1rem,4.2vw,1.35rem);
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.word-review-meta{
  color:var(--muted);
  font-size:.76rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin-top:2px;
}
.word-review-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.word-review-actions button{
  min-width:74px;
  padding:8px 10px;
  border-radius:10px;
}
.word-review-actions .wr-skip{
  min-width:40px;
  padding:8px 0;
}
.word-review-empty{
  margin:10px 0 8px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.2);
  color:var(--muted);
}
.word-review-stats{
  margin-top:6px;
  color:var(--muted);
  font-size:.84rem;
  line-height:1.45;
}
.word-review-stats .wr-summary{
  display:block;
  margin-bottom:6px;
}
.word-review-stats .wr-lines{
  display:grid;
  gap:2px;
}
.word-review-stats .wr-line{
  display:flex;
  justify-content:space-between;
  gap:12px;
  font-family:ui-monospace,Consolas,monospace;
}
.word-review-stats .wr-line .left{
  color:var(--fg);
}.shop-head{
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-bottom:8px;
}
.shop-columns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.shop-col{
  min-width:0;
  background:rgba(0,0,0,.14);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;
  padding:10px;
}
.shop-col h3,
.shop-free h3{
  margin:0;
  font-size:.84rem;
  letter-spacing:.16em;
  text-transform:uppercase;
  color:var(--muted);
}
.shop-note{
  margin:6px 0 10px;
  color:var(--muted);
  font-size:.8rem;
}
.shop-list{
  display:grid;
  gap:8px;
}
.shop-item{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  padding:10px;
  display:grid;
  gap:8px;
}
.shop-item-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.shop-item h4{
  margin:0;
  font-size:.88rem;
  letter-spacing:.03em;
}
.shop-item p{
  margin:0;
  color:var(--muted);
  font-size:.78rem;
  line-height:1.3;
}
.shop-price{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:72px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(0,0,0,.22);
  font-size:.74rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  font-weight:900;
}
.shop-price.expensive{
  color:#ffd59a;
  border-color:rgba(255,202,138,.52);
  background:rgba(84,44,16,.34);
}
.shop-updown{
  display:grid;
  grid-template-columns:1fr;
  gap:4px;
  font-size:.75rem;
}
.shop-up{color:#9ef0c3}
.shop-down{color:#ffb0b0}
.shop-actions{
  display:flex;
  justify-content:flex-end;
}
.shop-item.sold{
  opacity:.58;
  filter:saturate(.7);
}
.shop-item.sold .shop-actions button{
  pointer-events:none;
}
.shop-item.free-picked{
  border-color:rgba(130,242,178,.66);
  box-shadow:0 0 0 1px rgba(110,232,165,.28) inset, 0 0 16px rgba(110,232,165,.2);
}
.shop-free{
  margin-top:12px;
  background:rgba(0,0,0,.14);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;
  padding:10px;
}
.shop-free-list{
  grid-template-columns:1fr 1fr;
}
#shopContinue.disabled{
  opacity:.45;
  pointer-events:none;
}
@media (max-width:760px){
  .shop-columns{grid-template-columns:1fr}
  .shop-free-list{grid-template-columns:1fr}
}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div id="menuScreen" class="screen active">
  <div class="menu-card">
    <div class="menu-title">WORDSHIFT</div>
    <p class="menu-sub">Pick a mode.</p>
    <div class="menu-actions">
      <button class="menu-btn primary" id="btnCampaignOpen">Campaign</button>
      <button class="menu-btn" id="btnSandbox">Sandbox</button>
      <button class="menu-btn" id="btnHotseat">Hot Seat</button>
      <button class="menu-btn" id="btnWordReview">Campaign Words</button>
      <button class="menu-btn" id="btnOptions">Options</button>
      <button class="menu-btn" id="btnMenuFS">Fullscreen</button>
    </div>
    <div class="menu-note">Sandbox is the current free-play version.</div>
  </div>
</div>

<div id="campaignMenuScreen" class="screen">
  <div class="map-wrap">
    <div class="map-header">
      <div>
        <div class="map-title">Campaign Atlas</div>
        <p class="map-sub">Follow the neon trail to unlock packs.</p>
      </div>
      <span class="menu-coin" id="coinDisplay">Coins: 0</span>
    </div>
    <div id="campaignMap">
      <div id="campaignPan">
        <svg id="campaignSvg"></svg>
        <div id="campaignNodes"></div>
      </div>
    </div>
    <div class="map-legend">
      <span class="l1"><i></i>Available</span>
      <span class="l2"><i></i>Resume</span>
      <span class="l3"><i></i>Complete</span>
      <span class="l4"><i></i>Locked</span>
      <span class="l5"><i></i>Upgrade Node</span>
      <span class="l6"><i></i>Choice Locked</span>
      <span class="l7"><i></i>Elite Node</span>
    </div>
    <div class="menu-actions">
      <button class="menu-btn" id="btnCampaignBack">Back</button>
    </div>
  </div>
</div>

<div id="app" class="screen">
  <header>
    <div class="titlewrap"><button class="icon" id="btnMenu" title="Menu">âŒ‚</button><h1>WORDSHIFT</h1></div>
    <div id="campaignProgress" class="campaign-progress"></div>
    <div class="controls">
      <button class="icon" id="btnDiag" title="Diagnostics">ðŸž</button>
      <button class="icon" id="btnHelp" title="Help">?</button>
      <button class="icon" id="btnFS" title="Fullscreen">â›¶</button>
      <button class="icon" id="btnSearch" title="Word list">ðŸ”Ž</button>
      <button class="icon" id="btnSettings" title="Settings">âš™ï¸</button>
      <button class="icon" id="btnNew" title="New">ðŸ”</button>
      <button class="icon" id="btnRandom" title="Random (same len)">ðŸŽ²</button>
    </div>
  </header>

  <div class="main">
    <section class="section board-wrap" id="wrap">
      <div id="overlayTitle">WORDSHIFT</div>
      <div id="hotseatBar" class="hotseat-bar">
        <div class="hs-team red">
          <div class="hs-name">RED</div>
          <div class="hs-meta">Greens: <span id="hsRedGreens">0</span></div>
          <div class="hs-meta">Avg: <span id="hsRedAvg">-</span></div>
        </div>
        <div class="hs-mid">
          <div class="hs-round">Round <span id="hsRound">1</span></div>
          <div class="hs-turn">Turn: <span id="hsTurn">RED</span></div>
        </div>
        <div class="hs-team blue">
          <div class="hs-name">BLUE</div>
          <div class="hs-meta">Greens: <span id="hsBlueGreens">0</span></div>
          <div class="hs-meta">Avg: <span id="hsBlueAvg">-</span></div>
        </div>
      </div>
      <div id="boardScroll" class="board-scroll">
        <div id="board"></div>
      </div>
      <div id="guessLeft" aria-live="polite"></div>
      <div id="countdownBar"><div class="bar-fill"></div></div>
      <div id="countdownLabel"></div>
    </section>
    <section class="section">
      <div class="pane">
        <canvas class="swipe-trace" id="swipeTrace"></canvas>
        <div class="swipe-bar hidden" id="swipeBar">
          <button class="swipe-suggest" data-idx="0"></button>
          <button class="swipe-suggest" data-idx="1"></button>
          <button class="swipe-suggest" data-idx="2"></button>
        </div>
        <div class="keyboard" id="kbd"></div>
      </div>
    </section>
  </div>
</div>

<div class="win-burst" id="winBurst">
  <span class="burst-ring ring-a"></span>
  <span class="burst-ring ring-b"></span>
  <span class="burst-stars"></span>
</div>
<div class="toast" id="toast"></div>
<div class="pass-overlay" id="passOverlay">
  <div class="pass-card">
    <div class="pass-title">Pass</div>
    <div class="pass-player" id="passPlayer">RED</div>
    <div class="pass-sub">Tap to continue</div>
  </div>
</div>

<div class="modal" id="settings">
  <div class="card">
    <h2>Game Settings</h2>
    <div class="row">
      <label for="word">Target word</label>
      <input id="word" type="text" placeholder="Type any Aâ€“Z string">
    </div>
    <div class="row">
      <label for="gcount">Max guesses</label>
      <input id="gcount" type="number" min="3" max="20" value="9">
    </div>
    <div class="row">
      <label>Difficulty</label>
      <select id="difficulty">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="insane">Insane</option>
        <option value="impossible">Impossible</option>
      </select>
    </div>
    <div class="difficulty-info">
      <div class="info-box" id="difficultyInfo">
        <strong>Normal:</strong> Arrows shown for all distances. Plan your guesses strategically.
      </div>
    </div>
    <div class="row">
      <label>Fade color (yellowâ†’green)</label>
      <div class="switch" id="fadeSwitch"><input type="checkbox"><div class="knob"></div></div>
    </div>
    <div class="row">
      <label>Enforce dictionary</label>
      <div class="switch" id="enforceSwitch"><input type="checkbox"><div class="knob"></div></div>
    </div>

    <h3 style="margin:12px 0 4px">Dictionaries</h3>
    <div class="row">
      <label for="dictUrl">Full dictionary URL</label>
      <input id="dictUrl" type="url" placeholder="https://cdn.jsdelivr.net/gh/dolph/dictionary/enable1.txt">
    </div>

    <h3 style="margin:12px 0 4px">Theme</h3>
    <div class="row">
      <label for="theme">Theme</label>
      <select id="theme">
        <option value="classic">Classic</option>
        <option value="ocean">Ocean</option>
        <option value="sunset">Sunset</option>
        <option value="neo">Neon</option>
        <option value="pastel">Pastel</option>
        <option value="contrast">High Contrast</option>
      </select>
    </div>

    <details class="mut-section" id="mutatorSection" open>
      <summary>Mutators (Sandbox)</summary>
      <div class="mutator-search-wrap">
        <input type="text" id="mutatorSearch" placeholder="Search mutators..." style="margin-bottom:12px">
      </div>
      <div class="mutator-list" id="mutatorList">
        <div class="mutator-item" data-mutator="blindStart">
          <div class="mutator-label">
            <span class="mutator-name">Blind start</span>
            <span class="mutator-desc">First 2 rows show no hints.</span>
          </div>
          <div class="switch" id="mutBlind"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="echo">
          <div class="mutator-label">
            <span class="mutator-name">Echo (green lock)</span>
            <span class="mutator-desc">Green letters from the previous row must stay locked in place.</span>
          </div>
          <div class="switch" id="mutEcho"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="vowelsOnly">
          <div class="mutator-label">
            <span class="mutator-name">Vowel gate</span>
            <span class="mutator-desc">If the target has a vowel, each guess must include at least one vowel.</span>
          </div>
          <div class="switch" id="mutVowels"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="mirror">
          <div class="mutator-label">
            <span class="mutator-name">Mirror board</span>
            <span class="mutator-desc">After the first guess, row 1 is mirrored across the board for a sudden info flip.</span>
          </div>
          <div class="switch" id="mutMirror"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="staticTile">
          <div class="mutator-label">
            <span class="mutator-name">Static tile</span>
            <span class="mutator-desc">One random letter from your first guess locks in place for the next 2 guesses.</span>
          </div>
          <div class="switch" id="mutStatic"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="drift">
          <div class="mutator-label">
            <span class="mutator-name">Drift</span>
            <span class="mutator-desc">Previous rows shift letters backward each round (A wraps to Z), and hints update.</span>
          </div>
          <div class="switch" id="mutDrift"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="fog">
          <div class="mutator-label">
            <span class="mutator-name">Fog of war</span>
            <span class="mutator-desc">Only the most recent row stays visible.</span>
          </div>
          <div class="switch" id="mutFog"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="budget">
          <div class="mutator-label">
            <span class="mutator-name">Budget</span>
            <span class="mutator-desc">First guess is free. After that, only the most expensive letter shift costs points. Run out and you lose.</span>
            <div class="mutator-config-inline" id="budgetPointsRow">
              <label for="budgetPoints">Points:</label>
              <input id="budgetPoints" type="number" min="1" max="999" value="50">
            </div>
          </div>
          <div class="switch" id="mutBudget"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="doubleVision">
          <div class="mutator-label">
            <span class="mutator-name">Double vision</span>
            <span class="mutator-desc">One tile per row copies the tile above until your next guess.</span>
          </div>
          <div class="switch" id="mutDouble"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="bloodMirage">
          <div class="mutator-label">
            <span class="mutator-name">Blood mirage</span>
            <span class="mutator-desc">One random tile per row lies, highlighted in red.</span>
          </div>
          <div class="switch" id="mutBlood"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="randomKeyboard">
          <div class="mutator-label">
            <span class="mutator-name">Random keyboard</span>
            <span class="mutator-desc">Keyboard letters shuffle every round.</span>
          </div>
          <div class="switch" id="mutRandKbd"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="lifeline">
          <div class="mutator-label">
            <span class="mutator-name">Life line</span>
            <span class="mutator-desc">Double-tap a tile to reveal its exact distance; limited uses per game.</span>
            <div class="mutator-config-inline" id="lifelineCountRow">
              <label for="lifelineCount">Uses:</label>
              <input id="lifelineCount" type="number" min="1" max="10" value="1">
            </div>
          </div>
          <div class="switch" id="mutLife"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="wildcard">
          <div class="mutator-label">
            <span class="mutator-name">Wildcard</span>
            <span class="mutator-desc">Toggle once per game; allows one letter to break the dictionary check.</span>
          </div>
          <div class="switch" id="mutWildcard"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="noisyArrows">
          <div class="mutator-label">
            <span class="mutator-name">Noisy arrows</span>
            <span class="mutator-desc">For distances >3, arrows have a 33% chance to point up/down instead.</span>
          </div>
          <div class="switch" id="mutNoisy"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="hotPotato">
          <div class="mutator-label">
            <span class="mutator-name">Hot potato</span>
            <span class="mutator-desc">Change at least 2 slots each guess (3 on 7+ letters). Green/locked slots are exempt. One heat break per level.</span>
          </div>
          <div class="switch" id="mutHotPotato"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="phantomLetter">
          <div class="mutator-label">
            <span class="mutator-name">Phantom letter</span>
            <span class="mutator-desc">One random tile per row shows no hint at allâ€”just the letter you typed.</span>
          </div>
          <div class="switch" id="mutPhantom"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="copycat">
          <div class="mutator-label">
            <span class="mutator-name">Copycat</span>
            <span class="mutator-desc">Your guess must share at least N letters (same position) with the previous guess.</span>
            <div class="mutator-config-inline" id="copycatMinRow">
              <label for="copycatMin">Minimum:</label>
              <input id="copycatMin" type="number" min="1" max="10" value="2">
            </div>
          </div>
          <div class="switch" id="mutCopycat"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="minDistance">
          <div class="mutator-label">
            <span class="mutator-name">Minimum distance</span>
            <span class="mutator-desc">Only your strongest half of letter shifts count (rounded down). Their total must be at least N.</span>
            <div class="mutator-config-inline" id="minDistanceValRow">
              <label for="minDistanceVal">Distance:</label>
              <input id="minDistanceVal" type="number" min="1" max="12" value="10">
            </div>
          </div>
          <div class="switch" id="mutMinDist"><input type="checkbox"><div class="knob"></div></div>
        </div>
        <div class="mutator-item" data-mutator="countdown">
          <div class="mutator-label">
            <span class="mutator-name">Countdown</span>
            <span class="mutator-desc">You have a time limit per guess. Run out and you lose a guess.</span>
            <div class="mutator-config-inline" id="countdownSecRow">
              <label for="countdownSec">Seconds:</label>
              <input id="countdownSec" type="number" min="5" max="120" value="30">
            </div>
            <div class="mutator-config-inline" id="countdownKeyCentiRow">
              <label for="countdownKeyCenti">Per key (input/10 seconds):</label>
              <input id="countdownKeyCenti" type="number" min="0" max="50" value="0">
            </div>
          </div>
          <div class="switch" id="mutCountdown"><input type="checkbox"><div class="knob"></div></div>
        </div>
      </div>
    </details>

    <div class="actions">
      <button class="secondary" id="btnCopyState">Copy state</button>
      <button class="secondary" id="btnPasteState">Paste state</button>
      <button class="secondary" id="btnClose">Close</button>
      <button class="primary" id="btnApply">Apply</button>
    </div>
  </div>
</div>

<div class="modal" id="wordReviewModal">
  <div class="card">
    <h2>Campaign Word Review</h2>
    <p class="intro-desc">Approve or reject random campaign candidates. Load from URL, then bind a JSON file to write decisions back to disk.</p>
        <div class="word-review-list" id="wrList"></div>
    <div class="word-review-stats" id="wrStats"></div>

    <div class="actions">
      <button class="secondary" id="wrBindFile" type="button">Bind JSON File</button>
      <button class="secondary" id="wrSaveFile" type="button">Save Now</button>
      <button class="secondary" id="wrReload" type="button">Reload File</button>
      <button class="secondary" id="wrClose" type="button">Close</button>
    </div>
  </div>
</div>
<div class="modal" id="hotseatLobby">
  <div class="card">
    <h2>Hot Seat Lobby</h2>
    <p class="intro-desc">Two-player pass-and-play. Red then Blue. Dictionary enforcement is always off.</p>
    <div class="row">
      <label>Word source</label>
      <div class="seg-radio" id="hsWordSource">
        <label class="seg-opt"><input type="radio" name="hsWordSource" value="random">Random (6 letters)</label>
        <label class="seg-opt"><input type="radio" name="hsWordSource" value="custom">Custom</label>
      </div>
    </div>
    <div class="row" id="hsCustomRow">
      <label for="hsCustomWord">Custom word (6 letters)</label>
      <input id="hsCustomWord" type="text" placeholder="SECRET">
    </div>
    <div class="row">
      <label>Claim rule</label>
      <div class="seg-note">Auto (farthest opponent tile)</div>
    </div>
    <div class="row">
      <label>Pass overlay</label>
      <div class="switch" id="hsPassSwitch"><input type="checkbox"><div class="knob"></div></div>
    </div>
    <div class="actions">
      <button class="secondary" id="hsClose">Back</button>
      <button class="primary" id="hsStart">Start</button>
    </div>
  </div>
</div>

<div class="modal" id="words">
  <div class="card">
    <h2>Word list (current length)</h2>
    <div class="row">
      <label for="wfilter">Filter</label>
      <input id="wfilter" type="text" placeholder="type to filterâ€¦ (prefix)">
    </div>
    <div id="wcount" style="opacity:.75;margin-bottom:8px">0 words</div>
    <div id="wlist" style="font-family:ui-monospace,Consolas,monospace;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px"></div>
    <div class="actions">
      <button class="secondary" id="wclose">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="resumePrompt">
  <div class="card">
    <h2>Resume sandbox game?</h2>
    <p style="color:var(--muted);margin:6px 0 12px">A previous session was found.</p>
    <div class="actions">
      <button class="secondary" id="resumeNew">Start new</button>
      <button class="primary" id="resumeYes">Resume</button>
    </div>
  </div>
</div>

<div class="modal" id="optionsModal">
  <div class="card">
    <h2>Options</h2>
    <p class="intro-desc">Manage saved progress and sessions.</p>
    <div class="row">
      <label>Reset campaign progress</label>
      <button class="secondary danger" id="optResetCampaign">Reset</button>
    </div>
    <div class="row">
      <label>Clear sandbox session</label>
      <button class="secondary" id="optClearSandbox">Clear</button>
    </div>
    <div class="row">
      <label for="optWordReviewUrl">Campaign word file URL</label>
      <input id="optWordReviewUrl" type="text" placeholder="campaign_words.json">
    </div>
    <div class="row">
      <label>Reload campaign word file</label>
      <button class="secondary" id="optWordReviewReload">Reload</button>
    </div>
    <div class="actions">
      <button class="secondary" id="optClose">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="campaignFail">
  <div class="card">
    <h2>Pack failed</h2>
    <p id="failMsg" style="color:var(--muted);margin:6px 0 12px"></p>
    <div class="actions">
      <button class="secondary" id="failMenu">Return to menu</button>
      <button class="primary" id="failRestart">Restart pack</button>
    </div>
  </div>
</div>

  <div class="modal" id="campaignIntro">
  <div class="card">
    <div class="intro-head">
      <h2 id="introTitle">Pack intro</h2>
      <button class="secondary danger" id="introClear">Forfeit</button>
    </div>
    <p id="introDesc" class="intro-desc"></p>
    <div id="introMeta" class="intro-meta"></div>
    <div class="actions">
      <button class="secondary" id="introBack">Back</button>
      <button class="secondary" id="introAutoComplete">Auto complete</button>
      <button class="primary" id="introStart">Start pack</button>
    </div>
  </div>
</div>

<div class="modal" id="campaignShop">
  <div class="card">
    <div class="shop-head">
      <h2>Cluster Shop</h2>
      <p id="shopSubtitle" class="intro-desc">Spend coins on temporary and permanent upgrades.</p>
    </div>
    <div class="shop-columns">
      <section class="shop-col">
        <h3>Consumables</h3>
        <p class="shop-note">Lower cost, stackable, and active for the current cluster.</p>
        <div id="shopConsumables" class="shop-list"></div>
      </section>
      <section class="shop-col">
        <h3>Permanent Upgrades</h3>
        <p class="shop-note">Higher prices, permanent for the full run.</p>
        <div id="shopPermanents" class="shop-list"></div>
      </section>
    </div>
    <section class="shop-free">
      <h3>Free Cluster Upgrade</h3>
      <p class="shop-note">Pick 1 of 2. Each has a strong upside and downside.</p>
      <div id="shopFreeChoice" class="shop-list shop-free-list"></div>
    </section>
    <div class="actions">
      <button class="secondary" id="shopSkip">Leave shop</button>
      <button class="primary" id="shopContinue">Continue</button>
    </div>
  </div>
</div>

<div id="diag">
  <div class="panel">
    <header>
      <h3>Diagnostics</h3>
      <div style="display:flex;gap:8px">
        <button id="copyLog">Copy log</button>
        <button id="clearLog">Clear</button>
        <button id="reload" class="primary">Reload</button>
      </div>
    </header>
    <div id="log" class="log" aria-live="polite"></div>
    <footer>
      <div style="margin-right:auto;opacity:.7;font-size:12px">Errors and console output appear here automatically.</div>
      <button id="closeDiag">Close</button>
    </footer>
  </div>
</div>

<script>
(function(){
  var $=function(s){return document.querySelector(s)};
  var logEl=document.getElementById('log');
  var diag=document.getElementById('diag');
  var bug=document.getElementById('btnDiag');
  var logs=[];
  function line(cls,msg,opts){
    var div=document.createElement('div');div.className=cls;div.textContent=msg;
    logEl.appendChild(div);logEl.scrollTop=logEl.scrollHeight;logs.push(msg);
    if(logs.length>500){
      var drop=logs.length-500;
      logs.splice(0, drop);
      for(var i=0;i<drop;i++){ if(logEl.firstChild) logEl.removeChild(logEl.firstChild); }
    }
    if(!opts || !opts.noStore){
      try{localStorage.setItem('wordshift_diag_log',logs.join('\n'));}catch(e){}
    }
  }
  function open(){diag.classList.add('open');}
  function close(){diag.classList.remove('open');}
  bug.addEventListener('click',open);
  document.getElementById('closeDiag').addEventListener('click',close);
  document.getElementById('reload').addEventListener('click',function(){
    try{
      var sc=document.getElementById('boardScroll');
      if(sc) sc.scrollTop=0;
    }catch(e){}
    location.reload();
  });
  document.getElementById('copyLog').addEventListener('click',function(){
    var txt=logs.join('\n');
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){line('i','[copied log to clipboard]')},function(){line('w','[copy failed]')});
    }else{ line('w','[copy failed]') }
  });
  document.getElementById('clearLog').addEventListener('click',function(){
    logEl.innerHTML='';logs.length=0;
    try{localStorage.removeItem('wordshift_diag_log');}catch(e){}
  });
  try{
    var prev=localStorage.getItem('wordshift_diag_log');
    if(prev){
      prev.split('\n').forEach(function(t){
        if(t){ line('i prev', t, {noStore:true}); }
      });
    }
  }catch(e){}
  ['log','warn','error'].forEach(function(kind){
    var orig=console[kind].bind(console);
    console[kind]=function(){
      orig.apply(console,arguments);
      var args=[].slice.call(arguments);
      line(kind==='error'?'e':(kind==='warn'?'w':'i'), args.map(function(x){
        try{
          if(x && x.stack){return x.stack;} 
          if(typeof x==='object'){return JSON.stringify(x)}
          return String(x);
        }catch(e){return String(x)}
      }).join(' '));
    };
  });
  window.addEventListener('error',function(e){
    var msg='[error] '+(e && e.message ? e.message : 'unknown');
    if(e && e.filename){msg+=' @ '+e.filename+':'+e.lineno+':'+e.colno}
    line('e',msg);
    try{ if(e && e.error && e.error.stack){ line('e',e.error.stack) } }catch(er){}
    open();
  });
  window.addEventListener('unhandledrejection',function(e){
    var r=e && e.reason; var msg='[promise] '+(r && r.message ? r.message : String(r));
    try{ if(r && r.stack){ line('e', r.stack) } }catch(er){}
    line('e', msg); open();
  });
  line('i','[boot] diagnostics online');
})();
</script>

<script>
(function(){
var $=function(s){return document.querySelector(s)};
var $$=function(s){return Array.prototype.slice.call(document.querySelectorAll(s))};
var toastEl=$('#toast');
var toastTimer=null;
function toast(msg,ms){
  ms=ms||1400;
  toastEl.textContent=msg;
  toastEl.classList.add('show');
  if(toastTimer){ clearTimeout(toastTimer); toastTimer=null; }
  toastTimer=setTimeout(function(){ toastEl.classList.remove('show'); },ms);
}
function lettersOnlyUpper(s){s=(s||'')+'';s=s.toUpperCase();var o='';for(var i=0;i<s.length;i++){var c=s.charCodeAt(i);if(c>=65&&c<=90)o+=s[i]}return o}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function recGuesses(len){return clamp(len+1,3,20)}
function aIdx(ch){return ch.charCodeAt(0)-65}
function idxToChar(i){return String.fromCharCode(65+clamp(i,0,25))}
function save(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function load(k,def){try{var v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}
function safeInt(v,def){var n=parseInt(v,10);return isNaN(n)?def:n}
function inForm(el){return !!(el && (el.closest && el.closest('input,textarea,select,[contenteditable=\"true\"]')));}
function mutOn(name){
  if(state.mode==='sandbox') return state.mutators && !!state.mutators[name];
  if(state.mode==='campaign') return state.campaignMutators && !!state.campaignMutators[name];
  return false;
}
function hasVowel(s){ return /[AEIOU]/.test((s||'')+''); }
function wildcardDictFix(word){
  if(!word) return null;
  if(state.dict && state.dict.has(word)) return null;
  var arr=word.split('');
  for(var i=0;i<arr.length;i++){
    var orig=arr[i];
    for(var j=0;j<ALPHA.length;j++){
      var ch=ALPHA[j];
      if(ch===orig) continue;
      arr[i]=ch;
      var w=arr.join('');
      if(state.dict && state.dict.has(w)){ arr[i]=orig; return {index:i, word:w}; }
    }
    arr[i]=orig;
  }
  return null;
}
function clampLifeCount(v){ return clamp(safeInt(v,1),1,10); }
function clampBudget(v){ return clamp(safeInt(v,50),1,999); }
function clampMinDistance(v){ return clamp(safeInt(v,10),1,12); }
var ALPHA='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

function parseCssColor(c){
  c=c.trim();
  if(c.indexOf('#')===0){
    var x=c.slice(1);
    if(x.length===3){return [parseInt(x[0]+x[0],16),parseInt(x[1]+x[1],16),parseInt(x[2]+x[2],16)]}
    return [parseInt(x.slice(0,2),16),parseInt(x.slice(2,4),16),parseInt(x.slice(4,6),16)];
  } else if(c.indexOf('rgb')===0){
    var m=c.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i); if(m) return [parseInt(m[1]),parseInt(m[2]),parseInt(m[3])];
  }
  return [201,180,88];
}
function blend(a,b,t){
  var r=[0,0,0]; for(var i=0;i<3;i++){r[i]=Math.round(a[i]*(1-t)+b[i]*t)}; return 'rgb('+r[0]+', '+r[1]+', '+r[2]+')';
}

var savedTarget=lettersOnlyUpper(load('target','CRANE')) || 'CRANE';
var savedMax=safeInt(load('max', recGuesses(savedTarget.length)), recGuesses(savedTarget.length));
function normalizeMutators(raw){
  raw = raw || {};
  return {
    blindStart:!!raw.blindStart,
    echo:!!raw.echo,
    vowelsOnly:!!raw.vowelsOnly,
    mirror:!!raw.mirror,
    staticTile:!!raw.staticTile,
    drift:!!raw.drift,
    fog:!!raw.fog,
    budget:!!raw.budget,
    budgetPoints:safeInt(raw.budgetPoints, 50),
    doubleVision:!!raw.doubleVision,
    bloodMirage:!!raw.bloodMirage,
    randomKeyboard:!!raw.randomKeyboard,
    lifeline:!!raw.lifeline,
    lifelineCount: safeInt(raw.lifelineCount, 1),
    wildcard:!!raw.wildcard,
    noisyArrows:!!raw.noisyArrows,
    hotPotato:!!raw.hotPotato,
    phantomLetter:!!raw.phantomLetter,
    copycat:!!raw.copycat,
    copycatMin:safeInt(raw.copycatMin, 2),
    minDistance:!!raw.minDistance,
    minDistanceVal:clampMinDistance(raw.minDistanceVal),
    countdown:!!raw.countdown,
    countdownSec:safeInt(raw.countdownSec, 30),
    countdownKeyCenti: clamp(safeInt(raw.countdownKeyCenti, 0), 0, 50)
  };
}
var MUTATOR_HELP={
  blindStart:'First 2 rows show no hints.',
  echo:'Green letters from the previous row must stay locked in place.',
  vowelsOnly:'If the target contains a vowel, each guess must include at least one vowel.',
  mirror:'After the first guess, row 1 is mirrored across the board for a sudden info flip.',
  staticTile:'One random letter from your first guess locks in place for the next 2 guesses.',
  drift:'Previous rows shift letters backward each round (A wraps to Z), and hints update.',
  fog:'Only the most recent row stays visible.',
  budget:'First guess is free. After that, only the largest letter shift costs points. Run out and you lose.',
  doubleVision:'One tile per row copies the tile above until your next guess.',
  bloodMirage:'One random tile per row lies, highlighted in red.',
  randomKeyboard:'Keyboard letters shuffle every round.',
  lifeline:'Double-tap a tile to reveal its exact distance; limited uses per game.',
  wildcard:'Toggle once per game; allows one letter to break the dictionary check.',
  noisyArrows:'For distances >3, arrows have a 33% chance to point the wrong way.',
  hotPotato:'Change at least 2 slots each guess (3 on 7+ letters). Green/locked slots are exempt. One heat break per level.',
  phantomLetter:'One random tile per row shows no hint at allâ€”just the letter you typed.',
  copycat:'Your guess must share at least N letters (anywhere) with the previous guess.',
  minDistance:'Only the strongest half of letter shifts (rounded down) are counted; their total must reach N.',
  countdown:'You have a time limit per guess. Run out and you lose a guess.'
};
var HOTSEAT_DEFAULTS={
  wordSource:'random',
  customWord:'',
  passOverlay:true,
  claimRule:'auto'
};
function normalizeHotseatSettings(raw){
  raw = raw || {};
  var src = (raw.wordSource==='custom') ? 'custom' : 'random';
  return {
    wordSource:src,
    customWord:lettersOnlyUpper(raw.customWord || ''),
    passOverlay:(typeof raw.passOverlay==='boolean') ? raw.passOverlay : HOTSEAT_DEFAULTS.passOverlay,
    claimRule:(raw.claimRule==='auto') ? 'auto' : HOTSEAT_DEFAULTS.claimRule
  };
}
var state={
  target:savedTarget,row:0,col:0,max:clamp(savedMax,3,20),grid:[],statuses:{},hints:[],gameOver:false,enforce:load('enforce',true),replaceMode:false,grayUntil:true,
  countdownTimer:null,countdownRemaining:0,countdownMax:30,
  dict:new Set(),dictLen:new Map(),dictUrl:load('dictUrl','https://cdn.jsdelivr.net/gh/dolph/dictionary/enable1.txt'),
  theme:load('theme','classic'),difficulty:load('difficulty','normal'),fadeColor:!!load('fadeColor',false),kbdHintsOn:false,mode:'sandbox',
  resumeCountdown:false,
  pendingCampaignTimeout:false,
  lastVisit:load('lastVisit',null),
  hotseatSettings:normalizeHotseatSettings(load('hotseat_settings', null)),
  hotseat:null,
  mutators:normalizeMutators(load('mutators', null)),
  campaignMutators:normalizeMutators(null),
  budgetPoints:null,
  wildcardUsed:false,
  wildcardArmed:false,
  staticLock:null,
  doubleVision:null,
  bloodMirage:null,
  exacts:[],
  guessHistory:[],
  fogReveal:false,
  hintsRaw:[],
  lifelineRemaining:null,
  lifelineUsedThisLevel:0,
  hotPotatoBreakUsed:false
};
var remoteDictLen=new Map();
document.documentElement.setAttribute('data-theme', state.theme);
window.__wordshift_state = state;

var FRAME=$('#wrap'), SCROLL=$('#boardScroll'), BOARD=$('#board'), KBD=$('#kbd'), GUESS_LABEL=$('#guessLeft');
var SWIPE_BAR=$('#swipeBar'); var SWIPE_BTNS=$$('#swipeBar .swipe-suggest');
var SWIPE_TRACE=$('#swipeTrace');
var HS_RED_GREENS=$('#hsRedGreens');
var HS_BLUE_GREENS=$('#hsBlueGreens');
var HS_RED_AVG=$('#hsRedAvg');
var HS_BLUE_AVG=$('#hsBlueAvg');
var HS_TURN=$('#hsTurn');
var HS_ROUND=$('#hsRound');
var PASS_OVERLAY=$('#passOverlay');
var PASS_PLAYER=$('#passPlayer');
var hotseatLobby=$('#hotseatLobby');
var hsWordSource=$('#hsWordSource');
var hsCustomRow=$('#hsCustomRow');
var hsCustomWord=$('#hsCustomWord');
var hsPassSwitch=$('#hsPassSwitch');
var MIN_TILE=34;
var lastVisibleRow=-1;
var campaignIntroTimer=null;
if(GUESS_LABEL){
  GUESS_LABEL.addEventListener('click', function(){
    if(mutOn('wildcard') && !state.wildcardUsed && !state.gameOver){
      state.wildcardArmed = !state.wildcardArmed;
      toast(state.wildcardArmed ? 'Wildcard armed' : 'Wildcard cancelled');
      updateGuessLabel(false);
      saveSession();
    }
  });
}
function persistSettings(){
  if(state.mode==='campaign') return;
  save('target', state.target);
  save('max', state.max);
  save('difficulty', state.difficulty);
  save('fadeColor', state.fadeColor);
  save('enforce', state.enforce);
  save('dictUrl', state.dictUrl);
  save('mutators', state.mutators);
}
function saveHotseatSettings(){
  save('hotseat_settings', state.hotseatSettings);
}
function sessionKey(){
  if(state.mode==='campaign'){ return activeCampaign ? campaignKey(activeCampaign.setId) : null; }
  if(state.mode==='sandbox') return 'session';
  return null;
}
function saveSession(){
  var key=sessionKey();
  if(!key) return;
  var payload={
    target:state.target,max:state.max,difficulty:state.difficulty,fadeColor:state.fadeColor,enforce:state.enforce,dictUrl:state.dictUrl,
    grid:state.grid,hints:state.hints,row:state.row,col:state.col,statuses:state.statuses,
    gameOver:state.gameOver,replaceMode:state.replaceMode,ts:Date.now(),
    countdownRemaining:state.countdownRemaining,countdownMax:state.countdownMax,
    budgetPoints:state.budgetPoints,wildcardUsed:state.wildcardUsed,wildcardArmed:state.wildcardArmed,
    staticLock:state.staticLock,doubleVision:state.doubleVision,bloodMirage:state.bloodMirage,exacts:state.exacts,guessHistory:state.guessHistory,
    fogReveal:state.fogReveal,hintsRaw:state.hintsRaw,lifelineRemaining:state.lifelineRemaining,
    lifelineUsedThisLevel:state.lifelineUsedThisLevel,
    hotPotatoBreakUsed:state.hotPotatoBreakUsed,
    campaignMutators:state.campaignMutators
  };
  if(state.mode==='campaign' && activeCampaign){
    payload.campaignId=activeCampaign.setId;
    payload.campaignIndex=activeCampaign.index;
  }
  save(key, payload);
}
function hasProgress(session){
  if(!session) return false;
  if(session.gameOver) return false;
  if(session.row && session.row>0) return true;
  if(session.grid){
    for(var r=0;r<session.grid.length;r++){
      for(var c=0;c<session.grid[r].length;c++){
        if(session.grid[r][c]) return true;
      }
    }
  }
  return false;
}
function applySessionSettings(session){
  state.target = lettersOnlyUpper(session.target) || state.target;
  state.max = clamp(safeInt(session.max, state.max),3,20);
  state.difficulty = session.difficulty || state.difficulty;
  state.fadeColor = !!session.fadeColor;
  state.enforce = (typeof session.enforce==='boolean') ? session.enforce : state.enforce;
  state.dictUrl = session.dictUrl || state.dictUrl;
}
function applySessionProgress(session){
  state.grid = session.grid || [];
  state.hints = session.hints || [];
  state.row = clamp(safeInt(session.row,0),0,state.max-1);
  state.col = clamp(safeInt(session.col,0),0,state.target.length);
  state.statuses = session.statuses || {};
  state.gameOver = !!session.gameOver;
  state.replaceMode = !!session.replaceMode;
  state.budgetPoints = (typeof session.budgetPoints==='number') ? session.budgetPoints : state.budgetPoints;
  state.wildcardUsed = !!session.wildcardUsed;
  state.wildcardArmed = !!session.wildcardArmed;
  state.staticLock = session.staticLock || null;
  state.doubleVision = session.doubleVision || null;
  state.bloodMirage = session.bloodMirage || null;
  state.exacts = session.exacts || [];
  state.guessHistory = session.guessHistory || [];
  state.fogReveal = !!session.fogReveal;
  state.hintsRaw = session.hintsRaw || [];
  state.lifelineRemaining = (typeof session.lifelineRemaining==='number') ? session.lifelineRemaining : state.lifelineRemaining;
  state.lifelineUsedThisLevel = safeInt(session.lifelineUsedThisLevel, 0);
  state.hotPotatoBreakUsed = !!session.hotPotatoBreakUsed;
  state.campaignMutators = normalizeMutators(session.campaignMutators || null);
  state.countdownRemaining = (typeof session.countdownRemaining==='number') ? session.countdownRemaining : state.countdownRemaining;
  state.countdownMax = (typeof session.countdownMax==='number') ? session.countdownMax : state.countdownMax;
  state.resumeCountdown = (typeof session.countdownRemaining==='number');
}
function applyCampaignResumeDecay(session){
  if(state.mode!=='campaign') return;
  if(!session || typeof session.ts!=='number') return;
  if(!mutOn('countdown')) return;
  if(typeof state.countdownRemaining!=='number') return;
  var elapsed = Math.max(0, (Date.now() - session.ts) / 1000);
  if(!elapsed) return;
  state.countdownRemaining = state.countdownRemaining - elapsed;
  state.resumeCountdown = true;
  if(state.countdownRemaining<=0){
    state.countdownRemaining=0;
    state.pendingCampaignTimeout=true;
  }
}
var HS_RED=0, HS_BLUE=1;
var HOTSEAT_FALLBACK=['BRONZE','COOKIE','YELLOW','GALAXY','PLANET','ORANGE','SILVER','MONKEY'];
function hsName(p){ return p===HS_RED ? 'Red' : 'Blue'; }
function hsShort(p){ return p===HS_RED ? 'RED' : 'BLUE'; }
function hsOpp(p){ return p===HS_RED ? HS_BLUE : HS_RED; }
function hotseatPickTarget(){
  var s=state.hotseatSettings || HOTSEAT_DEFAULTS;
  if(s.wordSource==='custom'){
    var w=lettersOnlyUpper(s.customWord || '');
    if(w.length!==6){ toast('Custom word must be 6 letters.'); return null; }
    return w;
  }
  var pool = state.dictLen.get(6) ? Array.from(state.dictLen.get(6)) : [];
  if(!pool.length && typeof seed!=='undefined' && seed && seed.length){
    pool = seed.filter(function(w){ return w.length===6; });
  }
  var pick = pool.length ? pool[(Math.random()*pool.length)|0] : '';
  if(!pick || pick.length!==6){ pick = HOTSEAT_FALLBACK[(Math.random()*HOTSEAT_FALLBACK.length)|0]; }
  return pick;
}
function hotseatResetMatch(){
  state.hotseat={
    owner:[HS_RED,HS_RED,HS_RED,HS_BLUE,HS_BLUE,HS_BLUE],
    green:[false,false,false,false,false,false],
    greenOwner:[null,null,null,null,null,null],
    greenCount:[0,0],
    lastGreenBy:null,
    roundCols:{red:[], blue:[]},
    roundOwner:new Array(state.target.length).fill(null),
    turn:HS_RED,
    cursorCol:0,
    borrowed:null,
    lastAvg:[null,null],
    lastWinner:null
  };
}
function hotseatOwnedCols(player){
  var hs=state.hotseat; if(!hs) return [];
  var cols=[];
  for(var c=0;c<state.target.length;c++){
    if(hs.green[c]) continue;
    if(hs.owner[c]===player) cols.push(c);
  }
  return cols;
}
function hotseatComputeColsForPlayer(player){
  var hs=state.hotseat; if(!hs) return [];
  var cols=hotseatOwnedCols(player);
  hs.borrowed=null;
  if(!cols.length){
    var opp=hsOpp(player);
    var oppCols=hotseatOwnedCols(opp);
    if(oppCols.length){
      cols=[oppCols[0]];
      hs.borrowed={col:cols[0], from:opp, to:player};
    }
  }
  return cols;
}
function hotseatEditableCols(){
  var hs=state.hotseat; if(!hs) return [];
  return (hs.turn===HS_RED) ? (hs.roundCols.red||[]) : (hs.roundCols.blue||[]);
}
function hotseatEnsureCursor(){
  var hs=state.hotseat; if(!hs) return;
  var cols=hotseatEditableCols();
  if(!cols.length){ hs.cursorCol=0; return; }
  if(cols.indexOf(hs.cursorCol)===-1) hs.cursorCol=cols[0];
}
function hotseatSetCursor(col){
  var hs=state.hotseat; if(!hs) return;
  hs.cursorCol=col;
  state.col=col;
  updateHotseatOwnershipVisuals();
}
function hotseatSetupTurn(player){
  var hs=state.hotseat; if(!hs) return;
  hs.turn=player;
  var cols=hotseatComputeColsForPlayer(player);
  if(player===HS_RED) hs.roundCols.red=cols; else hs.roundCols.blue=cols;
  for(var i=0;i<cols.length;i++){
    hs.roundOwner[cols[i]]=player;
  }
  hs.cursorCol = cols.length ? cols[0] : 0;
  state.col = hs.cursorCol;
  updateHotseatUI();
  updateHotseatOwnershipVisuals();
}
function hotseatStartRound(){
  var hs=state.hotseat; if(!hs) return;
  hs.roundCols={red:[], blue:[]};
  hs.roundOwner=new Array(state.target.length).fill(null);
  hs.borrowed=null;
  hotseatPrefillGreens(state.row);
  hotseatSetupTurn(HS_RED);
  showPassOverlay(hsShort(HS_RED));
}
function hotseatPrefillGreens(row){
  var hs=state.hotseat; if(!hs) return;
  if(!state.hints[row]) state.hints[row]=[];
  for(var c=0;c<state.target.length;c++){
    if(hs.green[c]){
      setTile(row, c, state.target[c]);
      state.hints[row][c]={exact:true, dist:0, dir:0, grayed:false, showArrow:false, showNumber:false, hidden:false};
    }else{
      state.hints[row][c]=null;
    }
  }
  renderRowFromState(row);
}
function hotseatTurnComplete(){
  var cols=hotseatEditableCols();
  if(!cols.length) return true;
  for(var i=0;i<cols.length;i++){
    if(!state.grid[state.row][cols[i]]) return false;
  }
  return true;
}
function hotseatRowComplete(){
  for(var c=0;c<state.target.length;c++){
    if(!state.grid[state.row][c]) return false;
  }
  return true;
}
function hotseatUpdateAverages(guess, rowHints, exactsRow){
  var hs=state.hotseat; if(!hs) return;
  var sums=[0,0], counts=[0,0];
  for(var c=0;c<state.target.length;c++){
    var owner = hs.roundOwner[c];
    if(owner===null || typeof owner==='undefined') owner = hs.owner[c];
    if(owner===null || typeof owner==='undefined') continue;
    if(exactsRow[c]) continue;
    var dist = (rowHints && rowHints[c] && typeof rowHints[c].dist==='number')
      ? rowHints[c].dist
      : Math.abs(aIdx(guess[c]) - aIdx(state.target[c]));
    sums[owner]+=dist;
    counts[owner]+=1;
  }
  hs.lastAvg=[
    counts[HS_RED] ? (sums[HS_RED]/counts[HS_RED]) : 0,
    counts[HS_BLUE] ? (sums[HS_BLUE]/counts[HS_BLUE]) : 0
  ];
  return {counts:counts, sums:sums};
}
function hotseatApplyGreens(exactsRow){
  var hs=state.hotseat; if(!hs) return {newRed:0,newBlue:0};
  var newRed=0, newBlue=0;
  for(var c=0;c<state.target.length;c++){
    if(!exactsRow[c]) continue;
    if(hs.green[c]) continue;
    var owner = hs.roundOwner[c];
    if(owner===null || typeof owner==='undefined') owner = hs.owner[c];
    if(owner===HS_BLUE){
      hs.greenCount[HS_BLUE]++; newBlue++;
      hs.greenOwner[c]=HS_BLUE;
    }else{
      hs.greenCount[HS_RED]++; newRed++;
      hs.greenOwner[c]=HS_RED;
    }
    hs.owner[c]=owner;
    hs.green[c]=true;
  }
  if(newRed>0 || newBlue>0){
    if(newRed>0 && newBlue>0) hs.lastGreenBy=hs.turn;
    else hs.lastGreenBy = newRed>0 ? HS_RED : HS_BLUE;
  }
  return {newRed:newRed, newBlue:newBlue};
}
function hotseatPickClaimCol(loser, rowHints, guess){
  var hs=state.hotseat; if(!hs) return null;
  var cols=hotseatOwnedCols(loser);
  if(cols.length<=1) return null;
  if(state.hotseatSettings && state.hotseatSettings.claimRule!=='auto'){ return null; }
  var best=null, bestDist=-1;
  for(var i=0;i<cols.length;i++){
    var c=cols[i];
    var dist = (rowHints && rowHints[c] && typeof rowHints[c].dist==='number')
      ? rowHints[c].dist
      : Math.abs(aIdx(guess[c]) - aIdx(state.target[c]));
    if(dist>bestDist){ bestDist=dist; best=c; }
  }
  return best;
}
function hotseatProcessRound(guess, rowHints, exactsRow, win){
  var hs=state.hotseat; if(!hs) return;
  hotseatApplyGreens(exactsRow);
  hotseatUpdateAverages(guess, rowHints, exactsRow);
  var winner=null;
  if(hs.lastAvg[HS_RED] < hs.lastAvg[HS_BLUE]) winner=HS_RED;
  else if(hs.lastAvg[HS_BLUE] < hs.lastAvg[HS_RED]) winner=HS_BLUE;
  hs.lastWinner=winner;
  if(!win && winner!==null){
    var loser=hsOpp(winner);
    var claimCol=hotseatPickClaimCol(loser, rowHints, guess);
    if(claimCol!==null && typeof claimCol==='number'){
      hs.owner[claimCol]=winner;
      toast(hsName(winner)+' claims tile '+(claimCol+1));
    }
  }
  updateHotseatUI();
  updateHotseatOwnershipVisuals();
}
function hotseatWinner(){
  var hs=state.hotseat; if(!hs) return null;
  if(hs.greenCount[HS_RED] > hs.greenCount[HS_BLUE]) return HS_RED;
  if(hs.greenCount[HS_BLUE] > hs.greenCount[HS_RED]) return HS_BLUE;
  if(hs.lastGreenBy!==null) return hs.lastGreenBy;
  return null;
}
function updateHotseatUI(){
  if(state.mode!=='hotseat') return;
  var hs=state.hotseat; if(!hs) return;
  if(HS_RED_GREENS) HS_RED_GREENS.textContent=hs.greenCount[HS_RED];
  if(HS_BLUE_GREENS) HS_BLUE_GREENS.textContent=hs.greenCount[HS_BLUE];
  if(HS_RED_AVG) HS_RED_AVG.textContent=fmtAvg(hs.lastAvg[HS_RED]);
  if(HS_BLUE_AVG) HS_BLUE_AVG.textContent=fmtAvg(hs.lastAvg[HS_BLUE]);
  if(HS_TURN) HS_TURN.textContent=hsShort(hs.turn);
  if(HS_ROUND) HS_ROUND.textContent=(state.row+1);
  document.body.classList.toggle('hs-turn-red', hs.turn===HS_RED);
  document.body.classList.toggle('hs-turn-blue', hs.turn===HS_BLUE);
}
function fmtAvg(v){
  if(v===null || typeof v==='undefined') return '-';
  var n = Math.round(v*100)/100;
  if(Math.abs(n - Math.round(n))<0.001) return ''+Math.round(n);
  return n.toFixed(2);
}
function updateHotseatOwnershipVisuals(){
  if(state.mode!=='hotseat') return;
  var hs=state.hotseat; if(!hs) return;
  var tiles=$$('.tile');
  for(var i=0;i<tiles.length;i++){
    tiles[i].classList.remove('owner-red','owner-blue','borrowed','cursor');
  }
  var row=state.row;
  for(var c=0;c<state.target.length;c++){
    var tile = document.querySelector('.tile[data-row="'+row+'"][data-col="'+c+'"]');
    if(!tile) continue;
    if(hs.green[c]) continue;
    tile.classList.add(hs.owner[c]===HS_RED ? 'owner-red' : 'owner-blue');
    if(hs.borrowed && hs.borrowed.col===c && hs.borrowed.to===hs.turn){ tile.classList.add('borrowed'); }
    if(hs.cursorCol===c){ tile.classList.add('cursor'); }
  }
}
function showPassOverlay(label){
  if(state.mode!=='hotseat') return;
  var hs=state.hotseatSettings || HOTSEAT_DEFAULTS;
  if(!hs.passOverlay) return;
  if(!PASS_OVERLAY) return;
  if(PASS_PLAYER) PASS_PLAYER.textContent=label || '';
  PASS_OVERLAY.classList.add('open');
}
function hidePassOverlay(){
  if(PASS_OVERLAY) PASS_OVERLAY.classList.remove('open');
}
function doubleVisionActiveRow(activeOverride){
  if(!mutOn('doubleVision') || state.gameOver) return -1;
  if(typeof activeOverride==='number') return activeOverride;
  if(typeof doubleVisionOverride==='number') return doubleVisionOverride;
  var r=state.row-1;
  if(r<1) return -1;
  return r;
}
function isDoubleVisionMask(r,c, activeOverride){
  if(!mutOn('doubleVision')) return false;
  var ar=doubleVisionActiveRow(activeOverride);
  if(ar<1 || r!==ar) return false;
  var col=(state.doubleVision && typeof state.doubleVision[r]==='number') ? state.doubleVision[r] : -1;
  return col===c;
}
function getDisplayTileData(r,c, activeOverride){
  var ch = (state.grid[r] && state.grid[r][c]) ? state.grid[r][c] : '';
  var hint = (state.hints[r] && state.hints[r][c]) ? state.hints[r][c] : null;
  if(isDoubleVisionMask(r,c, activeOverride)){
    var srcRow=r-1;
    var srcCh = (state.grid[srcRow] && state.grid[srcRow][c]) ? state.grid[srcRow][c] : '';
    var srcHint = (state.hints[srcRow] && state.hints[srcRow][c]) ? state.hints[srcRow][c] : null;
    return {ch:srcCh, hint:srcHint, double:true};
  }
  return {ch:ch, hint:hint, double:false};
}
function renderRowFromState(r, activeOverride){
  for(var c=0;c<state.target.length;c++){
    var tile = document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c+'\"]');
    if(!tile) continue;
    var display = getDisplayTileData(r,c, activeOverride);
    tile.classList.remove('near','correct','dir','grayed','wildcard','noisy','decoy-red','double-shadow');
    tile.removeAttribute('data-dir');
    tile.style.background=''; tile.style.borderColor='';
    var s = tile.querySelector('.tile-letter');
    if(!display.ch){ if(s) s.textContent=''; continue; }
    if(display.hint){
      applyTileVisual(tile, display.ch, display.hint, difficultyPolicy(display.hint.dist, display.hint.dir));
    }else{
      if(s) s.textContent = display.ch;
    }
    if(display.double){ tile.classList.add('double-shadow'); }
  }
}
function refreshDoubleVisionDisplay(prevRow){
  if(!mutOn('doubleVision')) return;
  if(typeof prevRow==='number' && prevRow>=0){
    renderRowFromState(prevRow);
  }
  var active=doubleVisionActiveRow();
  if(active>=0){
    renderRowFromState(active, active);
  }
}
function setRowSkipped(r, on){
  // persist it in state so reloads keep the look
  if(!state.skippedRows) state.skippedRows = {};
  if(on) state.skippedRows[r] = 1;
  else delete state.skippedRows[r];

  // apply visual class to all tiles in that row
  $$('.tile[data-row="'+r+'"]').forEach(function(t){
    t.classList.toggle('skipped', !!on);
  });
}
function renderBoardFromState(){
  for(var r=0;r<state.max;r++){
    renderRowFromState(r);
  }

  // re-apply skipped rows after render
  if(state.skippedRows){
    Object.keys(state.skippedRows).forEach(function(k){
      var rr = parseInt(k, 10);
      if(!isNaN(rr)) setRowSkipped(rr, true);
    });
  }
}
function stopCountdown(){
  if(state.countdownTimer){ clearInterval(state.countdownTimer); state.countdownTimer=null; }
  var bar=$('#countdownBar'); var label=$('#countdownLabel');
  if(bar) bar.classList.remove('active','danger');
  if(label) label.classList.remove('active');
  var wrap = $('#wrap');
  if(wrap) wrap.classList.remove('countdown-on');
}
function cleanupGameplayTimers(){
  stopCountdown();
}
function failCampaignLevel(msg){
  if(state.gameOver) return;
  state.gameOver=true;
  if(mutOn('fog')){
    state.fogReveal=true;
    renderBoardFromState();
    updateRowVisibility(false, true);
    updateStaticLockVisuals();
  }
  stopCountdown();
  toast(msg || 'Level failed.');
  updateTypingPreview();
  updateGuessLabel(true);
  saveSession();
  if(activeCampaign){
    var set=getCampaignSet(activeCampaign.setId);
    if(set){
      removeKey(campaignKey(set.id));
      setTimeout(function(){ showCampaignFail(set); }, 400);
    }
  }
}
function pauseCountdown(){
  if(state.countdownTimer){ clearInterval(state.countdownTimer); state.countdownTimer=null; }
}
function updateCountdownUI(){
  var bar=$('#countdownBar'); var label=$('#countdownLabel');
  if(!bar || !label) return;

  var pct = state.countdownMax>0 ? (state.countdownRemaining/state.countdownMax)*100 : 0;
  var pctVis = Math.min(100, Math.max(0, pct)); // âœ… cap visual fill to [0..100]

  var fill=bar.querySelector('.bar-fill');
  if(fill) fill.style.width=pctVis.toFixed(1)+'%';

  bar.classList.toggle('danger', pctVis<=25);
  label.textContent = Math.ceil(state.countdownRemaining)+'s';
}
function nudgeCountdownByKey(deltaKeys){
  if(!mutOn('countdown') || state.gameOver) return;
  if(typeof state.countdownRemaining !== 'number' || typeof state.countdownMax !== 'number') return;

  var centi = (state.mode==='campaign'
    ? state.campaignMutators.countdownKeyCenti
    : state.mutators.countdownKeyCenti) || 0;

  if(!centi) return;

  var delta = (deltaKeys * centi) / 10; // 0.1s units -> seconds
  state.countdownRemaining = Math.max(0, state.countdownRemaining + delta);
  updateCountdownUI();
}
function startCountdown(resume){
  stopCountdown();
  if(!mutOn('countdown') || state.gameOver) return;
  var sec = (state.mode==='campaign' ? state.campaignMutators.countdownSec : state.mutators.countdownSec) || 30;
  state.countdownMax=sec;
  var useResume = !!resume || (state.resumeCountdown && typeof state.countdownRemaining==='number');
  state.resumeCountdown=false;
  if(useResume && typeof state.countdownRemaining==='number'){
    state.countdownRemaining = clamp(state.countdownRemaining, 0, sec);
  } else {
    state.countdownRemaining=sec;
  }
  var bar=$('#countdownBar'); var label=$('#countdownLabel');
  if(bar) bar.classList.add('active');
  if(label) label.classList.add('active');
  var wrap = $('#wrap');
  if(wrap) wrap.classList.add('countdown-on');
  updateCountdownUI();
  state.countdownTimer=setInterval(function(){
    if(state.gameOver){ stopCountdown(); return; }
    state.countdownRemaining-=0.1;
    if(state.countdownRemaining<=0){
      state.countdownRemaining=0;
      stopCountdown();
      if(state.mode==='campaign'){
        failCampaignLevel('Time up!');
      }else{
        toast('Time up! Guess skipped.');
        skipGuess();
      }
      return;
    }
    updateCountdownUI();
  }, 100);
}
function skipGuess(){
  if(state.gameOver) return;
  var remaining = state.max - state.row - 1;
  if(remaining<=0){
    state.gameOver=true;
    if(mutOn('fog')){
      state.fogReveal=true;
      renderBoardFromState();
      updateRowVisibility(false, true);
      updateStaticLockVisuals();
    }
    if(state.mode==='campaign'){
      toast('Out of guesses.');
    }else{
      toast('Out of guesses. Answer: '+state.target);
    }
    saveSession();
    return;
  }
  var skippedRow = state.row;
  clearRow(skippedRow);
  setRowSkipped(skippedRow, true);
  state.row++;
  state.col=0;
  setRowSkipped(state.row, false);
  clearRow(state.row);
  updateRowVisibility(true);
  scheduleScrollToActiveRow();
  updateGuessLabel(true);
  saveSession();
  startCountdown(!!restore);
}

function updateGuessLabel(bump){
  if(!GUESS_LABEL) return;
  if(state.mode==='hotseat'){
    document.body.classList.remove('wildcard-on');
    GUESS_LABEL.textContent='';
    return;
  }
  document.body.classList.toggle('wildcard-on', mutOn('wildcard') && !state.wildcardUsed);
  if(mutOn('budget') && typeof state.budgetPoints==='number'){
    var pts=Math.max(0, state.budgetPoints);
    var gleft=Math.max(0, 20 - (state.row + (state.gameOver ? 1 : 0)));
    GUESS_LABEL.textContent = pts+' LETTER POINTS â€¢ '+gleft+' GUESSES LEFT';
    if(FRAME){ FRAME.classList.toggle('danger', pts<=10 && !state.gameOver); }
  }else{
    var used = state.row + (state.gameOver ? 1 : 0);
    var remaining = Math.max(0, state.max - used);
    GUESS_LABEL.textContent = remaining+' GUESS'+(remaining===1?'':'ES')+' LEFT';
    if(FRAME){
      var danger = (remaining===1 && !state.gameOver);
      FRAME.classList.toggle('danger', danger);
      if(danger){
        $$('.tile').forEach(function(t){
          var mag = 1 + Math.random();
          var sign = (Math.random()<0.5)?-1:1;
          t.style.setProperty('--tilt', (mag*sign).toFixed(2)+'deg');
        });
      }else{
        $$('.tile').forEach(function(t){ t.style.removeProperty('--tilt'); });
      }
    }
  }
  if(state.mode==='campaign' && !state.gameOver){
    GUESS_LABEL.textContent += ' â€¢ +1 COIN PER UNUSED GUESS';
  }
  if(mutOn('wildcard') && !state.gameOver && !state.wildcardUsed){
    GUESS_LABEL.textContent += state.wildcardArmed ? ' â€¢ WILDCARD ARMED (TAP TO DISARM)' : ' â€¢ TAP FOR WILDCARD (1 LETTER)';
  }
  if(mutOn('lifeline') && !state.gameOver){
    var left = lifelineEffectiveRemaining();
    if(left>0){ GUESS_LABEL.textContent += ' ? LIFELINE x'+left+' (DOUBLE-TAP)'; }
  }
  if(mutOn('copycat') && !state.gameOver && state.row>0){
    var ccGuess=(state.grid[state.row]||[]).join('');
    var ccPrev=copycatPreviewForGuess(ccGuess);
    if(ccPrev){ GUESS_LABEL.textContent += ' ? COPYCAT '+ccPrev.matched+'/'+ccPrev.required; }
  }
  if(mutOn('hotPotato') && !state.gameOver && state.row>0){
    var hpGuess=(state.grid[state.row]||[]).join('');
    var hp=hotPotatoProgressForGuess(hpGuess, state.row);
    if(hp && hp.required>0){
      var breakText = state.hotPotatoBreakUsed ? 'BREAK USED' : '1 BREAK READY';
      GUESS_LABEL.textContent += ' • HOT POTATO '+hp.changed+'/'+hp.required+' • '+breakText;
    }
  }
  if(mutOn('minDistance') && !state.gameOver && state.row>0){
    var mdGuess=(state.grid[state.row]||[]).join('');
    var md=minDistancePreviewForGuess(mdGuess);
    if(md && md.tracked>0){
      GUESS_LABEL.textContent += ' • MIN DIST '+md.total+'/'+md.required+' (TOP '+md.tracked+')';
    }
  }
  if(bump){
    GUESS_LABEL.classList.remove('bump');
    void GUESS_LABEL.offsetWidth;
    GUESS_LABEL.classList.add('bump');
  }
}
function playCampaignIntroAnimation(){
  if(state.mode!=='campaign') return;
  if(campaignIntroTimer){ clearTimeout(campaignIntroTimer); campaignIntroTimer=null; }
  var cols=Math.max(1, state.target.length || 1);
  var visibleMax=Math.min(state.max-1, state.row+1);
  var maxDelay=0;
  $$('.tile').forEach(function(tile){
    var r=parseInt(tile.getAttribute('data-row'),10);
    var c=parseInt(tile.getAttribute('data-col'),10);
    if(isNaN(r) || isNaN(c)) return;
    if(r<=visibleMax){
      var d=(r*cols + c)*0.045;
      tile.style.setProperty('--intro-delay', d.toFixed(2)+'s');
      if(d>maxDelay) maxDelay=d;
    }else{
      tile.style.removeProperty('--intro-delay');
    }
  });
  $$('#kbd .key').forEach(function(key,i){
    var d=0.12 + i*0.018;
    key.style.setProperty('--kbd-delay', d.toFixed(2)+'s');
    if(d>maxDelay) maxDelay=d;
  });
  document.body.classList.remove('campaign-intro');
  void document.body.offsetWidth;
  document.body.classList.add('campaign-intro');
  campaignIntroTimer=setTimeout(function(){
    document.body.classList.remove('campaign-intro');
    campaignIntroTimer=null;
  }, Math.round((maxDelay+1.1)*1000));
}
var scrollTimer=null;
var doubleVisionOverride=null;
function scrollToActiveRow(){
  if(!SCROLL.classList.contains('scroll')) return;
  var tile = document.querySelector('.tile[data-row=\"'+state.row+'\"][data-col=\"0\"]');
  if(!tile) return;
  var wrapRect = SCROLL.getBoundingClientRect();
  var tileRect = tile.getBoundingClientRect();
  var offset = tileRect.top - wrapRect.top + SCROLL.scrollTop;
  var centerOffset = (wrapRect.height - tileRect.height) / 2;
  var target = offset - centerOffset;
  var maxScroll = Math.max(0, SCROLL.scrollHeight - SCROLL.clientHeight);
  if(target < 0) target = 0;
  if(target > maxScroll) target = maxScroll;
  if(typeof SCROLL.scrollTo === 'function'){
    SCROLL.scrollTo({top: target, behavior:'smooth'});
  }else{
    SCROLL.scrollTop = target;
  }
}
function scheduleScrollToActiveRow(){
  if(scrollTimer) return;
  scrollTimer = requestAnimationFrame(function(){
    scrollTimer=null;
    scrollToActiveRow();
  });
}
function layoutBoard(){
  var cols=state.target.length, rows=state.max, gap=8;
  var availW=SCROLL.clientWidth-(cols-1)*gap-4;
  var size=Math.floor(availW/cols);
  if(size>75){size=75}
  if(size<MIN_TILE){size=MIN_TILE}
  var visibleRows=Math.min(state.max, state.row+2);
  var boardH=(visibleRows*size+(visibleRows-1)*gap);
  if(boardH>SCROLL.clientHeight){ SCROLL.classList.add('scroll'); } else { SCROLL.classList.remove('scroll'); }
  SCROLL.classList.toggle('centered', !SCROLL.classList.contains('scroll'));
  if(FRAME){
    if(FRAME.clientHeight<200){ document.body.classList.add('tight-board'); }
    else{ document.body.classList.remove('tight-board'); }
  }
  BOARD.style.setProperty('--tile', size+'px');
  BOARD.style.gridTemplateColumns='repeat('+cols+', '+size+'px)';
  BOARD.style.gridTemplateRows='repeat('+rows+', '+size+'px)';
  BOARD.style.height=boardH+'px';
  var maxScroll=Math.max(0, SCROLL.scrollHeight - SCROLL.clientHeight);
  if(SCROLL.scrollTop>maxScroll) SCROLL.scrollTop=maxScroll;
}
function updateRowVisibility(animate, forceReveal){
  var newVisible=Math.min(state.max-1, state.row+1);
  for(var r=0;r<state.max;r++){
    var visible=(r<=newVisible);
    var fogOn=mutOn('fog') && !forceReveal && !state.fogReveal;
    for(var c=0;c<state.target.length;c++){
      var tile=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c+'\"]');
      if(!tile) continue;
      tile.classList.toggle('hidden', !visible);
      var fogged = fogOn && !forceReveal && visible && r<(state.row-1);
      tile.classList.toggle('fogged', fogged);
      if(fogged){
        tile.classList.remove('near','correct','dir','grayed','locked','noisy','wildcard','decoy-red','double-shadow');
        var s = tile.querySelector('.tile-letter');
        if(s) s.textContent='';
        tile.removeAttribute('data-dir');
        tile.style.background='';
        tile.style.borderColor='';
      }
      if(visible && animate && r>lastVisibleRow){
        tile.classList.remove('appear');
        void tile.offsetWidth;
        tile.classList.add('appear');
        (function(t){setTimeout(function(){t.classList.remove('appear')},750)})(tile);
      }
    }
  }
  lastVisibleRow=newVisible;
  layoutBoard();
}
function buildBoard(restore){
  clearKbdHints();
  doubleVisionOverride=null;
  BOARD.innerHTML='';
  if(!restore){
    state.grid=[]; state.hints=[]; state.row=0; state.col=0; state.statuses={}; state.gameOver=false; state.replaceMode=false;
    state.exacts=[];
    state.doubleVision={};
    state.bloodMirage={};
    state.staticLock=null;
    state.wildcardUsed=false;
    state.wildcardArmed=false;
    var bpInit = (state.mode==='campaign' ? state.campaignMutators.budgetPoints : state.mutators.budgetPoints);
    state.budgetPoints = mutOn('budget') ? clampBudget(bpInit) : null;
    state.guessHistory=[];
    state.fogReveal=false;
    state.hintsRaw=[];
    state.lifelineRemaining = mutOn('lifeline') ? clampLifeCount((state.mode==='campaign' ? state.campaignMutators.lifelineCount : state.mutators.lifelineCount)) : null;
    state.lifelineUsedThisLevel=0;
    state.hotPotatoBreakUsed=false;
  }
  lastVisibleRow=-1;
  for(var r=0;r<state.max;r++){
    var row=restore ? (state.grid[r] || []) : [];
    var hintRow=restore ? (state.hints[r] || []) : [];
    for(var c=0;c<state.target.length;c++){
      var t=document.createElement('div'); t.className='tile'; t.setAttribute('data-row',r); t.setAttribute('data-col',c);
      var s=document.createElement('span'); s.className='tile-letter'; t.appendChild(s);
      var n=document.createElement('span'); n.className='tile-note'; t.appendChild(n);
      BOARD.appendChild(t);
      if(!restore){
        row.push(''); hintRow.push(null);
      }else{
        if(typeof row[c]==='undefined') row[c]='';
        if(typeof hintRow[c]==='undefined') hintRow[c]=null;
      }
    }
    state.grid[r]=row; state.hints[r]=hintRow;
  }
  if(restore) renderBoardFromState();
  layoutBoard(); updateKeyboard();
  updateTypingPreview();
  updateGuessLabel(false);
  updateCampaignProgress();
  updateRowVisibility(false);
  if(state.mode==='hotseat'){
    hotseatPrefillGreens(state.row);
    updateHotseatUI();
    updateHotseatOwnershipVisuals();
  }
  if(mutOn('lifeline') && typeof state.lifelineRemaining!=='number'){
    var cnt = (state.mode==='campaign' ? state.campaignMutators.lifelineCount : state.mutators.lifelineCount);
    state.lifelineRemaining=clampLifeCount(cnt);
  }
  if(typeof state.lifelineUsedThisLevel!=='number'){ state.lifelineUsedThisLevel=0; }
  if(restore && mutOn('budget') && typeof state.budgetPoints!=='number'){
    var bpInit = (state.mode==='campaign' ? state.campaignMutators.budgetPoints : state.mutators.budgetPoints);
    state.budgetPoints=clampBudget(bpInit);
  }
  updateStaticLockVisuals();
  if(isStaticLockActive(state.row)) applyStaticLockToRow(state.row);
  if(mutOn('randomKeyboard')) randomizeKeyboardLayout();
  if(!restore) saveSession();
  if(!state.pendingCampaignTimeout){
    startCountdown(!!restore);
  }
}
function addRows(n){
  if(n<=0) return;
  for(var r=state.max; r<state.max+n; r++){
    var row=[]; var hintRow=[];
    for(var c=0;c<state.target.length;c++){
      var t=document.createElement('div'); t.className='tile'; t.setAttribute('data-row',r); t.setAttribute('data-col',c);
      var s=document.createElement('span'); s.className='tile-letter'; t.appendChild(s);
      var n=document.createElement('span'); n.className='tile-note'; t.appendChild(n);
      BOARD.appendChild(t);
      row.push(''); hintRow.push(null);
    }
    state.grid[r]=row; state.hints[r]=hintRow;
  }
  state.max+=n;
  layoutBoard();
}
window.addEventListener('resize',function(){document.documentElement.style.setProperty('--vh', window.innerHeight+'px'); layoutBoard();});

function rows(){return ['QWERTYUIOP'.split(''),'ASDFGHJKL'.split(''),['ENTER'].concat('ZXCVBNM'.split('')).concat(['âŒ«'])]}
var KBD_LETTER_BTNS=[];
function shuffleArray(a){
  for(var i=a.length-1;i>0;i--){
    var j=(Math.random()*(i+1))|0;
    var t=a[i]; a[i]=a[j]; a[j]=t;
  }
  return a;
}
function cacheLetterButtons(){
  KBD_LETTER_BTNS=[].slice.call(KBD.querySelectorAll('.key[data-key]')).filter(function(b){
    var k=b.getAttribute('data-key') || '';
    return k.length===1 && k>='A' && k<='Z';
  });
}
function randomizeKeyboardLayout(){
  if(!mutOn('randomKeyboard')) return;
  if(!KBD_LETTER_BTNS.length) cacheLetterButtons();
  var letters=shuffleArray(ALPHA.slice());
  for(var i=0;i<KBD_LETTER_BTNS.length;i++){
    var b=KBD_LETTER_BTNS[i];
    var ch=letters[i];
    b.setAttribute('data-key', ch);
    b.textContent=ch;
  }
}
function resetKeyboardLayout(){
  if(!KBD_LETTER_BTNS.length) cacheLetterButtons();
  for(var i=0;i<KBD_LETTER_BTNS.length;i++){
    var b=KBD_LETTER_BTNS[i];
    var ch=b.getAttribute('data-default') || b.getAttribute('data-key');
    if(!ch) continue;
    b.setAttribute('data-key', ch);
    b.textContent=ch;
  }
}
function buildKeyboard(){
  KBD.innerHTML='';
  rows().forEach(function(r){
    var div=document.createElement('div');div.className='krow';
    r.forEach(function(k){
      var b=document.createElement('button');
      b.className='key'+(k.length>1?' wide':''); b.textContent=(k==='âŒ«'?'âŒ«':(k==='ENTER'?'GO':k)); b.setAttribute('data-key',k);
      if(k.length===1 && k>='A' && k<='Z'){ b.setAttribute('data-default', k); }
      div.appendChild(b);
    });
    KBD.appendChild(div);
  });
  cacheLetterButtons();
  if(mutOn('randomKeyboard')) randomizeKeyboardLayout();
  else resetKeyboardLayout();
  var lastKey='', lastAt=0;
  var swipeActive=false, swipeMoved=false, swipeSeq=[], swipeLastKey='', swipeStart=null, swipePointerId=null;
  var swipePoints=[], swipeNeedsInit=true;
  var swipeThreshold=14;

  function keyFromPoint(cx,cy){
    var el=document.elementFromPoint(cx,cy);
    var hit=(el && el.closest) ? el.closest('.key') : null;
    if(hit) return hit;
    var rowsEls=[].slice.call(KBD.querySelectorAll('.krow'));
    if(!rowsEls.length) return null;
    var row=rowsEls[0], bestDy=1e9;
    rowsEls.forEach(function(r){
      var rr=r.getBoundingClientRect();var mcy=(rr.top+rr.bottom)/2;var dy=Math.abs(cy-mcy);if(dy<bestDy){bestDy=dy;row=r}
    });
    var keys=[].slice.call(row.querySelectorAll('.key')); var best=null, bestDx=1e9;
    keys.forEach(function(k){
      var kr=k.getBoundingClientRect();var mcx=(kr.left+kr.right)/2;var dx=Math.abs(cx-mcx);if(dx<bestDx){bestDx=dx;best=k}
    });
    return best;
  }
  function addSwipeKey(key){
    if(!key || key.length!==1) return;
    if(swipeSeq.length && swipeSeq[swipeSeq.length-1]===key) return;
    swipeSeq.push(key);
  }
  function resetSwipeTrace(){
    swipePoints=[];
    if(SWIPE_TRACE){ SWIPE_TRACE.classList.remove('active'); var ctx=SWIPE_TRACE.getContext('2d'); ctx.clearRect(0,0,SWIPE_TRACE.width,SWIPE_TRACE.height); }
  }
  function drawSwipeTrace(){
    if(!SWIPE_TRACE || swipePoints.length<2) return;
    var rect=KBD.getBoundingClientRect();
    var paneRect=KBD.parentElement.getBoundingClientRect();
    var left=Math.floor(rect.left - paneRect.left);
    var top=Math.floor(rect.top - paneRect.top);
    var w=Math.floor(rect.width), h=Math.floor(rect.height);
    if(SWIPE_TRACE.style.left!==left+'px' || SWIPE_TRACE.style.top!==top+'px'){
      SWIPE_TRACE.style.left=left+'px';
      SWIPE_TRACE.style.top=top+'px';
    }
    if(SWIPE_TRACE.width!==w || SWIPE_TRACE.height!==h){
      SWIPE_TRACE.width=w;
      SWIPE_TRACE.height=h;
    }
    var ctx=SWIPE_TRACE.getContext('2d');
    ctx.clearRect(0,0,SWIPE_TRACE.width,SWIPE_TRACE.height);
    ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.strokeStyle='rgba(72, 168, 255, .6)';
    ctx.lineWidth=8;
    ctx.beginPath();
    for(var i=0;i<swipePoints.length;i++){
      var p=swipePoints[i];
      if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();
  }

  KBD.addEventListener('pointerdown', function(ev){
    if(inForm(ev.target)) return;
    var cx = (typeof ev.clientX==='number') ? ev.clientX : 0;
    var cy = (typeof ev.clientY==='number') ? ev.clientY : 0;
    var hit = keyFromPoint(cx,cy);
    if(!hit) return;
    ev.preventDefault(); ev.stopPropagation();
    swipeActive=true; swipeMoved=false; swipeSeq=[]; swipeLastKey=''; swipeStart={x:cx,y:cy}; swipePointerId=ev.pointerId;
    swipeNeedsInit=true;
    resetSwipeTrace();
    if(KBD.setPointerCapture) KBD.setPointerCapture(ev.pointerId);
    var key = hit.getAttribute('data-key');
    swipeLastKey=key || '';
    addSwipeKey(swipeLastKey);
  }, {capture:true, passive:false});

  KBD.addEventListener('pointermove', function(ev){
    if(!swipeActive || (swipePointerId!==null && ev.pointerId!==swipePointerId)) return;
    var cx = (typeof ev.clientX==='number') ? ev.clientX : 0;
    var cy = (typeof ev.clientY==='number') ? ev.clientY : 0;
    if(swipeStart){
      var dx=cx-swipeStart.x, dy=cy-swipeStart.y;
      if(Math.hypot(dx,dy)>swipeThreshold) swipeMoved=true;
    }
    if(swipeMoved){
      if(swipeNeedsInit){
        swipeNeedsInit=false;
        if(SWIPE_TRACE) SWIPE_TRACE.classList.add('active');
        var r0=KBD.getBoundingClientRect();
        swipePoints.push({x:swipeStart.x-r0.left, y:swipeStart.y-r0.top});
      }
      var r2=KBD.getBoundingClientRect();
      swipePoints.push({x:cx-r2.left, y:cy-r2.top});
      drawSwipeTrace();
    }
    var hit = keyFromPoint(cx,cy);
    if(!hit) return;
    var key = hit.getAttribute('data-key');
    if(!key || key===swipeLastKey) return;
    swipeLastKey=key;
    if(swipeMoved){ addSwipeKey(key); }
  }, {capture:true, passive:false});

  function endSwipe(ev){
    if(!swipeActive) return;
    if(KBD.releasePointerCapture && swipePointerId!==null){
      try{KBD.releasePointerCapture(swipePointerId)}catch(e){}
    }
    swipeActive=false; swipePointerId=null;
    if(!swipeMoved){
      if(swipeLastKey){
        var now=performance.now();
        if(!(swipeLastKey===lastKey && now-lastAt<85)){
          lastKey=swipeLastKey; lastAt=now;
          var btn=KBD.querySelector('.key[data-key="'+swipeLastKey+'"]');
          if(btn){ btn.classList.add('active-sim'); setTimeout(function(){btn.classList.remove('active-sim')},100); }
          onKey(swipeLastKey);
        }
      }
    }else{
      setSwipeSuggestions(swipeSeq);
    }
    swipeSeq=[]; swipeLastKey=''; swipeStart=null;
    resetSwipeTrace();
  }
  KBD.addEventListener('pointerup', endSwipe, {capture:true});
  KBD.addEventListener('pointercancel', endSwipe, {capture:true});
}
function updateKeyboard(){
  $$('.key').forEach(function(k){ k.classList.remove('correct','near'); });
}
function clearSwipeSuggestions(){
  if(!SWIPE_BAR) return;
  SWIPE_BAR.classList.add('hidden');
  SWIPE_BTNS.forEach(function(b){ b.textContent=''; b.setAttribute('data-word',''); });
}
function lcsScore(a,b){
  var n=a.length, m=b.length;
  var dp=new Array(m+1);
  for(var j=0;j<=m;j++) dp[j]=0;
  for(var i=1;i<=n;i++){
    var prev=0;
    for(var j2=1;j2<=m;j2++){
      var temp=dp[j2];
      if(a[i-1]===b[j2-1]) dp[j2]=prev+1;
      else dp[j2]=Math.max(dp[j2], dp[j2-1]);
      prev=temp;
    }
  }
  return dp[m];
}
function swipeCandidates(seq){
  var L=state.target.length;
  var pool=[];
  if(state.dictLen.get(L)){ pool=Array.from(state.dictLen.get(L)); }
  else{ pool=seed.filter(function(w){ return w.length===L; }); }
  if(isStaticLockActive(state.row) && state.staticLock){
    var lc=lockedCol();
    var ll=state.staticLock.letter;
    if(lc>=0 && ll){
      var lockedPool=[];
      for(var p=0;p<pool.length;p++){
        var w0=pool[p];
        if(w0[lc]===ll) lockedPool.push(w0);
      }
      pool=lockedPool;
    }
  }
  if(!pool.length) return [];
  var first=seq[0], last=seq[seq.length-1];
  var filtered=[];
  for(var i=0;i<pool.length;i++){
    var w=pool[i];
    if(w[0]===first && w[w.length-1]===last) filtered.push(w);
  }
  var base=(filtered.length>=3) ? filtered : pool;
  if(base.length>6000) base=base.slice(0,6000);
  var scored=[];
  for(var k=0;k<base.length;k++){
    var w2=base[k];
    var score=lcsScore(seq, w2)*2 - Math.abs(seq.length-w2.length);
    scored.push({w:w2, s:score});
  }
  scored.sort(function(a,b){ return b.s-a.s; });
  var out=[];
  for(var t=0;t<scored.length && out.length<3;t++){
    if(out.indexOf(scored[t].w)===-1) out.push(scored[t].w);
  }
  return out;
}
function setSwipeSuggestions(seq){
  if(state.mode==='hotseat'){ clearSwipeSuggestions(); return; }
  if(state.gameOver || !seq || seq.length<3){ clearSwipeSuggestions(); return; }
  var words=swipeCandidates(seq);
  if(!words.length){ clearSwipeSuggestions(); return; }
  SWIPE_BAR.classList.remove('hidden');
  SWIPE_BTNS.forEach(function(b,i){
    var w=words[i] || '';
    b.textContent=w;
    b.setAttribute('data-word', w);
  });
}
function applySuggestion(word){
  if(state.mode==='hotseat') return;
  if(state.gameOver) return;
  word=lettersOnlyUpper(word);
  if(!word || word.length!==state.target.length) return;
  clearRow(state.row);
  for(var i=0;i<word.length;i++){
    if(isStaticLockActive(state.row) && i===lockedCol()) continue;
    setTile(state.row,i,word[i]);
  }
  state.col=word.length;
  updateTypingPreview();
  saveSession();
}
SWIPE_BTNS.forEach(function(b){
  b.addEventListener('click', function(){
    var w=b.getAttribute('data-word');
    if(!w) return;
    applySuggestion(w);
  });
});
function clearKbdHints(){
  KBD.classList.remove('kbd-hints-on');
  $$('.key[data-key]').forEach(function(k){ k.classList.remove('cand','nocand') });
  state.kbdHintsOn=false;
  updateTypingPreview();
}
document.addEventListener('keydown',function(e){
  if(inForm(e.target)) return;
  if(e.repeat) return;
  if(state.mode==='menu') return;
  var k=e.key;
  if(k==='Backspace') k='âŒ«';
  if(k==='NumpadEnter' || k==='Return' || e.keyCode===13) k='ENTER';
  if(k.length===1) k=k.toUpperCase();
  if(k==='ENTER'||k==='âŒ«'||(k.length===1&&k>='A'&&k<='Z')){
    e.preventDefault(); e.stopPropagation(); clearKbdHints(); onKey(k);
  }
});
document.addEventListener('click', function(e){
  var tile = (e.target.closest && e.target.closest('.tile')) ? e.target.closest('.tile') : null;
  if(state.mode==='hotseat' && tile){
    var r = parseInt(tile.getAttribute('data-row'),10);
    var c = parseInt(tile.getAttribute('data-col'),10);
    if(r===state.row){
      var cols=hotseatEditableCols();
      if(cols.indexOf(c)!==-1){
        hotseatSetCursor(c);
        return;
      }
    }
  }
  if(!tile) clearKbdHints();
});

function setTile(r,c,ch){
  if(!state.grid || !Array.isArray(state.grid[r])) return;
  state.grid[r][c]=ch;
  var t = document.querySelector('.tile[data-row="'+r+'"][data-col="'+c+'"]');
  var s = t ? t.querySelector('.tile-letter') : null;
  if(s) s.textContent = ch || '';
  if(!ch && t) t.removeAttribute('data-dir');
}
function isStaticLockActive(row){
  return mutOn('staticTile') && state.staticLock && row>0 && row<=state.staticLock.untilRow;
}
function lockedCol(){
  return (state.staticLock && typeof state.staticLock.col==='number') ? state.staticLock.col : -1;
}
function applyStaticLockToRow(row){
  if(state.gameOver) return;
  if(row<0 || row>=state.max) return;
  if(!isStaticLockActive(row)) return;
  var col=lockedCol();
  if(col<0 || col>=state.target.length) return;
  setTile(row, col, state.staticLock.letter);
  var t = document.querySelector('.tile[data-row=\"'+row+'\"][data-col=\"'+col+'\"]');
  if(t) t.classList.add('locked');
}
function skipLockedForward(){
  while(isStaticLockActive(state.row) && state.col===lockedCol()){
    applyStaticLockToRow(state.row);
    state.col++;
  }
}
function skipLockedBackward(){
  while(isStaticLockActive(state.row) && state.col>0 && state.col-1===lockedCol()){
    state.col--;
  }
}
function clearRow(r){
  var lockActive=isStaticLockActive(r);
  for(var c=0;c<state.target.length;c++){
    if(lockActive && c===lockedCol()) continue;
    setTile(r,c,'');
  }
  state.col=0;
  if(lockActive) skipLockedForward();
}
function currentTiles(){
  var arr=[]; for(var c=0;c<state.target.length;c++){
    arr.push(document.querySelector('.tile[data-row=\"'+state.row+'\"][data-col=\"'+c+'\"]'));
  } return arr;
}
function onKeyHotseat(key){
  if(state.gameOver) return;
  if(PASS_OVERLAY && PASS_OVERLAY.classList.contains('open')){ hidePassOverlay(); return; }
  var hs=state.hotseat; if(!hs) return;
  clearSwipeSuggestions();
  if(key==='ENTER'){
    if(!hotseatTurnComplete()){ shake(); toast('Fill your tiles'); return; }
    if(hs.turn===HS_RED){
      hotseatSetupTurn(HS_BLUE);
      showPassOverlay(hsShort(HS_BLUE));
      return;
    }
    if(!hotseatRowComplete()){ shake(); toast('Not enough letters'); return; }
    state.col=state.target.length;
    return submitRow(false);
  }
  if(key==='âŒ«' || key==='Ã¢Å’Â«'){
    var cols=hotseatEditableCols();
    if(!cols.length) return;
    hotseatEnsureCursor();
    var idx=cols.indexOf(hs.cursorCol);
    var prevCol=cols[(idx-1+cols.length)%cols.length];
    hs.cursorCol=prevCol;
    state.col=prevCol;
    setTile(state.row, prevCol, '');
    updateHotseatOwnershipVisuals();
    saveSession();
    return;
  }
  if(key.length===1){
    var cols2=hotseatEditableCols();
    if(!cols2.length) return;
    hotseatEnsureCursor();
    var col=hs.cursorCol;
    setTile(state.row, col, key);
    var idx2=cols2.indexOf(col);
    hs.cursorCol=cols2[(idx2+1)%cols2.length];
    state.col=hs.cursorCol;
    updateHotseatOwnershipVisuals();
    saveSession();
  }
}
function onKey(key){
  if(state.gameOver) return;
  if(state.mode!=='sandbox' && state.mode!=='campaign' && state.mode!=='hotseat') return;
  if(!state.grid || !Array.isArray(state.grid[state.row])) return;
  if(state.mode==='hotseat'){ return onKeyHotseat(key); }
  clearSwipeSuggestions();
  skipLockedForward();
  if(key==='ENTER'){return submitRow(false)}
    if(key==='âŒ«'){
    var didErase=false;
    if(state.col>0){
      skipLockedBackward();
      if(state.col>0){
        state.col--;
        if(!(isStaticLockActive(state.row) && state.col===lockedCol())){
          setTile(state.row,state.col,'');
          didErase=true;
        }
      }
    }
    if(didErase) nudgeCountdownByKey(-1);
    state.replaceMode=false; updateTypingPreview(); saveSession(); return
  }
  if(key.length===1){
    if(state.replaceMode){ clearRow(state.row); state.replaceMode=false; }
    skipLockedForward();
    var didType=false;
    if(state.col<state.target.length){
      setTile(state.row,state.col,key);
      state.col++;
      didType=true;
    }
    if(didType) nudgeCountdownByKey(+1);
    skipLockedForward();
  }
  updateTypingPreview();
  scheduleScrollToActiveRow();
  saveSession();
}
function shake(){ currentTiles().forEach(function(t){t.classList.add('shake'); setTimeout(function(){t.classList.remove('shake')},420)}) }

function effectiveDifficulty(d){ return (d==='beginner') ? 'normal' : (d||'normal'); }

function difficultyPolicy(dist, dir){
  if(state.mode==='hotseat'){
    return {showArrow:false, showNumber:false, grayed:false};
  }
  var d = effectiveDifficulty(state.difficulty);
  var res = {showArrow:false, showNumber:false, grayed:false};
  if(d==='easy'){
    res.showArrow = true;
    if(dist<=3) res.showNumber = true;
  }else if(d==='normal'){
    res.showArrow = true;
  }else if(d==='hard'){
    res.showArrow = true;
  }else if(d==='insane'){
    if(dist>9) res.grayed=true; else res.showArrow = (dist<=3);
  }else if(d==='impossible'){
    if(dist>3) res.grayed=true; else res.showArrow = false;
  }
  return res;
}

function shiftBack(ch){
  if(!ch) return ch;
  if(ch==='A') return 'Z';
  var code=ch.charCodeAt(0);
  if(code>=66 && code<=90) return String.fromCharCode(code-1);
  return ch;
}
function recomputeStatuses(){
  state.statuses={};
  var pri={near:1,correct:2};
  for(var r=0;r<state.hints.length;r++){
    for(var c=0;c<state.target.length;c++){
      var info=state.hints[r] ? state.hints[r][c] : null;
      var ch=state.grid[r] ? state.grid[r][c] : '';
      if(isDoubleVisionMask(r,c)) continue;
      if(!info || info.hidden || !ch) continue;
      var st=''; if(info.exact) st='correct'; else if(!info.grayed) st='near';
      var prev=state.statuses[ch]; if(st && (!prev || pri[st]>(pri[prev]||0))) state.statuses[ch]=st;
    }
  }
  updateKeyboard();
}
function lifelineRevealCap(){
  var len=Math.max(1, state.target.length || 0);
  return Math.max(2, Math.floor(len/2));
}
function lifelineEffectiveRemaining(){
  var raw=(typeof state.lifelineRemaining==='number') ? state.lifelineRemaining : 0;
  var used=safeInt(state.lifelineUsedThisLevel,0);
  return Math.max(0, Math.min(raw, lifelineRevealCap()-used));
}
function lifelineReveal(r,c){
  if(!mutOn('lifeline')) return false;
  if(typeof state.lifelineRemaining!=='number'){
    var baseCnt = (state.mode==='campaign' ? state.campaignMutators.lifelineCount : state.mutators.lifelineCount);
    state.lifelineRemaining=clampLifeCount(baseCnt);
  }
  if(typeof state.lifelineUsedThisLevel!=='number') state.lifelineUsedThisLevel=0;
  if(state.lifelineRemaining<=0) return false;
  if(state.lifelineUsedThisLevel>=lifelineRevealCap()) return false;
  var hint = state.hints[r] ? state.hints[r][c] : null;
  if(!hint || hint.hidden || hint.exact) return false;
  if(hint.showNumber) return false;
  hint.showNumber=true;
  state.lifelineRemaining--;
  state.lifelineUsedThisLevel++;
  renderBoardFromState();
  updateRowVisibility(false);
  updateStaticLockVisuals();
  saveSession();
  return true;
}
window.__wordshift_lifelineReveal = lifelineReveal;
function updateStaticLockVisuals(){
  if(!mutOn('staticTile') || !state.staticLock) return;
  for(var r=0;r<=state.staticLock.untilRow;r++){
    var t=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+state.staticLock.col+'\"]');
    if(t) t.classList.add('locked');
  }
}
function mirrorRowData(r){
  var cols=state.target.length;
  var newHints=new Array(cols);
  if(state.hintsRaw && state.hintsRaw[r] && state.hintsRaw[r].length){
    var raw=state.hintsRaw[r];
    var mirrored=state.hints[r];
    var overlay=document.createElement('div');
    overlay.className='hint-overlay';
    var boardRect=BOARD.getBoundingClientRect();
    for(var c=0;c<cols;c++){
      var tile=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c+'\"]');
      if(!tile) continue;
      tile.classList.add('mirror-base');
      tile.classList.remove('near','correct','dir','grayed');
      tile.removeAttribute('data-dir');
      tile.style.background=''; tile.style.borderColor='';
      var srcRect=tile.getBoundingClientRect();
      var targetCol=cols-1-c;
      var targetTile=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+targetCol+'\"]');
      if(!targetTile) continue;
      var tgtRect=targetTile.getBoundingClientRect();
      var ghost=document.createElement('div');
      ghost.className='tile';
      ghost.style.width=srcRect.width+'px';
      ghost.style.height=srcRect.height+'px';
      ghost.style.left=(srcRect.left-boardRect.left)+'px';
      ghost.style.top=(srcRect.top-boardRect.top)+'px';
      var gs=document.createElement('span');
      gs.className='tile-letter';
      ghost.appendChild(gs);
      var hint=mirrored[c];
      if(hint){
        applyTileVisual(ghost, '', hint, difficultyPolicy(hint.dist, hint.dir));
      }
      overlay.appendChild(ghost);
      ghost._dx=(tgtRect.left-srcRect.left);
      ghost._dy=(tgtRect.top-srcRect.top);
    }
    BOARD.appendChild(overlay);
    requestAnimationFrame(function(){
      var nodes=overlay.querySelectorAll('.tile');
      nodes.forEach(function(n){
        n.style.transform='translate('+n._dx+'px,'+n._dy+'px)';
      });
    });
    setTimeout(function(){
      if(overlay && overlay.parentNode){ overlay.parentNode.removeChild(overlay); }
      for(var c2=0;c2<cols;c2++){
        var t2=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c2+'\"]');
        if(t2){ t2.classList.remove('mirror-base'); }
      }
      state.hints[r]=raw;
      state.hintsRaw[r]=null;
      renderBoardFromState();
      updateRowVisibility(false);
      updateStaticLockVisuals();
    }, 720);
    return;
  }
  for(var i=0;i<cols;i++){
    newHints[cols-1-i]=state.hints[r] ? state.hints[r][i] : null;
  }
  state.hints[r]=newHints;
  renderBoardFromState();
  updateRowVisibility(false);
  updateStaticLockVisuals();
  for(var c=0;c<cols;c++){
    var tile=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c+'\"]');
    if(tile){ tile.classList.add('mirror-pop'); }
  }
  setTimeout(function(){
    for(var c2=0;c2<cols;c2++){
      var t2=document.querySelector('.tile[data-row=\"'+r+'\"][data-col=\"'+c2+'\"]');
      if(t2){ t2.classList.remove('mirror-pop'); }
    }
  }, 450);
}
function applyDrift(){
  for(var r=0;r<state.row;r++){
    for(var c=0;c<state.target.length;c++){
      if(state.grid[r] && state.grid[r][c]){
        state.grid[r][c]=shiftBack(state.grid[r][c]);
      }
      var hint=state.hints[r] ? state.hints[r][c] : null;
      if(!hint || hint.hidden) continue;
      var g=state.grid[r][c], t=state.target[c];
      var exact=(g===t);
      var dir=exact ? 0 : (aIdx(t) > aIdx(g) ? +1 : -1);
      var dist=exact ? 0 : Math.abs(aIdx(t)-aIdx(g));
      var pol=difficultyPolicy(dist, dir);
      var keepLife = mutOn('lifeline') && hint.showNumber;
      hint.exact=exact; hint.dist=dist; hint.dir=dir;
      hint.grayed=pol.grayed; hint.showArrow=pol.showArrow;
      hint.showNumber=(effectiveDifficulty(state.difficulty)==='easy' && dist<=3) || keepLife;
      if(mutOn('noisyArrows') && dist>3 && hint.showArrow && Math.random()<0.33){
        hint.noisyArrow=(Math.random()<0.5)?'â–²':'â–¼';
      }else{
        delete hint.noisyArrow;
      }
    }
  }
  renderBoardFromState();
  updateRowVisibility(false);
  updateStaticLockVisuals();
  recomputeStatuses();
}

function candidatesFromHintForColumn(r,c){
  var hint = state.hints[r] ? state.hints[r][c] : null;
  var guessCh = state.grid[r] ? state.grid[r][c] : '';
  if(isDoubleVisionMask(r,c)) return null;
  if(!hint || hint.hidden || !guessCh) return null;
  if(hint.noisyArrow) return null;
  if(hint.exact) return new Set([guessCh]);
  if(hint.showNumber){
    var gi0=aIdx(guessCh);
    var dir0=hint.dir>0 ? +1 : -1;
    return new Set([idxToChar(gi0 + dir0*hint.dist)]);
  }
  var gi=aIdx(guessCh);
  var S=new Set();
  if(hint.grayed){
    if(effectiveDifficulty(state.difficulty)==='impossible'){
      for(var i=0;i<26;i++){ if(Math.abs(i-gi)>=4) S.add(idxToChar(i)); }
    }else if(hint.showArrow){
      var dirG = hint.dir>0 ? +1 : -1;
      var startG = (effectiveDifficulty(state.difficulty)==='normal') ? 14 : 10;
      for(var dG=startG; dG<=25; dG++){ var iG=gi+dirG*dG; if(iG>=0&&iG<26) S.add(idxToChar(iG)); }
    }else{
      for(var i2=0;i2<26;i2++){ if(Math.abs(i2-gi)>=10) S.add(idxToChar(i2)); }
    }
    return S;
  }
  var dir = hint.dir>0 ? +1 : -1;
  var dname = effectiveDifficulty(state.difficulty);
  if(dname==='easy'){
    if(hint.dist<=3){ S.add(idxToChar(gi + dir*hint.dist)); }
    else{ for(var d=1; d<=25; d++){ var i=gi+dir*d; if(i>=0&&i<26) S.add(idxToChar(i)); } }
  }else if(dname==='normal'){
    for(var d1=1; d1<=25; d1++){ var i1=gi+dir*d1; if(i1>=0&&i1<26) S.add(idxToChar(i1)); }
  }else if(dname==='hard'){
    for(var d2=1; d2<=25; d2++){ var i2=gi+dir*d2; if(i2>=0&&i2<26) S.add(idxToChar(i2)); }
  }else if(dname==='insane'){
    if(hint.showArrow){
      for(var d3=1; d3<=3; d3++){ var i3=gi+dir*d3; if(i3>=0&&i3<26) S.add(idxToChar(i3)); }
    }else{
      for(var d4=4; d4<=9; d4++){ if(gi+d4<26) S.add(idxToChar(gi+d4)); if(gi-d4>=0) S.add(idxToChar(gi-d4)); }
    }
  }else if(dname==='impossible'){
    for(var d5=1; d5<=3; d5++){ if(gi+d5<26) S.add(idxToChar(gi+d5)); if(gi-d5>=0) S.add(idxToChar(gi-d5)); }
  }
  return S;
}
function combinedCandidatesForColumn(c,lastRow){
  var combined=null;
  for(var r=0; r<=lastRow; r++){
    var hint = state.hints[r] ? state.hints[r][c] : null;
    if(!hint) continue;
    if(isDoubleVisionMask(r,c)) continue;
    if(hint.hidden) continue;
    if(hint.noisyArrow) continue;
    if(mutOn('fog') && r!==lastRow) continue;
    var dname = effectiveDifficulty(state.difficulty);
    var hasInfo = hint.exact || hint.grayed || hint.showArrow || hint.showNumber || (dname==='insane' && !hint.grayed) || (dname==='impossible' && !hint.grayed);
    if(!hasInfo) continue;
    var set=candidatesFromHintForColumn(r,c);
    if(set && set.size){
      if(!combined){ combined=set; }
      else{
        var next=new Set(); combined.forEach(function(x){ if(set.has(x)) next.add(x) });
        combined=next;
      }
    }
  }
  return combined;
}
function clearTypingTileIndicators(){
  $$('.tile').forEach(function(t){
    t.classList.remove('budget-focus','min-distance-fit','min-distance-ready','copycat-linked','copycat-ready');
    var n=t.querySelector('.tile-note');
    if(n) n.textContent='';
  });
}
function budgetCostForGuess(guess){
  var out={cost:0,maxCol:-1,deltas:[]};
  if(!mutOn('budget')) return out;
  if(!state.guessHistory || !state.guessHistory.length) return out;
  guess=(guess||'')+'';
  var prev=state.guessHistory[state.guessHistory.length-1] || '';
  var len=Math.max(state.target.length || 0, guess.length, prev.length);
  for(var i=0;i<len;i++){
    var g=guess[i] || '';
    var p=prev[i] || '';
    var d=0;
    if(g && p){ d=Math.abs(aIdx(g)-aIdx(p)); }
    out.deltas[i]=d;
    if(d>out.cost){
      out.cost=d;
      out.maxCol=i;
    }
  }
  if(out.cost<=0) out.maxCol=-1;
  return out;
}
function minDistancePreviewForGuess(guess){
  if(!mutOn('minDistance')) return null;
  if(!state.guessHistory || !state.guessHistory.length) return null;
  guess=(guess||'')+'';
  var prev=state.guessHistory[state.guessHistory.length-1] || '';
  var len=Math.max(state.target.length || 0, guess.length, prev.length);
  var tracked=Math.floor(len/2);
  if(tracked<1){ return {required:0,total:0,tracked:0,cols:[],met:true}; }
  var raw=(state.mode==='campaign' ? state.campaignMutators.minDistanceVal : state.mutators.minDistanceVal);
  var required=clampMinDistance(raw);
  var deltas=[];
  for(var i=0;i<len;i++){
    var g=guess[i] || '';
    var p=prev[i] || '';
    var d=(g && p) ? Math.abs(aIdx(g)-aIdx(p)) : 0;
    deltas.push({col:i,d:d});
  }
  deltas.sort(function(a,b){
    if(b.d!==a.d) return b.d-a.d;
    return a.col-b.col;
  });
  var picked=deltas.filter(function(item){ return item.d>0; }).slice(0, tracked);
  var total=0;
  var cols=[];
  picked.forEach(function(item){
    total+=item.d;
    cols.push(item.col);
  });
  return {required:required,total:total,tracked:tracked,cols:cols,met:(total>=required)};
}
function copycatPreviewForGuess(guess){
  if(!mutOn('copycat')) return null;
  if(!state.guessHistory || !state.guessHistory.length) return null;
  guess=(guess||'')+'';
  var prev=(state.guessHistory[state.guessHistory.length-1] || '')+'';
  var required=(state.mode==='campaign' ? state.campaignMutators.copycatMin : state.mutators.copycatMin) || 2;
  var pool=prev.split('');
  var cols=[];
  for(var i=0;i<guess.length;i++){
    var ch=guess[i] || '';
    if(!ch) continue;
    var idx=pool.indexOf(ch);
    if(idx!==-1){
      cols.push(i);
      pool[idx]='';
    }
  }
  return {required:required, matched:cols.length, cols:cols, met:(cols.length>=required)};
}
function updateTypingConstraintVisuals(){
  clearTypingTileIndicators();
  if(state.mode==='hotseat' || state.gameOver) return;
  var row=state.row;
  var guess=(state.grid[row]||[]).join('');
  if(mutOn('budget')){
    var budget=budgetCostForGuess(guess);
    if(budget.maxCol>=0 && budget.maxCol<state.target.length){
      var budgetTile=document.querySelector('.tile[data-row="'+row+'"][data-col="'+budget.maxCol+'"]');
      if(budgetTile){
        budgetTile.classList.add('budget-focus');
        var note=budgetTile.querySelector('.tile-note');
        if(note) note.textContent='-'+budget.cost;
      }
    }
  }
  if(mutOn('minDistance')){
    var md=minDistancePreviewForGuess(guess);
    if(md){
      md.cols.forEach(function(col){
        if(col<0 || col>=state.target.length) return;
        var tile=document.querySelector('.tile[data-row="'+row+'"][data-col="'+col+'"]');
        if(!tile) return;
        tile.classList.add('min-distance-fit');
        if(md.met){ tile.classList.add('min-distance-ready'); }
      });
    }
  }
  if(mutOn('copycat')){
    var cc=copycatPreviewForGuess(guess);
    if(cc){
      cc.cols.forEach(function(col){
        if(col<0 || col>=state.target.length) return;
        var tile=document.querySelector('.tile[data-row="'+row+'"][data-col="'+col+'"]');
        if(!tile) return;
        tile.classList.add('copycat-linked');
        if(cc.met){ tile.classList.add('copycat-ready'); }
      });
    }
  }
}
function clearTypingPreview(){
  KBD.classList.remove('kbd-preview-on');
  $$('.key[data-key]').forEach(function(k){ k.classList.remove('pcand','pnocand') });
  clearTypingTileIndicators();
}
function hotPotatoRequiredChanges(len){
  len=safeInt(len,0);
  return (len>=7) ? 3 : 2;
}
function hotPotatoProgressForGuess(guess, row){
  if(!mutOn('hotPotato')) return null;
  if(!state.guessHistory || !state.guessHistory.length) return null;
  if(typeof guess!=='string') guess='';
  var fullLen=Math.max(state.target.length || 0, guess.length);
  var prevGuess=state.guessHistory[state.guessHistory.length-1] || '';
  var exactPrev=(state.exacts && row>0 && state.exacts[row-1]) ? state.exacts[row-1] : null;
  var eligible=0, changed=0, blocked=[];
  for(var i=0;i<fullLen;i++){
    var gch=guess[i] || '';
    var pch=prevGuess[i] || '';
    var exempt=(isStaticLockActive(row) && i===lockedCol()) || (!!(exactPrev && exactPrev[i]));
    if(exempt) continue;
    eligible++;
    if(gch===pch){ blocked.push(i); }
    if(gch && pch && gch!==pch) changed++;
  }
  var req=Math.min(hotPotatoRequiredChanges(fullLen), eligible);
  return {required:req, changed:changed, eligible:eligible, blocked:blocked};
}
function clearHotPotatoVisuals(){
  $$('.tile.potato-lock').forEach(function(t){ t.classList.remove('potato-lock'); });
}
function updateHotPotatoVisuals(){
  clearHotPotatoVisuals();
  if(state.gameOver) return;
  if(state.row<=0) return;
  var rowGuess=(state.grid[state.row]||[]).join('');
  var p=hotPotatoProgressForGuess(rowGuess, state.row);
  if(!p || p.required<=0) return;
  p.blocked.forEach(function(c){
    var t=document.querySelector('.tile[data-row=\"'+state.row+'\"][data-col=\"'+c+'\"]');
    if(t) t.classList.add('potato-lock');
  });
}
function typingCandidateSet(col){
  var lastRow = state.row-1;
  if(lastRow < 0) return null;
  return combinedCandidatesForColumn(col,lastRow);
}
function updateTypingPreview(){
  if(state.mode==='hotseat'){ clearTypingPreview(); return; }
  if(state.kbdHintsOn || state.gameOver){ clearTypingPreview(); updateHotPotatoVisuals(); return; }
  var col = Math.min(state.col, state.target.length-1);
  var set = typingCandidateSet(col);
  if(!set || !set.size){
    set = new Set();
    for(var i=0;i<26;i++) set.add(idxToChar(i));
  }
  KBD.classList.add('kbd-preview-on');
  $$('.key[data-key]').forEach(function(k){
    var ch=k.getAttribute('data-key');
    if(ch && ch.length===1){
      k.classList.remove('pcand','pnocand');
      if(set.has(ch)) k.classList.add('pcand'); else k.classList.add('pnocand');
    }
  });
  updateHotPotatoVisuals();
  updateTypingConstraintVisuals();
}
var flashTimer=null;
function flashCandidates(c){
  if(state.kbdHintsOn || state.mode==='hotseat') return;
  var lastRow = state.row;
  var set = combinedCandidatesForColumn(c,lastRow);
  if(!set || !set.size) return;
  if(flashTimer){ clearTimeout(flashTimer); flashTimer=null; }
  $$('.key').forEach(function(k){ k.classList.remove('flash'); });
  $$('.key[data-key]').forEach(function(k){
    var ch=k.getAttribute('data-key');
    if(ch && ch.length===1 && set.has(ch)) k.classList.add('flash');
  });
  flashTimer=setTimeout(function(){
    $$('.key').forEach(function(k){ k.classList.remove('flash'); });
  }, 260);
}

function applyTileVisual(tile, letter, hint, pol){
  tile.classList.remove('near','correct','dir','grayed','noisy','wildcard','decoy-red','double-shadow');
  tile.removeAttribute('data-dir');
  tile.style.background=''; tile.style.borderColor='';
  var s = tile.querySelector('.tile-letter');
  if(s) s.textContent = letter;
  if(hint && hint.hidden){ return; }
  if(hint && hint.decoyRed){ tile.classList.add('decoy-red'); }
  if(hint && hint.exact){ tile.classList.add('correct'); return; }
  var dist = hint ? hint.dist : 0;
  var dir = hint ? hint.dir : 0;
  var showNumber = hint ? hint.showNumber : false;
  if(showNumber && !(effectiveDifficulty(state.difficulty)==='easy' || mutOn('lifeline'))){ showNumber=false; }
  var arrowOverride = hint ? hint.noisyArrow : '';
  if(arrowOverride){
    tile.classList.add('noisy');
    var tilt = (Math.random()*60 - 30).toFixed(1)+'deg';
    var speed = (0.22 + Math.random()*0.18).toFixed(2)+'s';
    tile.style.setProperty('--arrow-tilt', tilt);
    tile.style.setProperty('--arrow-speed', speed);
  }else{
    tile.style.removeProperty('--arrow-tilt');
    tile.style.removeProperty('--arrow-speed');
  }
  if(hint && hint.wildcard){ tile.classList.add('wildcard'); }
  if(pol.grayed){
    tile.classList.add('grayed');
    if(pol.showArrow || showNumber){
      var signG = (dir>0)?'+':'-';
      var arrowG = arrowOverride || ((dir>0)?'â–¶':'â—€');
      var labelG = showNumber ? (arrowG + signG + dist) : arrowG;
      if(!pol.showArrow && showNumber){ labelG = signG + dist; }
      tile.setAttribute('data-dir', labelG);
      tile.classList.add('dir');
    }
    return;
  }
  tile.classList.add('near');
  if(state.fadeColor){
    var cs = getComputedStyle(document.documentElement);
    var nearC = parseCssColor(cs.getPropertyValue('--near') || '#c9b458');
    var corC  = parseCssColor(cs.getPropertyValue('--correct') || '#6aaa64');
    var t = 1 - Math.min(dist,13)/13;
    var color = blend(nearC, corC, t);
    tile.style.background = 'linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.02)) '+color;
    tile.style.borderColor = 'rgba(0,0,0,.2)';
  }
  if(pol.showArrow || showNumber){
    var sign = (dir>0)?'+':'-';
    var arrow = arrowOverride || ((dir>0)?'â–¶':'â—€');
    var label = showNumber ? (arrow + sign + dist) : arrow;
    if(!pol.showArrow && showNumber){ label = sign + dist; }
    tile.setAttribute('data-dir', label);
    tile.classList.add('dir');
  }
}

function submitRow(allowAny, opts){
  opts = opts || {};
  var skipAnim = !!opts.skipAnim;
  var skipFlash = !!opts.skipFlash;
  clearSwipeSuggestions();
  if(state.mode==='hotseat') state.enforce=false;
  if(state.col<state.target.length){ shake(); toast('Not enough letters'); startCountdown(); return }
  var guess = state.grid[state.row].join('');
  var originalGuess = guess;
  clearTypingTileIndicators();
  var isExactTarget = (originalGuess===state.target);
  if(mutOn('echo') && state.row>0 && state.exacts[state.row-1]){
    for(var e=0;e<state.exacts[state.row-1].length;e++){
      if(state.exacts[state.row-1][e] && guess[e]!==state.target[e]){
        shake(); toast('Keep green letters locked.'); return;
      }
    }
  }
  if(mutOn('vowelsOnly') && hasVowel(state.target) && !hasVowel(guess)){
    shake(); toast('Add at least one vowel.'); return;
  }
  var hotBreakPending=false;
  var hotBreakInfo=null;
  if(mutOn('hotPotato') && state.guessHistory && state.guessHistory.length>0){
    hotBreakInfo=hotPotatoProgressForGuess(guess, state.row);
    if(hotBreakInfo && hotBreakInfo.required>0 && hotBreakInfo.changed<hotBreakInfo.required){
      if(state.hotPotatoBreakUsed){
        var needMore=hotBreakInfo.required-hotBreakInfo.changed;
        shake(); toast('Hot potato! Change '+needMore+' more slot'+(needMore===1?'':'s')+'.'); return;
      }
      hotBreakPending=true;
    }
  }
  // Copycat: must share at least N letters (any position) with previous guess
  if(mutOn('copycat') && state.guessHistory && state.guessHistory.length>0){
    var ccPreview=copycatPreviewForGuess(guess);
    if(ccPreview && ccPreview.matched<ccPreview.required){
      shake(); toast('Copycat! Share at least '+ccPreview.required+' letters with previous guess.'); return;
    }
  }
  // Minimum Distance: only the strongest half of per-letter distances count; total must reach N.
  if(mutOn('minDistance') && state.guessHistory && state.guessHistory.length>0){
    var mdPreview=minDistancePreviewForGuess(guess);
    if(mdPreview && mdPreview.total<mdPreview.required){
      shake(); toast('Min distance! Need '+mdPreview.required+' from top '+mdPreview.tracked+' letters, got '+mdPreview.total+'.'); return;
    }
  }
  var useWildcard = mutOn('wildcard') && state.wildcardArmed && !state.wildcardUsed;
  if(state.enforce && state.dict.size===0){
    state.enforce = false; toast('No dictionary loaded; enforcement disabled this round.');
  }
  var wildcardIdx=-1;
  var wildcardWord='';
  if(!isExactTarget && !allowAny && state.enforce && !state.dict.has(guess)){
    if(useWildcard){
      var fix=wildcardDictFix(guess);
      wildcardIdx = fix ? fix.index : -1;
      wildcardWord = fix ? fix.word : '';
      if(wildcardIdx<0){
        shake(); toast('Not in dictionary. Wildcard only forgives 1 letter.');
        if(state.mode!=='hotseat') state.replaceMode=true;
        return;
      }
    }else{
      shake(); toast('Not in dictionary');
      if(state.mode!=='hotseat') state.replaceMode=true;
      return;
    }
  }
  if(!isExactTarget && useWildcard && wildcardIdx<0){
    shake(); toast('Wildcard armed: word must be 1 letter from dictionary.');
    if(state.mode!=='hotseat') state.replaceMode=true;
    return;
  }
  if(hotBreakPending){
    state.hotPotatoBreakUsed=true;
    if(hotBreakInfo){
      toast('Heat break used ('+hotBreakInfo.changed+'/'+hotBreakInfo.required+').');
    }else{
      toast('Heat break used.');
    }
  }

  if(mutOn('budget')){
    if(!state.guessHistory) state.guessHistory=[];
    var costInfo=budgetCostForGuess(guess);
    var cost=costInfo.cost || 0;
    if(typeof state.budgetPoints!=='number'){
      var bpInit = (state.mode==='campaign' ? state.campaignMutators.budgetPoints : state.mutators.budgetPoints);
      state.budgetPoints=clampBudget(bpInit);
    }
    state.budgetPoints -= cost;
  }

  pauseCountdown();

  // Apply drift BEFORE computing hints so old rows shift first
  if(mutOn('drift') && state.row>0 && !state.gameOver){
    applyDrift();
  }

  var blindRow = mutOn('blindStart') && state.row<2;
  if(useWildcard) blindRow = false;
  var noisy = mutOn('noisyArrows');
  var mirrorRow = mutOn('mirror') && state.row===0;
  if(mutOn('doubleVision') && state.row>0){
    if(!state.doubleVision) state.doubleVision={};
    if(typeof state.doubleVision[state.row]!=='number'){
      state.doubleVision[state.row] = (Math.random()*guess.length)|0;
    }
  }
  if(mutOn('bloodMirage')){
    if(!state.bloodMirage) state.bloodMirage={};
    if(typeof state.bloodMirage[state.row]!=='number'){
      state.bloodMirage[state.row] = (Math.random()*guess.length)|0;
    }
  }
  var fakeCol = (mutOn('bloodMirage') && state.bloodMirage && typeof state.bloodMirage[state.row]==='number') ? state.bloodMirage[state.row] : -1;
  var decoyRed = mutOn('bloodMirage');
  // Phantom Letter: pick a random column to hide hint
  var phantomCol = -1;
  if(mutOn('phantomLetter')){
    phantomCol = (Math.random()*guess.length)|0;
  }

  var rowHints=new Array(guess.length);
  var rawHints=new Array(guess.length);
  var exactsRow=new Array(guess.length);
  for(var i=0;i<guess.length;i++){
    var g=originalGuess[i], t=state.target[i];
    var exact = (g===t);
    exactsRow[i]=exact;
    var dir = exact ? 0 : (aIdx(t) > aIdx(g) ? +1 : -1);
    var dist = exact ? 0 : Math.abs(aIdx(t)-aIdx(g));
    var isDecoy = (fakeCol===i);
    if(isDecoy){
      exact = false;
      dir = (Math.random()<0.5)?+1:-1;
      dist = clamp(1+((Math.random()*6)|0),1,25);
    }
    var pol = difficultyPolicy(dist, dir);
    var hint={
      exact:exact, dist:dist, dir:dir,
      grayed:pol.grayed, showArrow:pol.showArrow,
      showNumber:(effectiveDifficulty(state.difficulty)==='easy' && dist<=3),
      hidden:blindRow
    };
    if(state.mode==='hotseat'){
      hint.grayed=false;
      hint.showArrow=false;
      hint.showNumber=false;
    }
    if(isDecoy && decoyRed){ hint.decoyRed=true; }
    if(phantomCol===i){ hint.hidden=true; }
    if(wildcardIdx===i){ hint.wildcard=true; hint.wildcardWord=wildcardWord; }
    if(noisy && dist>3 && hint.showArrow && Math.random()<0.33){
      hint.noisyArrow = (Math.random()<0.5)?'â–²':'â–¼';
    }
    rawHints[i]=hint;
    var storeCol = mirrorRow ? (guess.length-1-i) : i;
    rowHints[storeCol]=hint;
  }
  state.exacts[state.row]=exactsRow;
  state.grid[state.row]=originalGuess.split('');
  if(mirrorRow){
    state.hintsRaw[state.row]=rawHints;
    state.hints[state.row]=rowHints;
  }else{
    state.hints[state.row]=rowHints;
  }
  if(!state.guessHistory) state.guessHistory=[];
  state.guessHistory.push(originalGuess);

  doubleVisionOverride=null;
  if(mutOn('doubleVision') && state.row>0){
    doubleVisionOverride=state.row;
    renderRowFromState(state.row-1, state.row);
  }

  for(var c=0;c<guess.length;c++){
    var tile = document.querySelector('.tile[data-row=\"'+state.row+'\"][data-col=\"'+c+'\"]');
    if(!tile) continue;
    var display = getDisplayTileData(state.row, c, state.row);
    var info = display.hint;
    var letter = display.ch || '';
    if(skipAnim){
      tile.classList.remove('reveal');
      tile.style.removeProperty('--delay');
      if(info){
        applyTileVisual(tile, letter, info, difficultyPolicy(info.dist, info.dir));
      }else{
        tile.classList.remove('near','correct','dir','grayed','wildcard','noisy','decoy-red','double-shadow');
        tile.removeAttribute('data-dir');
        tile.style.background=''; tile.style.borderColor='';
        var s0 = tile.querySelector('.tile-letter');
        if(s0) s0.textContent = letter;
      }
      tile.classList.toggle('double-shadow', !!display.double);
      if(info && !info.hidden && !skipFlash && !display.double) flashCandidates(c);
    }else{
      tile.style.setProperty('--delay', (c*110)+'ms');
      setTimeout(function(ti, ch, inf, col, isDouble){
        return function(){
          ti.classList.add('reveal');
          if(inf){
            applyTileVisual(ti, ch, inf, difficultyPolicy(inf.dist, inf.dir));
          }else{
            ti.classList.remove('near','correct','dir','grayed','wildcard','noisy','decoy-red','double-shadow');
            ti.removeAttribute('data-dir');
            ti.style.background=''; ti.style.borderColor='';
            var s1 = ti.querySelector('.tile-letter');
            if(s1) s1.textContent = ch;
          }
          ti.classList.toggle('double-shadow', !!isDouble);
          if(inf && !inf.hidden && !isDouble) flashCandidates(col);
        };
      }(tile, letter, info, c, display.double), c*110);
    }
  }

  if(useWildcard){
    state.wildcardUsed=true;
    state.wildcardArmed=false;
  }

  if(mutOn('staticTile') && state.row===0){
    var pickCol=(Math.random()*guess.length)|0;
    state.staticLock={col:pickCol, letter:state.grid[0][pickCol], untilRow:2};
  }

  var pri={near:1,correct:2};
  for(var j=0;j<guess.length;j++){
    var ch=state.grid[state.row][j]; var info2=state.hints[state.row][j];
    if(isDoubleVisionMask(state.row, j, state.row)) continue;
    if(info2.hidden) continue;
    var st=''; if(info2.exact) st='correct'; else if(!info2.grayed) st='near';
    var prev=state.statuses[ch]; if(st && (!prev || pri[st]>(pri[prev]||0))) state.statuses[ch]=st;
  }
  setTimeout(updateKeyboard, skipAnim ? 0 : (guess.length*120));
  var win = (originalGuess===state.target);
  var last = (!mutOn('budget')) && (state.row === state.max-1);
  setTimeout(function(){
    var advanced=false;
    doubleVisionOverride=null;
    if(state.mode==='hotseat'){
      hotseatProcessRound(originalGuess, rowHints, exactsRow, win);
      if(win){
        state.gameOver=true;
        var r=state.hotseat ? state.hotseat.greenCount[HS_RED] : 0;
        var b=state.hotseat ? state.hotseat.greenCount[HS_BLUE] : 0;
        var w=hotseatWinner();
        var msg='Solved! ';
        if(w===HS_RED || w===HS_BLUE){
          msg+=hsName(w)+' wins '+r+'-'+b;
          if(r===b){ msg+=' (tiebreak)'; }
        }else{
          msg+='Draw '+r+'-'+b;
        }
        toast(msg);
        celebrate();
        stopCountdown();
      }else{
        if(state.row>=state.max-1){ addRows(3); }
        state.row++; state.col=0; advanced=true;
        hotseatStartRound();
      }
      updateTypingPreview();
      updateRowVisibility(true);
      scheduleScrollToActiveRow();
      updateGuessLabel(true);
      saveSession();
      return;
    }
    if(win){
      state.gameOver=true;
      var winMsg='Nice!';
      if(state.mode==='campaign'){
        var usedGuesses=state.row+1;
        var bonusMax = mutOn('budget') ? 20 : state.max;
        var bonus=Math.max(0, bonusMax-usedGuesses);
        if(bonus>0){
          currency+=bonus;
          saveCurrency();
          winMsg='Nice! +'+bonus+' bonus coin'+(bonus===1?'':'s');
        }
        celebrateLevel();
      }else{
        celebrate();
      }
      toast(winMsg);
      stopCountdown();
    }
    else if(last){
      state.gameOver=true;
      if(mutOn('fog')){
        state.fogReveal=true;
        renderBoardFromState();
        updateRowVisibility(false, true);
        updateStaticLockVisuals();
      }
      if(state.mode==='campaign'){
        toast('Out of guesses.');
      }else{
        toast('Answer: '+state.target);
      }
      stopCountdown();
    }
    else {
      if(mutOn('budget') && state.row>=state.max-1){
        if(state.max < 20){ addRows(1); }
        else{
          state.gameOver=true;
          if(mutOn('fog')){
            state.fogReveal=true;
            renderBoardFromState();
            updateRowVisibility(false, true);
            updateStaticLockVisuals();
          }
          if(state.mode==='campaign'){
            toast('Out of guesses.');
          }else{
            toast('Out of guesses. Answer: '+state.target);
          }
          saveSession();
          return;
        }
      }
      state.row++; state.col=0; advanced=true;
    }
    if(mutOn('budget') && typeof state.budgetPoints==='number' && state.budgetPoints<=0 && !state.gameOver){
      state.gameOver=true;
      if(mutOn('fog')){
        state.fogReveal=true;
        renderBoardFromState();
        updateRowVisibility(false, true);
        updateStaticLockVisuals();
      }
      if(state.mode==='campaign'){
        toast('Out of letter points.');
      }else{
        toast('Out of letter points. Answer: '+state.target);
      }
    }
    if(mutOn('doubleVision')){
      var prevRow = advanced ? (state.gameOver ? (state.row-1) : (state.row-2)) : state.row;
      refreshDoubleVisionDisplay(prevRow);
      recomputeStatuses();
    }
    updateTypingPreview();
    updateRowVisibility(true);
    scheduleScrollToActiveRow();
    updateGuessLabel(true);
    if(mutOn('mirror') && state.row===2){
      setTimeout(function(){ mirrorRowData(0); }, 120);
    }
    if(mutOn('randomKeyboard') && !state.gameOver){
      randomizeKeyboardLayout();
    }
    updateStaticLockVisuals();
    if(!state.gameOver && isStaticLockActive(state.row)){ applyStaticLockToRow(state.row); }
    if(!state.gameOver){ startCountdown(); }
    saveSession();
    if(state.mode==='campaign' && state.gameOver && activeCampaign){
      var set=getCampaignSet(activeCampaign.setId);
      if(set){
        if(!win){ removeKey(campaignKey(set.id)); }
        var delay = win ? 900 : 400;
        setTimeout(function(){ if(win) advanceCampaign(set); else showCampaignFail(set); }, delay);
      }
    }
  }, guess.length*120 + 50);
}
window.__wordshift_submit = function(allowAny){ return submitRow(!!allowAny); };

BOARD.addEventListener('click', function(e){
  var tile = (e.target.closest && e.target.closest('.tile')) ? e.target.closest('.tile') : null; if(!tile) return;
  var r = parseInt(tile.getAttribute('data-row'),10), c=parseInt(tile.getAttribute('data-col'),10);
  if(state.mode==='hotseat'){ clearTypingPreview(); return; }
  var lastRow = state.gameOver ? state.row : (state.row-1);
  if(r!==lastRow) return;
  if(tile.classList.contains('fogged') || tile.classList.contains('hidden')) return;
  var srcRow = isDoubleVisionMask(r,c) ? (r-1) : r;
  if(srcRow<0) return;
  var hint = state.hints[srcRow] ? state.hints[srcRow][c] : null;
  var guessCh = (state.grid[srcRow] ? state.grid[srcRow][c] : '') || '';
  if(!guessCh) return;
  if(!hint || hint.hidden) return;
  if(hint.noisyArrow) return;
  var cand = new Set();
  if(hint.exact){ cand.add(guessCh); }
  else if(hint.grayed){
    var gi=aIdx(guessCh);
    if(effectiveDifficulty(state.difficulty)==='impossible'){
      ALPHA.forEach(function(L){ if(Math.abs(aIdx(L)-gi)>=4) cand.add(L) });
    } else {
      ALPHA.forEach(function(L){ if(Math.abs(aIdx(L)-gi)>=10) cand.add(L) });
    }
  } else {
    var gi2=aIdx(guessCh);
    var dEff=effectiveDifficulty(state.difficulty);
    if(dEff==='easy' && hint.dist<=3){
      var ti=gi2 + (hint.dir>0?+hint.dist:-hint.dist); cand.add(idxToChar(ti));
    } else if(dEff==='insane'){
      if(hint.showArrow){ [1,2,3].forEach(function(d){var i=gi2+(hint.dir>0?+d:-d); if(i>=0&&i<26) cand.add(idxToChar(i));}); }
      else { for(var d4=4; d4<=9; d4++){ if(gi2+d4<26) cand.add(idxToChar(gi2+d4)); if(gi2-d4>=0) cand.add(idxToChar(gi2-d4)); } }
    } else if(dEff==='impossible'){
      for(var d1=1; d1<=3; d1++){ if(gi2+d1<26) cand.add(idxToChar(gi2+d1)); if(gi2-d1>=0) cand.add(idxToChar(gi2-d1)); }
    } else if(dEff==='hard'){
      for(var d2=1; d2<=25; d2++){ var i2=gi2+(hint.dir>0?+d2:-d2); if(i2>=0&&i2<26) cand.add(idxToChar(i2)); }
    } else {
      for(var d3=1; d3<=25; d3++){ var i3=gi2+(hint.dir>0?+d3:-d3); if(i3>=0&&i3<26) cand.add(idxToChar(i3)); }
    }
  }
  clearKbdHints(); KBD.classList.add('kbd-hints-on'); state.kbdHintsOn=true;
  var n=0; $$('.key[data-key]').forEach(function(k){
    var ch=k.getAttribute('data-key');
    if(ch && ch.length===1){ if(cand.has(ch)){k.classList.add('cand'); n++;} else k.classList.add('nocand'); }
  }); toast('Possible letters: '+n);
});

var seed=[
  // 4
  'WAVE','MINT','LAMP','FROG','GLOW','RUST','BARK','SNOW',
  // 5
  'APPLE','ROBOT','MIGHT','CLOUD','STONE','TIMER','GHOST','PIXEL','WATER','NINJA','SPARK','ZEBRA','AZURE','MAGIC','THORN',
  // 6
  'YELLOW','BRONZE','COOKIE','PLANET','STREAM','MARKET','CANDLE','THRONE',
  // 7
  'LANTERN','JOURNEY','CRYSTAL','HARBORS','THUNDER','ORCHARD','FALCONS','MIRRORS',
  // 8
  'NOTEBOOK','TREASURE','MOUNTAIN','SAPPHIRE','MIDNIGHT','LANGUAGE','SUNSHINE','TRIANGLE',
  // 9
  'PINEAPPLE','BLUEPRINT','WATERFALL','MOONLIGHT','SUNFLOWER','STARLIGHT','WONDERFUL','VIBRANTLY',
  // 10
  'STONEBRICK','THUNDERING','HIGHLIGHTS','NIGHTFALLS','GOLDRUSHES','MOUNTAINTOP','LIGHTHOUSES','DREAMSCAPE'
];
function ensureMap(add,set,map){ add.forEach(function(w){ if(!set.has(w)){ set.add(w); if(!map.has(w.length)) map.set(w.length,new Set()); map.get(w.length).add(w) } }); }
ensureMap(seed, state.dict, state.dictLen);

function setSwitch(el,on){
  if(!el) return;
  el.classList.toggle('on', !!on);
  var input=el.querySelector('input'); if(input){ input.checked=!!on; }
}
function toggleSwitch(el){
  if(!el) return;
  var input=el.querySelector('input'); if(!input) return;
  input.checked=!input.checked;
  el.classList.toggle('on', input.checked);
}
function openSettings(){
  var wordEl=$('#word'); if(wordEl) wordEl.value=state.target;
  var gcountEl=$('#gcount'); if(gcountEl) gcountEl.value=state.max;
  var diffEl=$('#difficulty'); if(diffEl) diffEl.value=state.difficulty;
  setSwitch($('#fadeSwitch'), state.fadeColor); setSwitch($('#enforceSwitch'), state.enforce);
  $('#dictUrl').value=state.dictUrl; $('#theme').value=state.theme;
  var mut=state.mutators || normalizeMutators(null);
  var mutWrap=$('#mutatorSection');
  if(mutWrap){ mutWrap.style.display = (state.mode==='sandbox') ? '' : 'none'; }
  setSwitch($('#mutBlind'), mut.blindStart);
  setSwitch($('#mutEcho'), mut.echo);
  setSwitch($('#mutVowels'), mut.vowelsOnly);
  setSwitch($('#mutMirror'), mut.mirror);
  setSwitch($('#mutStatic'), mut.staticTile);
  setSwitch($('#mutDrift'), mut.drift);
  setSwitch($('#mutFog'), mut.fog);
  setSwitch($('#mutBudget'), mut.budget);
  setSwitch($('#mutDouble'), mut.doubleVision);
  setSwitch($('#mutBlood'), mut.bloodMirage);
  setSwitch($('#mutRandKbd'), mut.randomKeyboard);
  setSwitch($('#mutLife'), mut.lifeline);
  setSwitch($('#mutWildcard'), mut.wildcard);
  setSwitch($('#mutNoisy'), mut.noisyArrows);
  setSwitch($('#mutHotPotato'), mut.hotPotato);
  setSwitch($('#mutPhantom'), mut.phantomLetter);
  setSwitch($('#mutCopycat'), mut.copycat);
  var ccMin = $('#copycatMin'); if(ccMin) ccMin.value = safeInt(mut.copycatMin, 2);
  setSwitch($('#mutMinDist'), mut.minDistance);
  var mdVal = $('#minDistanceVal'); if(mdVal) mdVal.value = clampMinDistance(mut.minDistanceVal);
  setSwitch($('#mutCountdown'), mut.countdown);
  var cdSec = $('#countdownSec'); if(cdSec) cdSec.value = safeInt(mut.countdownSec, 30);
  var cdKey = $('#countdownKeyCenti'); if(cdKey) cdKey.value = safeInt(mut.countdownKeyCenti, 0);
  var lc = $('#lifelineCount'); if(lc) lc.value = clampLifeCount(mut.lifelineCount);
  var bp = $('#budgetPoints');
  if(bp){
    bp.value = clampBudget(mut.budgetPoints);
    var bpRow = bp.closest('.row');
    if(bpRow) bpRow.style.display = mut.budget ? '' : 'none';
  }
  document.body.style.overflow='hidden'; $('#settings').classList.add('open'); setTimeout(function(){ try{$('#word').focus()}catch(e){} },50);
}
function radioGroupValue(groupEl){
  if(!groupEl) return '';
  var checked = groupEl.querySelector('input[type=\"radio\"]:checked');
  return checked ? checked.value : '';
}
function setRadioGroupValue(groupEl, value){
  if(!groupEl) return;
  var inputs = groupEl.querySelectorAll('input[type=\"radio\"]');
  inputs.forEach(function(i){ i.checked = (i.value===value); });
}
function toggleHotseatCustomRow(){
  if(!hsCustomRow || !hsWordSource) return;
  hsCustomRow.style.display = (radioGroupValue(hsWordSource)==='custom') ? '' : 'none';
}
function openHotseatLobby(){
  if(!hotseatLobby) return;
  var s=state.hotseatSettings || HOTSEAT_DEFAULTS;
  if(hsWordSource) setRadioGroupValue(hsWordSource, s.wordSource || 'random');
  if(hsCustomWord) hsCustomWord.value = s.customWord || '';
  if(hsPassSwitch) setSwitch(hsPassSwitch, !!s.passOverlay);
  toggleHotseatCustomRow();
  document.body.style.overflow='hidden';
  hotseatLobby.classList.add('open');
}
function closeHotseatLobby(){
  if(!hotseatLobby) return;
  hotseatLobby.classList.remove('open');
  document.body.style.overflow='';
}
function applyHotseatSettingsFromUI(){
  if(!hotseatLobby) return;
  var raw={
    wordSource: hsWordSource ? radioGroupValue(hsWordSource) : 'random',
    customWord: hsCustomWord ? hsCustomWord.value : '',
    passOverlay: hsPassSwitch ? !!hsPassSwitch.querySelector('input').checked : true,
    claimRule: 'auto'
  };
  state.hotseatSettings = normalizeHotseatSettings(raw);
  saveHotseatSettings();
}
function closeSettings(){ $('#settings').classList.remove('open'); document.body.style.overflow='' }
$('#btnSettings').addEventListener('click', function(){
  if(state.mode==='hotseat'){ openHotseatLobby(); return; }
  openSettings();
});
$('#btnClose').addEventListener('click', closeSettings);
$('#settings').addEventListener('click', function(e){ if(e.target.id==='settings') closeSettings() });
function isValidStateObj(o){
  return o && typeof o==='object' &&
    typeof o.target==='string' &&
    typeof o.max==='number' &&
    Array.isArray(o.grid) && Array.isArray(o.hints) &&
    typeof o.row==='number' && typeof o.col==='number';
}
function applyStateFromObj(o){
  state.target=lettersOnlyUpper(o.target) || state.target;
  state.max=clamp(safeInt(o.max, state.max),3,20);
  state.difficulty=o.difficulty || state.difficulty;
  state.fadeColor=!!o.fadeColor;
  state.enforce=(typeof o.enforce==='boolean') ? o.enforce : state.enforce;
  state.dictUrl=o.dictUrl || state.dictUrl;
  if(o.theme){ state.theme=o.theme; document.documentElement.setAttribute('data-theme', state.theme); }
  if(o.mutators){ state.mutators=normalizeMutators(o.mutators); }
  if(o.campaignMutators){ state.campaignMutators=normalizeMutators(o.campaignMutators); }
  if(typeof o.budgetPoints==='number') state.budgetPoints=o.budgetPoints;
  if(typeof o.lifelineRemaining==='number') state.lifelineRemaining=o.lifelineRemaining;
  state.grid=o.grid || [];
  state.hints=o.hints || [];
  state.row=clamp(safeInt(o.row,0),0,state.max-1);
  state.col=clamp(safeInt(o.col,0),0,state.target.length);
  state.statuses=o.statuses || {};
  state.gameOver=!!o.gameOver;
  state.replaceMode=!!o.replaceMode;
  state.staticLock=o.staticLock || null;
  state.doubleVision=o.doubleVision || null;
  state.bloodMirage=o.bloodMirage || null;
  state.exacts=o.exacts || [];
  state.guessHistory=o.guessHistory || [];
  state.fogReveal=!!o.fogReveal;
  state.hintsRaw=o.hintsRaw || [];
  state.hotPotatoBreakUsed=!!o.hotPotatoBreakUsed;
  buildBoard(true);
  scheduleScrollToActiveRow();
  updateGuessLabel(false);
  saveSession();
}
$('#btnCopyState').addEventListener('click', function(){
  var snapshot={
    target:state.target,max:state.max,difficulty:state.difficulty,fadeColor:state.fadeColor,enforce:state.enforce,dictUrl:state.dictUrl,
    theme:state.theme,mutators:state.mutators,campaignMutators:state.campaignMutators,
    grid:state.grid,hints:state.hints,row:state.row,col:state.col,statuses:state.statuses,
    gameOver:state.gameOver,replaceMode:state.replaceMode,
    budgetPoints:state.budgetPoints,lifelineRemaining:state.lifelineRemaining,
    hotPotatoBreakUsed:state.hotPotatoBreakUsed,
    staticLock:state.staticLock,doubleVision:state.doubleVision,bloodMirage:state.bloodMirage,exacts:state.exacts,guessHistory:state.guessHistory,
    fogReveal:state.fogReveal,hintsRaw:state.hintsRaw
  };
  var txt=JSON.stringify(snapshot);
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(function(){toast('State copied');},function(){
      try{ prompt('Copy state JSON:', txt); }catch(e){ toast('Copy failed'); }
    });
  }else{
    try{ prompt('Copy state JSON:', txt); }catch(e){ toast('Copy failed'); }
  }
});
$('#btnPasteState').addEventListener('click', function(){
  var handleText=function(txt){
    try{
      var obj=JSON.parse(txt);
      if(!isValidStateObj(obj)){ toast('Invalid state JSON'); return; }
      applyStateFromObj(obj);
      toast('State loaded');
    }catch(e){ toast('Invalid JSON'); }
  };
  if(navigator.clipboard && navigator.clipboard.readText){
    navigator.clipboard.readText().then(handleText,function(){
      var txt=prompt('Paste state JSON:');
      if(txt) handleText(txt);
    });
  }else{
    var txt=prompt('Paste state JSON:');
    if(txt) handleText(txt);
  }
});
$('#settings').addEventListener('click', function(e){
  var sw = (e.target.closest && e.target.closest('.switch')) ? e.target.closest('.switch') : null;
  if(sw){ toggleSwitch(sw); }
  if(sw && sw.id==='mutBudget'){
    var bp = $('#budgetPoints');
    if(bp){
      var show = sw.querySelector('input').checked;
      bp.closest('.row').style.display = show ? '' : 'none';
      if(show){ bp.value = 50; }
    }
  }
  var help = (e.target.closest && e.target.closest('.mut-help')) ? e.target.closest('.mut-help') : null;
  if(help) return;
  var label = (e.target.closest && e.target.closest('.row label')) ? e.target.closest('.row label') : null;
  if(label){
    var row = label.closest('.row');
    if(row){
      var sw2 = row.querySelector('.switch');
      if(sw2){ toggleSwitch(sw2); }
    }
  }
});
$('#settings').addEventListener('click', function(e){
  var help = (e.target.closest && e.target.closest('.mut-help')) ? e.target.closest('.mut-help') : null;
  if(!help) return;
  var msg = help.getAttribute('data-help') || '';
  if(msg){ toast(msg, 1600); }
});
var campaignIntroEl=$('#campaignIntro');
if(campaignIntroEl){
  campaignIntroEl.addEventListener('click', function(e){
    var tag = (e.target.closest && e.target.closest('.intro-tag')) ? e.target.closest('.intro-tag') : null;
    if(tag && tag.getAttribute('data-more')){
      toast('More: '+tag.getAttribute('data-more'), 2200);
      return;
    }
    if(tag && tag.getAttribute('data-help')){ toast(tag.getAttribute('data-help'), 1800); }
  });
  campaignIntroEl.addEventListener('keydown', function(e){
    if(e.key!=='Enter' && e.key!==' ') return;
    var tag = (e.target.closest && e.target.closest('.intro-tag')) ? e.target.closest('.intro-tag') : null;
    if(tag && tag.getAttribute('data-more')){
      e.preventDefault();
      toast('More: '+tag.getAttribute('data-more'), 2200);
      return;
    }
    if(tag && tag.getAttribute('data-help')){
      e.preventDefault();
      toast(tag.getAttribute('data-help'), 1800);
    }
  });
}

var difficultyDescriptions = {
  easy: '<strong>Easy:</strong> Arrows shown for all distances, exact numbers shown for distances â‰¤3. Generous guidance.',
  normal: '<strong>Normal:</strong> Arrows shown for all distances. Plan your guesses strategically.',
  hard: '<strong>Hard:</strong> Arrows shown for all distances. Same as Normal, subtle challenge.',
  insane: '<strong>Insane:</strong> Arrows only for distances â‰¤3. Distances >9 grayed out. Navigate carefully.',
  impossible: '<strong>Impossible:</strong> No arrows. Distances >3 grayed out. Pure deduction required.'
};
function updateDifficultyInfo(){
  var diffSelect = $('#difficulty');
  var infoBox = $('#difficultyInfo');
  if(!diffSelect || !infoBox) return;
  var value = diffSelect.value || 'normal';
  infoBox.innerHTML = difficultyDescriptions[value] || difficultyDescriptions.normal;
}
$('#difficulty').addEventListener('change', updateDifficultyInfo);
updateDifficultyInfo();

var mutatorSearchInput = $('#mutatorSearch');
if(mutatorSearchInput){
  mutatorSearchInput.addEventListener('input', function(){
    var query = this.value.toLowerCase().trim();
    var items = document.querySelectorAll('.mutator-item');
    items.forEach(function(item){
      if(!query){
        item.classList.remove('hidden');
        return;
      }
      var nameEl = item.querySelector('.mutator-name');
      var descEl = item.querySelector('.mutator-desc');
      var name = nameEl ? nameEl.textContent.toLowerCase() : '';
      var desc = descEl ? descEl.textContent.toLowerCase() : '';
      var matches = name.indexOf(query) !== -1 || desc.indexOf(query) !== -1;
      item.classList.toggle('hidden', !matches);
    });
  });
}

$('#btnApply').addEventListener('click', function(){
  var w = lettersOnlyUpper($('#word').value);
  if(w){ state.target=w; state.max = recGuesses(w.length) }
  var gc = parseInt($('#gcount').value,10); if(!isNaN(gc)) state.max = clamp(gc,3,20);
  state.difficulty = $('#difficulty').value || 'normal';
  state.fadeColor = $('#fadeSwitch').querySelector('input').checked;
  state.enforce = $('#enforceSwitch').querySelector('input').checked;
  state.dictUrl = $('#dictUrl').value || state.dictUrl;
    if(state.mode==='sandbox'){
    state.mutators = normalizeMutators({
      blindStart: $('#mutBlind').querySelector('input').checked,
      echo: $('#mutEcho').querySelector('input').checked,
      vowelsOnly: $('#mutVowels').querySelector('input').checked,
      mirror: $('#mutMirror').querySelector('input').checked,
      staticTile: $('#mutStatic').querySelector('input').checked,
      drift: $('#mutDrift').querySelector('input').checked,
      fog: $('#mutFog').querySelector('input').checked,
      budget: $('#mutBudget').querySelector('input').checked,
      budgetPoints: $('#budgetPoints').value,
      doubleVision: $('#mutDouble').querySelector('input').checked,
      bloodMirage: $('#mutBlood').querySelector('input').checked,
      randomKeyboard: $('#mutRandKbd').querySelector('input').checked,
      lifeline: $('#mutLife').querySelector('input').checked,
      lifelineCount: $('#lifelineCount').value,
      wildcard: $('#mutWildcard').querySelector('input').checked,
      noisyArrows: $('#mutNoisy').querySelector('input').checked,
      hotPotato: $('#mutHotPotato').querySelector('input').checked,
      phantomLetter: $('#mutPhantom').querySelector('input').checked,
      copycat: $('#mutCopycat').querySelector('input').checked,
      copycatMin: $('#copycatMin').value,
      minDistance: $('#mutMinDist').querySelector('input').checked,
      minDistanceVal: $('#minDistanceVal').value,
      countdown: $('#mutCountdown').querySelector('input').checked,
      countdownSec: $('#countdownSec').value,
      countdownKeyCenti: safeInt($('#countdownKeyCenti').value, 0)
    });
    state.mutators.lifelineCount=clampLifeCount(state.mutators.lifelineCount);
    state.mutators.budgetPoints=state.mutators.budget ? clampBudget(state.mutators.budgetPoints) : clampBudget(50);
  }
  var newTheme=$('#theme').value || 'classic'; state.theme=newTheme; document.documentElement.setAttribute('data-theme',newTheme); save('theme',newTheme);
  persistSettings();
  buildBoard();
  if(SCROLL){ SCROLL.scrollTop=0; }
  scheduleScrollToActiveRow();
  closeSettings();
});

$('#btnNew').addEventListener('click', function(){
  if(state.mode==='hotseat'){
    startHotseat();
    return;
  }
  buildBoard();
  if(SCROLL){ SCROLL.scrollTop=0; }
  scheduleScrollToActiveRow();
  toast('New board');
});
$('#btnRandom').addEventListener('click', function(){
  if(state.mode==='hotseat'){
    if(state.hotseatSettings){ state.hotseatSettings.wordSource='random'; saveHotseatSettings(); }
    startHotseat();
    return;
  }
  var L=clamp(state.target.length||5,3,64);
  var pool = state.dictLen.get(L) ? Array.from(state.dictLen.get(L)) : seed.filter(function(w){return w.length===L});
  var pick = pool.length ? pool[(Math.random()*pool.length)|0] : 'CRANE';
  state.target=pick; state.max=recGuesses(pick.length); persistSettings(); buildBoard();
  if(SCROLL){ SCROLL.scrollTop=0; }
  scheduleScrollToActiveRow();
  toast('Random: '+pick);
});
$('#btnHelp').addEventListener('click', function(){
  if(state.mode==='hotseat'){
    toast('Hot Seat: Red then Blue. Fill your tiles, press ENTER to pass. Lower avg delta claims a tile. Greens score.');
    return;
  }
  toast('Green=exact. Difficulty sets arrow visibility & gray rules. Tap last-row tiles to see candidates.');
});
$('#btnFS').addEventListener('click', function(){
  var el=document.documentElement; var goFS=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen;
  if(!document.fullscreenElement && goFS) goFS.call(el); else if(document.exitFullscreen) document.exitFullscreen();
});

var WMOD=$('#words'), WLIST=$('#wlist'), WCOUNT=$('#wcount'), WFILTER=$('#wfilter');
function closeWordList(){ WMOD.classList.remove('open'); document.body.style.overflow=''; }
$('#btnSearch').addEventListener('click', function(){ openWordList(); });
$('#wclose').addEventListener('click', closeWordList);
$('#words').addEventListener('click', function(e){ if(e.target.id==='words') closeWordList() });
WFILTER.addEventListener('input', function(){renderWordList()});
WLIST.addEventListener('click', function(e){
  var btn = (e.target.closest && e.target.closest('.word-item')) ? e.target.closest('.word-item') : null;
  if(!btn) return;
  var w = btn.getAttribute('data-word');
  if(!w) return;
  state.target = w; state.max = recGuesses(w.length);
  persistSettings();
  buildBoard(); closeWordList(); toast('Selected: '+w);
});
function openWordList(){ renderWordList(); document.body.style.overflow='hidden'; WMOD.classList.add('open'); }
function renderWordList(){
  var L=state.target.length;
  var pool = state.dictLen.get(L) ? Array.from(state.dictLen.get(L)) : [];
  var pref = lettersOnlyUpper(WFILTER.value);
  var list = pref ? pool.filter(function(w){return w.indexOf(pref)===0}) : pool;
  WCOUNT.textContent = list.length.toLocaleString()+' words ('+L+' letters)';
  WLIST.innerHTML = list.slice(0,1200).map(function(w){
    return '<button class="word-item" data-word="'+w+'" type="button">'+w+'</button>';
  }).join('');
}

function runCampaignReviewLengths(){
  return [4,5,6,7,8];
}
function runLoadWordReviewFromFile(opts){
  opts=opts || {};
  var url=(typeof opts.url==='string') ? opts.url : runWordReviewFileUrl;
  url=String(url||'').trim();
  if(!url){
    runWordReviewFile=runNormalizeWordReview(null);
    runWordReviewFileMeta={url:'',loaded:false,lastError:'No URL set'};
    runRebuildWordReview();
    if(!opts.silent) toast('Set a campaign word file URL first.');
    return Promise.resolve(false);
  }
  if(!opts.force && runWordReviewFileMeta.url===url){
    if(runWordReviewFileMeta.loaded) return Promise.resolve(true);
    if(opts.silent) return Promise.resolve(false);
  }

  var reqUrl=url;
  if(/^[A-Za-z]:[\\/]/.test(reqUrl)){
    reqUrl='file:///'+reqUrl.replace(/\\/g,'/');
  }

  // Browsers block local file reads from file:// pages via fetch.
  if(location && location.protocol==='file:' && /^file:\/\//i.test(reqUrl)){
    runWordReviewFile=runNormalizeWordReview(null);
    runWordReviewFileMeta={url:reqUrl,loaded:false,lastError:'Local file fetch blocked by browser on file:// pages'};
    runRebuildWordReview();
    if(!opts.silent){
      toast('Local file URLs are blocked here. Run from localhost or use an https URL.');
    }
    return Promise.resolve(false);
  }

  try{
    return fetch(reqUrl,{mode:'cors',cache:'no-store'}).then(function(res){
      if(!res.ok){
        return res.text().then(function(body){
          var msg='HTTP '+res.status+' at '+url;
          if(body){
            try{
              var parsed=JSON.parse(body);
              if(parsed && (parsed.error || parsed.hint)){
                msg += ' - ' + (parsed.error || 'request failed');
                if(parsed.hint) msg += ' ('+parsed.hint+')';
              }else{
                msg += ' - ' + body.slice(0,180);
              }
            }catch(_){
              msg += ' - ' + String(body).slice(0,180);
            }
          }
          throw new Error(msg);
        });
      }
      return res.text();
    }).then(function(text){
      var parsed=JSON.parse(String(text||'{}'));
      runWordReviewFile=runNormalizeWordReview(parsed);
      runWordReviewFileMeta={url:reqUrl,loaded:true,lastError:''};
      runRebuildWordReview();
      if(!opts.silent) toast('Campaign word file loaded.');
      var refreshed=runRefreshFrontierWordsForReview();
      if(refreshed>0 && campaignMenuScreen && campaignMenuScreen.classList.contains('active')){
        buildCampaignMenu();
        requestAnimationFrame(focusCampaignMap);
      }
      return true;
    }).catch(function(e){
      runWordReviewFile=runNormalizeWordReview(null);
      runWordReviewFileMeta={url:reqUrl,loaded:false,lastError:String((e && e.message) || e || 'load failed')};
      runRebuildWordReview();
      if(!opts.silent){
        toast('Campaign word file load failed.');
        console.error(e);
      }
      return false;
    });
  }catch(e){
    runWordReviewFile=runNormalizeWordReview(null);
    runWordReviewFileMeta={url:reqUrl,loaded:false,lastError:String((e && e.message) || e || 'load failed')};
    runRebuildWordReview();
    if(!opts.silent){
      toast('Campaign word file load failed.');
      console.error(e);
    }
    return Promise.resolve(false);
  }
}

function runEscHtml(s){
  return String(s==null?'':s).replace(/[&<>"']/g,function(ch){
    if(ch==='&') return '&amp;';
    if(ch==='<') return '&lt;';
    if(ch==='>') return '&gt;';
    if(ch==='"') return '&quot;';
    return '&#39;';
  });
}
function runWordReviewStats(opts){
  opts=opts || {};
  var includePendingWords=!!opts.includePendingWords;
  var lens=runCampaignReviewLengths();
  var out={
    total:0,
    pending:0,
    approved:0,
    rejected:0,
    fileApproved:0,
    fileRejected:0,
    localApproved:0,
    localRejected:0,
    lengths:[]
  };
  for(var i=0;i<lens.length;i++){
    var len=lens[i];
    var info=runWordPool(len, {preferSeed:false, ignoreReview:true});
    var pool=info.pool || [];
    var row={
      len:len,
      source:info.source||'unknown',
      total:pool.length,
      pending:0,
      approved:0,
      rejected:0,
      fileApproved:0,
      fileRejected:0,
      localApproved:0,
      localRejected:0
    };
    if(includePendingWords) row.pendingWords=[];
    for(var j=0;j<pool.length;j++){
      var w=pool[j];
      var status=runWordReviewStatus(w);
      if(status==='approved') row.approved++;
      else if(status==='rejected') row.rejected++;
      else{
        row.pending++;
        if(includePendingWords) row.pendingWords.push(w);
      }
      if(runWordReviewFile.approved[w]) row.fileApproved++;
      if(runWordReviewFile.rejected[w]) row.fileRejected++;
      if(runWordReviewLocal.approved[w]) row.localApproved++;
      if(runWordReviewLocal.rejected[w]) row.localRejected++;
    }
    out.total += row.total;
    out.pending += row.pending;
    out.approved += row.approved;
    out.rejected += row.rejected;
    out.fileApproved += row.fileApproved;
    out.fileRejected += row.fileRejected;
    out.localApproved += row.localApproved;
    out.localRejected += row.localRejected;
    out.lengths.push(row);
  }
  out.fileApprovedEntries=Object.keys(runWordReviewFile.approved).length;
  out.fileRejectedEntries=Object.keys(runWordReviewFile.rejected).length;
  out.localApprovedEntries=Object.keys(runWordReviewLocal.approved).length;
  out.localRejectedEntries=Object.keys(runWordReviewLocal.rejected).length;
  return out;
}
function runPickWordReviewBatch(count, exclude){
  count=clamp(safeInt(count,5),1,50);
  var blocked={};
  if(exclude){
    Object.keys(exclude).forEach(function(w){
      w=lettersOnlyUpper(w||'');
      if(w) blocked[w]=true;
    });
  }
  var out=[];
  var stats=runWordReviewStats({includePendingWords:true});
  while(out.length<count){
    var choices=[];
    for(var i=0;i<stats.lengths.length;i++){
      var row=stats.lengths[i];
      var pendingWords=row.pendingWords || [];
      if(!pendingWords.length) continue;
      var available=pendingWords.filter(function(w){ return !blocked[w]; });
      if(!available.length) continue;
      choices.push({
        len:row.len,
        source:row.source,
        approved:row.approved,
        pending:row.pending,
        total:row.total,
        available:available
      });
    }
    if(!choices.length) break;
    var minApproved=999999;
    for(var j=0;j<choices.length;j++){
      if(choices[j].approved<minApproved) minApproved=choices[j].approved;
    }
    var prioritized=choices.filter(function(c){ return c.approved===minApproved; });
    var maxAvailable=0;
    for(var k=0;k<prioritized.length;k++){
      if(prioritized[k].available.length>maxAvailable) maxAvailable=prioritized[k].available.length;
    }
    var narrowed=prioritized.filter(function(c){ return c.available.length===maxAvailable; });
    var choice=narrowed[(Math.random()*narrowed.length)|0];
    var list=choice.available;
    var pick=list[(Math.random()*list.length)|0];
    blocked[pick]=true;
    out.push({word:pick, len:choice.len, source:choice.source||'unknown'});
  }
  return out;
}
function runEnsureWordReviewBatch(size){
  size=clamp(safeInt(size,5),1,20);
  if(!Array.isArray(runWordReviewBatch)) runWordReviewBatch=[];
  var keep=[];
  var used={};
  for(var i=0;i<runWordReviewBatch.length;i++){
    var row=runWordReviewBatch[i] || {};
    var w=lettersOnlyUpper(row.word||'');
    if(!w || used[w]) continue;
    if(runWordReviewStatus(w)!=='pending') continue;
    used[w]=true;
    keep.push({word:w, len:w.length, source:row.source||'unknown'});
  }
  runWordReviewBatch=keep;
  if(runWordReviewBatch.length>size){
    runWordReviewBatch=runWordReviewBatch.slice(0,size);
    return;
  }
  if(runWordReviewBatch.length<size){
    var fill=runPickWordReviewBatch(size-runWordReviewBatch.length, used);
    runWordReviewBatch=runWordReviewBatch.concat(fill);
  }
}
function runReplaceWordReviewRow(word){
  word=lettersOnlyUpper(word||'');
  if(!word || !runWordReviewBatch || !runWordReviewBatch.length) return;
  var idx=-1;
  for(var i=0;i<runWordReviewBatch.length;i++){
    if(runWordReviewBatch[i] && runWordReviewBatch[i].word===word){
      idx=i;
      break;
    }
  }
  if(idx<0) return;
  var exclude={};
  exclude[word]=true;
  for(var j=0;j<runWordReviewBatch.length;j++){
    if(j===idx) continue;
    var w=lettersOnlyUpper((runWordReviewBatch[j] && runWordReviewBatch[j].word) || '');
    if(w) exclude[w]=true;
  }
  var next=runPickWordReviewBatch(1, exclude);
  if(next.length) runWordReviewBatch[idx]=next[0];
  else runWordReviewBatch.splice(idx,1);
}
function runRenderWordReview(forceNext){
  if(forceNext) runWordReviewBatch=[];
  runEnsureWordReviewBatch(5);
  var stats=runWordReviewStats();
  if(wrStatsEl){
    var fileState=runWordReviewFileMeta.loaded
      ? ('File: '+runWordReviewFileMeta.url)
      : ('File not loaded: '+(runWordReviewFileMeta.lastError || runWordReviewFileUrl || 'unset'));
    var rows=stats.lengths.map(function(row){
      var leftToApprove=Math.max(0, row.total-row.approved);
      return '<div class="wr-line">'
        + '<span class="left">L'+row.len+' approved '+row.approved+'/'+row.total+'</span>'
        + '<span>pending '+row.pending+' | rejected '+row.rejected+' | left '+leftToApprove+'</span>'
        + '</div>';
    }).join('');
    wrStatsEl.innerHTML=
      '<span class="wr-summary">Pending '+stats.pending+' of '+stats.total+' campaign words.</span>'
      + '<span class="wr-summary">Effective totals: approved '+stats.approved+', rejected '+stats.rejected+'.</span>'
      + '<span class="wr-summary">JSON file entries: approved '+stats.fileApprovedEntries+', rejected '+stats.fileRejectedEntries+'. Local entries: approved '+stats.localApprovedEntries+', rejected '+stats.localRejectedEntries+'.</span>'
      + '<span class="wr-summary">'+runEscHtml(fileState)+'</span>'
      + '<span class="wr-summary">'+runEscHtml(runWordReviewSyncStateText())+'</span>'
      + '<div class="wr-lines">'+rows+'</div>';
  }
  if(!wrListEl) return;
  if(!runWordReviewBatch.length){
    wrListEl.innerHTML='<div class="word-review-empty">All currently available campaign words are reviewed.</div>';
    return;
  }
  wrListEl.innerHTML=runWordReviewBatch.map(function(entry){
    var word=lettersOnlyUpper((entry && entry.word) || '');
    var len=safeInt((entry && entry.len) || word.length, word.length);
    var source=runEscHtml(String((entry && entry.source) || 'unknown').toUpperCase());
    return '<div class="word-review-row">'
      + '<div class="word-main">'
      + '<div class="word-review-word">'+word+'</div>'
      + '<div class="word-review-meta">Length '+len+' | Source '+source+'</div>'
      + '</div>'
      + '<div class="word-review-actions">'
      + '<button class="primary" type="button" data-wr-action="approve" data-word="'+word+'">Approve</button>'
      + '<button class="secondary danger" type="button" data-wr-action="reject" data-word="'+word+'">Reject</button>'
      + '<button class="secondary wr-skip" type="button" data-wr-action="skip" data-word="'+word+'">X</button>'
      + '</div>'
      + '</div>';
  }).join('');
}
function openWordReviewModal(){
  if(!wordReviewModal) return;
  runUpdateWordReviewControls();
  runWordReviewBatch=[];
  runRenderWordReview(true);
  wordReviewModal.classList.add('open');
  document.body.style.overflow='hidden';
  runLoadWordReviewFromFile({silent:true}).then(function(){ runRenderWordReview(true); });
  setTimeout(downloadDict,40);
}
function closeWordReviewModal(){
  if(!wordReviewModal) return;
  wordReviewModal.classList.remove('open');
  document.body.style.overflow='';
}
function runApplyWordReviewDecision(word, approved){
  var w=lettersOnlyUpper(word||'');
  if(!w){
    runRenderWordReview(true);
    return;
  }
  if(approved){
    delete runWordReviewLocal.rejected[w];
    runWordReviewLocal.approved[w]=true;
    toast('Approved '+w);
  }else{
    delete runWordReviewLocal.approved[w];
    runWordReviewLocal.rejected[w]=true;
    toast('Rejected '+w);
  }
  runWordReviewSave();
  runRebuildWordReview();
  runReplaceWordReviewRow(w);
  var refreshed=runRefreshFrontierWordsForReview();
  if(refreshed>0 && campaignMenuScreen && campaignMenuScreen.classList.contains('active')){
    buildCampaignMenu();
    requestAnimationFrame(focusCampaignMap);
  }
  runRenderWordReview(false);
  runSaveWordReviewToFile({silent:true}).then(function(ok){
    if(ok) return;
    runSaveWordReviewToRemote({silent:true});
  });
}
function runSkipWordReviewWord(word){
  var w=lettersOnlyUpper(word||'');
  if(!w){
    runRenderWordReview(false);
    return;
  }
  runReplaceWordReviewRow(w);
  runRenderWordReview(false);
}

function downloadDict(){
  try{
    var url=state.dictUrl; if(!url) return;
    if(state._dictLoadedUrl===url) return;
    fetch(url,{mode:'cors',cache:'no-store'}).then(function(res){
      if(!res.ok) throw new Error(res.status);
      return res.text();
    }).then(function(text){
      applyDictText(text);
      // Rebuild a fresh run if it was generated before the remote dictionary loaded.
      try{
        if(runCampaign && runCampaign.version===5 && runCampaign.wordSource==='fallback'){
          var hasProgress =
            safeInt(runCampaign.depth,0)>0 ||
            !!runCampaign.activeNodeId ||
            Object.keys(runCampaign.completed || {}).length>0 ||
            (runCampaign.upgrades || []).length>0;
          var nodeCount = Object.keys(runCampaign.nodes || {}).length;
          if(!hasProgress && nodeCount<=1){
            runRestartCampaign();
            if(campaignMenuScreen && campaignMenuScreen.classList.contains('active')){
              buildCampaignMenu();
              requestAnimationFrame(focusCampaignMap);
            }
          }
        }
      }catch(_){}
      try{
        if(runCampaign && runCampaign.version===5){
          var refreshed=runRefreshFrontierWordsFromRemote();
          if(refreshed>0 && campaignMenuScreen && campaignMenuScreen.classList.contains('active')){
            buildCampaignMenu();
            requestAnimationFrame(focusCampaignMap);
          }
        }
      }catch(_){ }
      state._dictLoadedUrl=url;
      if(!state._dictAutoPicked){
        var empty=true;
        for(var rr=0; rr<state.grid.length; rr++){
          for(var cc=0; cc<state.grid[rr].length; cc++){
            if(state.grid[rr][cc]){ empty=false; break; }
          }
          if(!empty) break;
        }
        if(empty && state.row===0 && state.col===0 && state.target==='CRANE'){
          var L=state.target.length;
          var pool = state.dictLen.get(L) ? Array.from(state.dictLen.get(L)) : [];
          if(pool.length){
            var pick = pool[(Math.random()*pool.length)|0];
            state.target=pick; state.max=recGuesses(pick.length); persistSettings(); buildBoard(); toast('Random: '+pick);
          }
        }
        state._dictAutoPicked=true;
      }
      console.log('[dict] loaded', state.dict.size); toast('Dictionary loaded: '+state.dict.size.toLocaleString());
    }).catch(function(e){ console.error(e); toast('Dictionary download failed') });
  }catch(e){ console.error(e); toast('Dictionary download failed') }
}
function applyDictText(text){
  var lines=text.split('\n').map(function(s){return s.trim().toUpperCase()}).filter(Boolean);
  lines.forEach(function(w){
    if(/^[A-Z]{3,64}$/.test(w)){
      if(!remoteDictLen.has(w.length)) remoteDictLen.set(w.length,new Set());
      remoteDictLen.get(w.length).add(w);
      if(!state.dict.has(w)){
        state.dict.add(w);
        if(!state.dictLen.has(w.length)) state.dictLen.set(w.length,new Set());
        state.dictLen.get(w.length).add(w);
      }
    }
  });
}

var CONFETTI=document.getElementById('confetti'); var confetti=[];
function celebrate(){
  var cs=getComputedStyle(document.documentElement);
  var palette=[cs.getPropertyValue('--correct').trim()||'#6aaa64', cs.getPropertyValue('--near').trim()||'#c9b458', cs.getPropertyValue('--accent').trim()||'#7c8cff', cs.getPropertyValue('--fg').trim()||'#eaf0ff'];
  var W=CONFETTI.width=window.innerWidth; var H=CONFETTI.height=window.innerHeight;
  confetti=[];
  for(var i=0;i<160;i++){
    confetti.push({x:Math.random()*W,y:-20-Math.random()*H*0.3,vx:-1+Math.random()*2,vy:2+Math.random()*3,r:2+Math.random()*6,a:Math.random()*Math.PI*2,s:Math.random()*0.02+0.01,c:palette[(Math.random()*palette.length)|0]});
  }
  requestAnimationFrame(tick);
}
function tick(){
  var ctx=CONFETTI.getContext('2d'); ctx.clearRect(0,0,CONFETTI.width,CONFETTI.height); var alive=false;
  confetti.forEach(function(p){ p.x+=p.vx; p.y+=p.vy; p.a+=p.s; if(p.y<CONFETTI.height+20) alive=true; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); });
  if(alive) requestAnimationFrame(tick);
}
var WIN_BURST=$('#winBurst');
function celebrateLevel(){
  if(!WIN_BURST) return;
  var hue = Math.floor(Math.random()*360);
  WIN_BURST.style.setProperty('--burst-h', hue);
  WIN_BURST.classList.remove('play');
  void WIN_BURST.offsetWidth;
  WIN_BURST.classList.add('play');
}

var menuScreen=$('#menuScreen');
var campaignMenuScreen=$('#campaignMenuScreen');
var sandboxBtn=$('#btnSandbox');
var hotseatBtn=$('#btnHotseat');
var optionsBtn=$('#btnOptions');
var campaignOpenBtn=$('#btnCampaignOpen');
var campaignBackBtn=$('#btnCampaignBack');
var campaignMapEl=$('#campaignMap');
var campaignNodesEl=$('#campaignNodes');
var campaignSvg=$('#campaignSvg');
var campaignPanEl=$('#campaignPan');
var menuBtn=$('#btnMenu');
var menuFsBtn=$('#btnMenuFS');
var coinDisplay=$('#coinDisplay');
var campaignShopEl=$('#campaignShop');
var shopConsumablesEl=$('#shopConsumables');
var shopPermanentsEl=$('#shopPermanents');
var shopFreeChoiceEl=$('#shopFreeChoice');
var shopSubtitleEl=$('#shopSubtitle');
var shopSkipBtn=$('#shopSkip');
var shopContinueBtn=$('#shopContinue');
var hsStartBtn=$('#hsStart');
var hsCloseBtn=$('#hsClose');
var wordReviewBtn=$('#btnWordReview');
var wordReviewModal=$('#wordReviewModal');
var wrListEl=$('#wrList');
var wrStatsEl=$('#wrStats');
var wrCloseBtn=$('#wrClose');
var wrReloadBtn=$('#wrReload');
var wrBindFileBtn=$('#wrBindFile');
var wrSaveFileBtn=$('#wrSaveFile');
var runWordReviewBatch=[];
var runWordReviewFileHandle=null;
var runWordReviewFileSync={lastOk:0,lastError:'',lastTarget:''};
var started=false;
var activeCampaign=null;
var currency=load('currency', 0);

function setBodyMode(mode){
  document.body.classList.remove('mode-campaign','mode-sandbox','mode-atlas','mode-hotseat','hs-turn-red','hs-turn-blue');
  if(mode) document.body.classList.add('mode-'+mode);
}
function setCampaignBossMode(on){
  document.body.classList.toggle('campaign-boss', !!on);
}
function removeKey(k){try{localStorage.removeItem(k)}catch(e){}}
function saveCurrency(){ save('currency', currency); if(coinDisplay) coinDisplay.textContent='Coins: '+currency; }
function campaignKey(id){ return 'campaign:'+id; }
function addIntroItem(parent, label, value){
  var item=document.createElement('div');
  item.className='intro-item';
  var k=document.createElement('span');
  k.textContent=label;
  item.appendChild(k);
  if(Array.isArray(value)){
    if(value.length===0){
      var none=document.createElement('div');
      none.className='intro-val';
      none.textContent='None';
      item.appendChild(none);
    }else{
      var tags=document.createElement('div');
      tags.className='intro-tags';
      var maxTags = (label==='Mutators') ? 5 : value.length;
      var visible = value.slice(0, maxTags);
      var hidden = value.slice(maxTags);
      visible.forEach(function(tagInfo){
        var tagLabel=tagInfo;
        var tagHelp='';
        if(tagInfo && typeof tagInfo==='object'){
          tagLabel=tagInfo.label || '';
          if(tagInfo.help){ tagHelp=tagInfo.help; }
          else if(tagInfo.key && MUTATOR_HELP[tagInfo.key]){ tagHelp=MUTATOR_HELP[tagInfo.key]; }
        }
        var t=document.createElement('div');
        t.className='intro-tag';
        t.textContent=tagLabel;
        if(tagHelp){
          t.setAttribute('data-help', tagHelp);
          t.setAttribute('role','button');
          t.setAttribute('tabindex','0');
          t.setAttribute('title','Tap for details');
        }
        tags.appendChild(t);
      });
      if(hidden.length){
        var more=document.createElement('div');
        more.className='intro-tag intro-tag-more';
        more.textContent='(+'+hidden.length+' more)';
        var hiddenLabels = hidden.map(function(info){
          if(info && typeof info==='object'){ return info.label || ''; }
          return info;
        }).filter(function(v){ return !!v; });
        if(hiddenLabels.length){
          more.setAttribute('data-more', hiddenLabels.join(', '));
          more.setAttribute('role','button');
          more.setAttribute('tabindex','0');
          more.setAttribute('title','Show more mutators');
        }
        tags.appendChild(more);
      }
      item.appendChild(tags);
    }
  }else{
    var v=document.createElement('div');
    v.className='intro-val';
    v.textContent=value;
    item.appendChild(v);
  }
  parent.appendChild(item);
}
function packWordStats(set){
  var min=999, max=0, starters=0;
  var total=set.words ? set.words.length : 0;
  for(var i=0;i<total;i++){
    var entry=wordEntry(set, i);
    var w=lettersOnlyUpper(entry.word || '');
    if(w){ min=Math.min(min, w.length); max=Math.max(max, w.length); }
    if(entry.starter) starters++;
  }
  if(min===999){ min=0; max=0; }
  return {min:min,max:max,starters:starters,total:total};
}
function packGuessRange(set, stats){
  if(set && typeof set.maxGuesses==='number'){
    return {min:set.maxGuesses,max:set.maxGuesses,fixed:true};
  }
  var min=999, max=0;
  for(var i=0;i<stats.total;i++){
    var entry=wordEntry(set, i);
    var w=lettersOnlyUpper(entry.word || '');
    if(!w) continue;
    var g=campaignMaxGuesses(set, w.length, !!entry.starter);
    min=Math.min(min, g); max=Math.max(max, g);
  }
  if(min===999){ min=0; max=0; }
  return {min:min,max:max,fixed:(min===max)};
}
function seedStarterGuess(starter){
  starter=lettersOnlyUpper(starter);
  if(!starter || starter.length!==state.target.length) return;
  for(var i=0;i<starter.length;i++){ setTile(0,i,starter[i]); }
  state.row=0;
  state.col=starter.length;
  submitRow(true, {skipAnim:true, skipFlash:true});
}
// --- Run campaign override: long-form branching atlas with upgrades and elite nodes ---
var RUN_CAMPAIGN_KEY='campaign_run_v5';
var RUN_SET_PREFIX='runset:';
var RUN_CLUSTER_DEPTH=8;
var RUN_UPGRADE_STAGES=[3,6];
var RUN_RUNTIME_SETS={};
var runCampaign=load(RUN_CAMPAIGN_KEY, null);
var runFailPendingReset=false;
var RUN_WORD_REVIEW_KEY='campaign_word_review_v1';
var RUN_WORD_REVIEW_FILE_KEY='campaign_word_review_file_url';
var RUN_WORD_REVIEW_WRITE_KEY='campaign_word_review_write_url';
var runWordReviewDefaultUrl=(location && location.protocol!=='file:') ? '/.netlify/functions/word-review' : 'campaign_words.json';
var runWordReviewFileUrl=String(load(RUN_WORD_REVIEW_FILE_KEY,runWordReviewDefaultUrl)||runWordReviewDefaultUrl);
if((runWordReviewFileUrl||'').trim().toLowerCase()==='campaign_words.json' && location && location.protocol!=='file:'){
  runWordReviewFileUrl='/.netlify/functions/word-review';
  save(RUN_WORD_REVIEW_FILE_KEY, runWordReviewFileUrl);
}
var runWordReviewWriteUrl=String(load(RUN_WORD_REVIEW_WRITE_KEY,'/.netlify/functions/word-review')||'/.netlify/functions/word-review');
var runWordReviewFile=runNormalizeWordReview(null);
var runWordReviewLocal=runNormalizeWordReview(load(RUN_WORD_REVIEW_KEY, null));
var runWordReview=runMergeWordReview(runWordReviewFile, runWordReviewLocal);
var runWordReviewFileMeta={url:'',loaded:false,lastError:''};
function runNormalizeWordReview(raw){
  raw=raw||{};
  var approved={};
  var rejected={};
  function addWords(list, into){
    if(!Array.isArray(list)) return;
    for(var i=0;i<list.length;i++){
      var w=lettersOnlyUpper(list[i]||'');
      if(!/^[A-Z]{4,8}$/.test(w)) continue;
      if(!runReadableWord(w)) continue;
      into[w]=true;
    }
  }
  addWords(raw.approved, approved);
  addWords(raw.rejected, rejected);
  Object.keys(rejected).forEach(function(w){ delete approved[w]; });
  return {approved:approved, rejected:rejected};
}
function runMergeWordReview(base, overlay){
  base=runNormalizeWordReview(base);
  overlay=runNormalizeWordReview(overlay);
  var out={approved:{}, rejected:{}};
  Object.keys(base.approved).forEach(function(w){ out.approved[w]=true; });
  Object.keys(overlay.approved).forEach(function(w){ out.approved[w]=true; });
  Object.keys(base.rejected).forEach(function(w){ out.rejected[w]=true; });
  Object.keys(overlay.rejected).forEach(function(w){ out.rejected[w]=true; });
  Object.keys(out.rejected).forEach(function(w){ delete out.approved[w]; });
  return out;
}
function runRebuildWordReview(){
  runWordReview=runMergeWordReview(runWordReviewFile, runWordReviewLocal);
}
function runWordReviewSave(){
  save(RUN_WORD_REVIEW_KEY, {
    approved:Object.keys(runWordReviewLocal.approved).sort(),
    rejected:Object.keys(runWordReviewLocal.rejected).sort()
  });
}
function runWordReviewMergedSnapshot(){
  return runMergeWordReview(runWordReviewFile, runWordReviewLocal);
}
function runWordReviewSerialize(snapshot){
  var snap=snapshot || runWordReviewMergedSnapshot();
  return JSON.stringify({
    approved:Object.keys(snap.approved).sort(),
    rejected:Object.keys(snap.rejected).sort()
  }, null, 2) + '\n';
}
function runWordReviewRemoteWritable(){
  var u=String(runWordReviewWriteUrl||'').trim();
  if(!u) return false;
  if(/^\/\.netlify\/functions\/word-review(?:\?|$)/i.test(u)) return true;
  return /^https?:\/\/[^\s]+\/\.netlify\/functions\/word-review(?:\?|$)/i.test(u);
}
function runWordReviewSyncStateText(){
  var target='Write target: ' + ((runWordReviewFileHandle && runWordReviewFileHandle.name) ? runWordReviewFileHandle.name : (runWordReviewRemoteWritable() ? ('cloud '+runWordReviewWriteUrl) : 'not bound'));
  var status='';
  if(runWordReviewFileSync.lastOk){
    status='Last file save: ' + new Date(runWordReviewFileSync.lastOk).toLocaleString();
  }else if(runWordReviewFileSync.lastError){
    status='Last file save failed: ' + runWordReviewFileSync.lastError;
  }else{
    status='Last file save: none';
  }
  return target + ' | ' + status;
}
async function runBindWordReviewFile(){
  if(!window.isSecureContext || !window.showOpenFilePicker){
    toast('Direct file writing is not supported here. Use Save Now for cloud sync.');
    return false;
  }
  try{
    var handles=await window.showOpenFilePicker({
      multiple:false,
      types:[{description:'JSON files',accept:{'application/json':['.json']}}]
    });
    if(!handles || !handles.length) return false;
    runWordReviewFileHandle=handles[0];
    if(runWordReviewFileHandle && runWordReviewFileHandle.requestPermission){
      try{
        var perm=await runWordReviewFileHandle.requestPermission({mode:'readwrite'});
        if(perm==='denied'){
          runWordReviewFileSync.lastError='permission denied';
          toast('Write permission denied.');
          runRenderWordReview(false);
          return false;
        }
      }catch(_){ }
    }
    runWordReviewFileSync.lastTarget=runWordReviewFileHandle.name || 'bound file';
    runWordReviewFileSync.lastError='';
    toast('Bound file: '+runWordReviewFileSync.lastTarget);
    runRenderWordReview(false);
    return true;
  }catch(e){
    if(e && e.name==='AbortError') return false;
    runWordReviewFileSync.lastError=String((e && e.message) || e || 'bind failed');
    toast('Could not bind file.');
    console.error(e);
    runRenderWordReview(false);
    return false;
  }
}
async function runSaveWordReviewToFile(opts){
  opts=opts || {};
  if(!runWordReviewFileHandle || !runWordReviewFileHandle.createWritable){
    if(!opts.silent) toast('Bind a JSON file first.');
    return false;
  }
  try{
    if(runWordReviewFileHandle.queryPermission){
      var perm='prompt';
      try{ perm=await runWordReviewFileHandle.queryPermission({mode:'readwrite'}); }catch(_){ }
      if(perm!=='granted' && runWordReviewFileHandle.requestPermission){
        try{ perm=await runWordReviewFileHandle.requestPermission({mode:'readwrite'}); }catch(_){ }
      }
      if(perm==='denied'){
        runWordReviewFileSync.lastError='permission denied';
        if(!opts.silent) toast('Write permission denied.');
        runRenderWordReview(false);
        return false;
      }
    }

    var snapshot=runWordReviewMergedSnapshot();
    var writable=await runWordReviewFileHandle.createWritable();
    await writable.write(runWordReviewSerialize(snapshot));
    await writable.close();

    runWordReviewFile=runNormalizeWordReview({
      approved:Object.keys(snapshot.approved),
      rejected:Object.keys(snapshot.rejected)
    });
    runWordReviewLocal=runNormalizeWordReview(null);
    runWordReviewSave();
    runRebuildWordReview();

    runWordReviewFileSync.lastTarget=runWordReviewFileHandle.name || 'bound file';
    runWordReviewFileSync.lastOk=Date.now();
    runWordReviewFileSync.lastError='';

    if(!opts.silent) toast('Word review file saved.');
    runRenderWordReview(false);
    return true;
  }catch(e){
    runWordReviewFileSync.lastError=String((e && e.message) || e || 'save failed');
    if(!opts.silent) toast('Saving review file failed.');
    console.error(e);
    runRenderWordReview(false);
    return false;
  }
}
async function runSaveWordReviewToRemote(opts){
  opts=opts || {};
  var url=String(runWordReviewWriteUrl||'').trim();
  if(!runWordReviewRemoteWritable()){
    if(!opts.silent) toast('Cloud API not configured. Expected '+runWordReviewWriteUrl);
    return false;
  }
  try{
    var snapshot=runWordReviewMergedSnapshot();
    var payload={
      approved:Object.keys(snapshot.approved).sort(),
      rejected:Object.keys(snapshot.rejected).sort()
    };
    var res=await fetch(url,{
      method:'POST',
      mode:'cors',
      cache:'no-store',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(!res.ok){
      var body=await res.text();
      var msg='HTTP '+res.status+' at '+url;
      if(body){
        try{
          var parsedErr=JSON.parse(body);
          if(parsedErr && (parsedErr.error || parsedErr.hint)){
            msg += ' - ' + (parsedErr.error || 'request failed');
            if(parsedErr.hint) msg += ' ('+parsedErr.hint+')';
          }else{
            msg += ' - ' + body.slice(0,180);
          }
        }catch(_){
          msg += ' - ' + String(body).slice(0,180);
        }
      }
      throw new Error(msg);
    }
    var text=await res.text();
    var parsed=payload;
    if(text && String(text).trim()){
      try{ parsed=JSON.parse(text); }catch(_){ }
    }

    runWordReviewFile=runNormalizeWordReview(parsed);
    runWordReviewLocal=runNormalizeWordReview(null);
    runWordReviewSave();
    runRebuildWordReview();

    runWordReviewFileSync.lastTarget='cloud '+url;
    runWordReviewFileSync.lastOk=Date.now();
    runWordReviewFileSync.lastError='';

    if(!opts.silent) toast('Cloud word review save complete.');
    runRenderWordReview(false);
    return true;
  }catch(e){
    runWordReviewFileSync.lastError=String((e && e.message) || e || 'remote save failed');
    if(!opts.silent) toast('Cloud word review save failed.');
    console.error(e);
    runRenderWordReview(false);
    return false;
  }
}
function runSetWordReviewFileUrl(url){
  runWordReviewFileUrl=String(url||'').trim();
  save(RUN_WORD_REVIEW_FILE_KEY, runWordReviewFileUrl);
  if(/\/\.netlify\/functions\/word-review(?:\?|$)/i.test(runWordReviewFileUrl)){
    runWordReviewWriteUrl=runWordReviewFileUrl;
    save(RUN_WORD_REVIEW_WRITE_KEY, runWordReviewWriteUrl);
  }
}
function runUpdateWordReviewControls(){
  var supportsFile=!!(window.isSecureContext && window.showOpenFilePicker);
  if(wrBindFileBtn){
    wrBindFileBtn.style.display = supportsFile ? '' : 'none';
  }
  if(wrSaveFileBtn){
    wrSaveFileBtn.textContent = supportsFile ? 'Save Now' : 'Save to Cloud';
    wrSaveFileBtn.title = supportsFile ? '' : 'Direct file write unsupported on this browser; saves via cloud API.';
  }
}
function runWordReviewStatus(word){
  word=lettersOnlyUpper(word||'');
  if(!word) return 'pending';
  if(runWordReview.rejected[word]) return 'rejected';
  if(runWordReview.approved[word]) return 'approved';
  return 'pending';
}
function runFilterReviewedCampaignWords(pool){
  var list=(pool||[]).filter(function(w){ return !runWordReview.rejected[w]; });
  if(!list.length) return list;
  var approved=list.filter(function(w){ return !!runWordReview.approved[w]; });
  if(!approved.length) return list;
  if(approved.length>=12 || approved.length===list.length) return approved;
  var weighted=list.slice();
  for(var i=0;i<approved.length;i++){
    weighted.push(approved[i]);
    weighted.push(approved[i]);
  }
  return weighted;
}
function runClusterWordLenRange(cluster){
  var c=Math.max(1, safeInt(cluster,1));
  if(c<=1) return {min:5,max:6};
  if(c===2) return {min:5,max:7};
  return {min:4,max:8};
}
function runArchetypeMutatorCount(arch){
  var mut=(arch && arch.mutators) ? arch.mutators : {};
  var count=0;
  Object.keys(mut).forEach(function(k){
    if(mut[k]===true) count++;
  });
  return count;
}
function runArchetypeTier(arch){
  if(!arch) return 2;
  var mut=(arch.mutators||{});
  var score=0;
  if(arch.difficulty==='hard') score += 2;
  if((arch.displayDifficulty||'')==='insane') score += 2;
  else if((arch.displayDifficulty||'')==='hard') score += 1;
  var mutCount=runArchetypeMutatorCount(arch);
  if(mutCount>=3) score += 1;
  if(mut.countdown) score += 1;
  if(mut.hotPotato) score += 1;
  if(mut.minDistance) score += 1;
  if(mut.copycat) score += 1;
  if(mut.randomKeyboard || mut.drift || mut.noisyArrows || mut.phantomLetter || mut.bloodMirage) score += 1;
  if((arch.maxGuesses||6)<=5) score += 1;
  if(score<=3) return 1;
  if(score<=6) return 2;
  return 3;
}
function runArchetypeWeight(arch, cluster, isBoss){
  var tier=runArchetypeTier(arch);
  var c=Math.max(1, safeInt(cluster,1));
  if(c<=1){
    if(tier===1) return isBoss ? 3 : 8;
    if(tier===2) return isBoss ? 5 : 3;
    return isBoss ? 2 : 0;
  }
  if(c===2){
    if(tier===1) return isBoss ? 2 : 4;
    if(tier===2) return isBoss ? 5 : 5;
    return isBoss ? 5 : 2;
  }
  if(c===3){
    if(tier===1) return isBoss ? 1 : 2;
    if(tier===2) return isBoss ? 4 : 4;
    return isBoss ? 7 : 6;
  }
  if(tier===1) return isBoss ? 0.6 : 1;
  if(tier===2) return isBoss ? 2.5 : 3;
  return isBoss ? 7 : 8;
}
function runCountdownVarianceSpan(cluster, nodeType){
  var c=Math.max(1, safeInt(cluster,1));
  var span=(c<=1) ? 2 : (c===2 ? 3 : 4);
  if(nodeType==='elite') span += 1;
  if(nodeType==='boss') span += 2;
  return clamp(span,1,9);
}
function runApplyCountdownVariance(mut, cluster, nodeType){
  if(!mut || !mut.countdown) return;
  var base=clamp(safeInt(mut.countdownSec,30),5,120);
  var span=runCountdownVarianceSpan(cluster, nodeType);
  var jitter=((runRandom()*((span*2)+1))|0)-span;
  mut.countdownSec=clamp(base+jitter,5,120);
}
var RUN_ARCHETYPES=[
  {
    id:'tempo',
    title:'Tempo Shift',
    difficulty:'normal',
    displayDifficulty:'normal',
    intro:'Countdown pressure with readable hints.',
    maxGuesses:6,
    lengthBase:5,
    wordCount:2,
    starter:true,
    mutators:{countdown:true,countdownAutoStart:true,countdownSec:24,countdownKeyCenti:3}
  },
  {
    id:'haze',
    title:'Haze Weave',
    difficulty:'normal',
    displayDifficulty:'hard',
    intro:'Fog pressure with lifeline support.',
    maxGuesses:6,
    lengthBase:5,
    wordCount:2,
    starter:true,
    mutators:{fog:true,lifeline:true,lifelineCount:1}
  },
  {
    id:'economy',
    title:'Letter Economy',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Budgeted guesses and constrained movement.',
    maxGuesses:12,
    lengthBase:5,
    wordCount:2,
    starter:false,
    mutators:{budget:true,budgetPoints:60,copycat:true,copycatMin:2}
  },
  {
    id:'chaos',
    title:'Static Noise',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'High variance hints and unstable keyboarding.',
    maxGuesses:5,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{drift:true,noisyArrows:true,doubleVision:true,randomKeyboard:true}
  },
  {
    id:'precision',
    title:'Edge Discipline',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Positional constraints with strict movement.',
    maxGuesses:5,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{hotPotato:true,minDistance:true,minDistanceVal:11}
  },
  {
    id:'relay',
    title:'Echo Relay',
    difficulty:'normal',
    displayDifficulty:'hard',
    intro:'Carry greens forward while opening blind.',
    maxGuesses:6,
    lengthBase:5,
    wordCount:2,
    starter:true,
    mutators:{echo:true,blindStart:true}
  },
  {
    id:'prism',
    title:'Prism Mirror',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Mirror flips plus double-vision noise.',
    maxGuesses:6,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{mirror:true,doubleVision:true}
  },
  {
    id:'lockgrid',
    title:'Lock Grid',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Static columns and echo pressure stack up.',
    maxGuesses:6,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{staticTile:true,echo:true}
  },
  {
    id:'lowlight',
    title:'Lowlight Crawl',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Fog and phantom hints with limited lifelines.',
    maxGuesses:6,
    lengthBase:6,
    wordCount:2,
    starter:true,
    mutators:{fog:true,phantomLetter:true,lifeline:true,lifelineCount:1}
  },
  {
    id:'signalstorm',
    title:'Signal Storm',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Arrow noise and blood mirage distortion.',
    maxGuesses:5,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{noisyArrows:true,bloodMirage:true}
  },
  {
    id:'scramble',
    title:'Scramble Script',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Keyboard shuffles while copycat stays strict.',
    maxGuesses:6,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{randomKeyboard:true,copycat:true,copycatMin:3}
  },
  {
    id:'pulsechain',
    title:'Pulse Chain',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Fast countdown with hot potato constraints.',
    maxGuesses:6,
    lengthBase:5,
    wordCount:2,
    starter:false,
    mutators:{countdown:true,countdownAutoStart:true,countdownSec:20,countdownKeyCenti:4,hotPotato:true}
  },
  {
    id:'rationline',
    title:'Ration Line',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Budget ceiling plus minimum-distance tax.',
    maxGuesses:10,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{budget:true,budgetPoints:56,minDistance:true,minDistanceVal:10}
  },
  {
    id:'driftcore',
    title:'Drift Core',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Letters drift while copycat tracks overlap.',
    maxGuesses:6,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{drift:true,copycat:true,copycatMin:2}
  },
  {
    id:'voweltax',
    title:'Vowel Tax',
    difficulty:'hard',
    displayDifficulty:'hard',
    intro:'Vowel gating paired with distance checks.',
    maxGuesses:7,
    lengthBase:5,
    wordCount:2,
    starter:true,
    mutators:{vowelsOnly:true,minDistance:true,minDistanceVal:9}
  },
  {
    id:'wildlab',
    title:'Wildcard Lab',
    difficulty:'normal',
    displayDifficulty:'hard',
    intro:'One wildcard bailout inside budget pressure.',
    maxGuesses:8,
    lengthBase:5,
    wordCount:2,
    starter:true,
    mutators:{wildcard:true,budget:true,budgetPoints:58}
  },
  {
    id:'mirrordrift',
    title:'Mirror Drift',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Mirror flips on top of drift and double vision.',
    maxGuesses:5,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{mirror:true,drift:true,doubleVision:true}
  },
  {
    id:'blackout',
    title:'Blackout Protocol',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Blind opening, fog, and a running clock.',
    maxGuesses:6,
    lengthBase:5,
    wordCount:2,
    starter:false,
    mutators:{blindStart:true,fog:true,countdown:true,countdownAutoStart:true,countdownSec:22,countdownKeyCenti:3}
  },
  {
    id:'staticfuse',
    title:'Static Fuse',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Locked tile plus hot potato and copycat.',
    maxGuesses:5,
    lengthBase:6,
    wordCount:2,
    starter:false,
    mutators:{staticTile:true,hotPotato:true,copycat:true,copycatMin:2}
  },
  {
    id:'overclock',
    title:'Overclock Ruin',
    difficulty:'hard',
    displayDifficulty:'insane',
    intro:'Clock pressure with keyboard instability and noisy hints.',
    maxGuesses:5,
    lengthBase:7,
    wordCount:2,
    starter:false,
    mutators:{countdown:true,countdownAutoStart:true,countdownSec:18,countdownKeyCenti:5,randomKeyboard:true,noisyArrows:true,phantomLetter:true}
  }
];
var RUN_UPGRADES=[
  {id:'uplife',label:'Lifeline Core',desc:'+1 lifeline each pack.',stackable:true,maxStacks:3},
  {id:'uptime',label:'Time Bank',desc:'Countdown gets +5s (or starts at 22s).',stackable:true,maxStacks:3},
  {id:'upguess',label:'Extra Guess',desc:'+1 max guess on all future packs.',stackable:true,maxStacks:3},
  {id:'upsignal',label:'Signal Cleaner',desc:'Removes Noisy Arrows and Phantom Letter.',stackable:false},
  {id:'upwild',label:'Wildcard Chip',desc:'Enable wildcard mutator for the run.',stackable:false},
  {id:'upbudget',label:'Reserve Cache',desc:'+12 budget points if budget is active.',stackable:true,maxStacks:3},
  {id:'upclarity',label:'Clarity Lens',desc:'Removes Double Vision and Blood Mirage.',stackable:false},
  {id:'upstability',label:'Stability Coil',desc:'Removes Drift and Random Keyboard.',stackable:false},
  {id:'upreward',label:'Bounty Wire',desc:'+2 coin reward on all future nodes.',stackable:true,maxStacks:3},
  {id:'upstarter',label:'Scout Relay',desc:'Future nodes get stronger starter clues.',stackable:false}
];
var RUN_SHOP_CONSUMABLES=[
  {id:'c_guess',label:'Guess Tonic',desc:'+1 guess on every node this cluster.',min:10,max:18},
  {id:'c_life',label:'Lifeline Patch',desc:'+1 lifeline on every node this cluster.',min:11,max:20},
  {id:'c_time',label:'Chrono Syrup',desc:'Countdown +6s this cluster.',min:12,max:21},
  {id:'c_budget',label:'Budget Cache',desc:'Budget +14 this cluster.',min:10,max:19},
  {id:'c_reward',label:'Coin Magnet',desc:'+2 coins reward per node this cluster.',min:13,max:22},
  {id:'c_clean',label:'Signal Scrubber',desc:'Noisy Arrows and Phantom Letter are removed this cluster.',min:12,max:21},
  {id:'c_relief',label:'Distance Relief',desc:'Minimum distance requirement drops by 2 this cluster.',min:11,max:20},
  {id:'c_wild',label:'Wildcard Ink',desc:'Wildcard mutator enabled this cluster.',min:10,max:18}
];
var RUN_SHOP_PERMANENTS=[
  {id:'p_guess',label:'Synapse Slot',desc:'Permanent +1 guess.',min:62,max:92},
  {id:'p_life',label:'Bio Core',desc:'Permanent +1 lifeline.',min:70,max:104},
  {id:'p_time',label:'Chrono Lattice',desc:'Permanent countdown +4s.',min:68,max:102},
  {id:'p_budget',label:'Vault Backbone',desc:'Permanent budget +10.',min:66,max:98},
  {id:'p_reward',label:'Investor Loop',desc:'Permanent +2 node reward.',min:74,max:110},
  {id:'p_clean',label:'Static Filter',desc:'Permanent signal cleanup (no noisy arrows/phantom).',min:76,max:118}
];
var RUN_CLUSTER_TRAITS=[
  {id:'t_glass',label:'Glass Reactor',up:'+4 reward on every node.',down:'-1 max guess on every node.'},
  {id:'t_guard',label:'Guarded Protocol',up:'+1 guess and +1 lifeline.',down:'Countdown -4s and budget -8.'},
  {id:'t_surge',label:'Surge Channel',up:'Countdown +8s and signal cleanup.',down:'Minimum distance gets +2 and is always active.'},
  {id:'t_hoard',label:'Hoard Engine',up:'Budget +22 and wildcard always on.',down:'Node reward -2 and all starter hints disabled.'},
  {id:'t_precision',label:'Precision Tax',up:'+1 reward and +1 guess.',down:'Hot potato always active and stricter by 1.'}
];
function runDefaultTempBuffs(){
  return {
    guess:0,
    lifeline:0,
    countdown:0,
    budget:0,
    reward:0,
    signalClean:false,
    minDistanceRelief:0,
    wildcard:false
  };
}
function runDefaultPermBuffs(){
  return {
    guess:0,
    lifeline:0,
    countdown:0,
    budget:0,
    reward:0,
    signalClean:false
  };
}
function runClone(obj){
  return JSON.parse(JSON.stringify(obj));
}
function runSave(){
  save(RUN_CAMPAIGN_KEY, runCampaign);
}
function runNodeFromSetId(setId){
  if(typeof setId!=='string') return null;
  if(setId.indexOf(RUN_SET_PREFIX)!==0) return null;
  return setId.slice(RUN_SET_PREFIX.length);
}
function runGetUpgrade(id){
  for(var i=0;i<RUN_UPGRADES.length;i++){
    if(RUN_UPGRADES[i].id===id) return RUN_UPGRADES[i];
  }
  return null;
}
function runUpgradeOwnedCount(id){
  var n=0;
  (runCampaign.upgrades||[]).forEach(function(upId){ if(upId===id) n++; });
  return n;
}
function runUpgradeCanRoll(up, blocked){
  if(!up) return false;
  blocked=blocked || {};
  if(blocked[up.id]) return false;
  var owned=runUpgradeOwnedCount(up.id);
  if(up.stackable){
    if(typeof up.maxStacks==='number' && owned>=up.maxStacks) return false;
    return true;
  }
  return owned<=0;
}
function runClusterHueDeg(cluster){
  var c=Math.max(1, safeInt(cluster,1));
  return Math.round((c*137.508)%360);
}
function runIsPackNodeType(type){
  return type==='pack' || type==='boss' || type==='elite';
}
function runRandom(){
  if(!runCampaign) return Math.random();
  runCampaign.seed = ((runCampaign.seed * 1664525) + 1013904223) >>> 0;
  return runCampaign.seed / 4294967296;
}
function runNextNodeId(){
  runCampaign.nodeCounter = safeInt(runCampaign.nodeCounter,0) + 1;
  return 'c'+runCampaign.cluster+'n'+runCampaign.nodeCounter;
}
function runCreateState(seedVal){
  return {
    version:5,
    seed:(typeof seedVal==='number'?seedVal:Date.now())>>>0,
    cluster:1,
    depth:0,
    nodeCounter:0,
    upgrades:[],
    permanentBuffs:runDefaultPermBuffs(),
    tempBuffs:runDefaultTempBuffs(),
    clusterTraits:[],
    pendingShop:null,
    nodes:{},
    links:[],
    frontier:[],
    completed:{},
    skipped:{},
    activeNodeId:null,
    wordSource:'unknown',
    usedWords:{}
  };
}
function runReadableWord(w){
  w=lettersOnlyUpper(w||'');
  if(!/^[A-Z]{3,64}$/.test(w)) return false;
  if(!/[AEIOUY]/.test(w)) return false;
  if(/(.)\1\1/.test(w)) return false;
  return true;
}
function runCommonSeedPool(len){
  return seed.filter(function(w){ return w.length===len && runReadableWord(w); });
}
function runWordPool(len, opts){
  opts=opts || {};
  var ignoreReview=!!opts.ignoreReview;
  function filterPool(list){
    list=(list||[]).filter(runReadableWord);
    if(ignoreReview) return list;
    return runFilterReviewedCampaignWords(list);
  }
  if(opts.preferSeed){
    var corePool=filterPool(runCommonSeedPool(len));
    if(corePool.length){
      return {pool:corePool, source:'seed'};
    }
  }
  // Prefer downloaded dictionary for campaign generation.
  var remotePool = remoteDictLen.get(len) ? Array.from(remoteDictLen.get(len)) : [];
  remotePool = filterPool(remotePool);
  if(remotePool.length){
    return {pool:remotePool, source:'remote'};
  }
  var pool = state.dictLen.get(len) ? Array.from(state.dictLen.get(len)) : [];
  pool = filterPool(pool);
  if(!pool.length){
    pool = filterPool(runCommonSeedPool(len));
  }
  return {pool:pool, source:pool.length?'fallback':'empty'};
}

function runPickWord(len, opts){
  var picked=runWordPool(len, opts);
  var pool=picked.pool || [];
  if(!pool.length){
    var fallback = runCommonSeedPool(len);
    if(!(opts && opts.ignoreReview)){ fallback=runFilterReviewedCampaignWords(fallback); }
    if(!fallback.length){
      if(runCampaign && runCampaign.wordSource!=='remote') runCampaign.wordSource='fallback';
      return 'CRANE';
    }
    var forced=fallback[(runRandom()*fallback.length)|0];
    if(runCampaign && runCampaign.wordSource!=='remote') runCampaign.wordSource='fallback';
    runCampaign.usedWords[forced]=true;
    return forced;
  }
  if(runCampaign){
    if(picked.source==='remote') runCampaign.wordSource='remote';
    else if(runCampaign.wordSource!=='remote') runCampaign.wordSource='fallback';
  }
  var fresh=pool.filter(function(w){ return !runCampaign.usedWords[w]; });
  var src=fresh.length?fresh:pool;
  var pick=src[(runRandom()*src.length)|0];
  runCampaign.usedWords[pick]=true;
  return pick;
}
function runYellowCapForDifficulty(difficulty){
  var d=effectiveDifficulty(difficulty);
  return d==='impossible' ? 3 : 9;
}
function runCountStarterYellows(target, starter, difficulty){
  target=lettersOnlyUpper(target||'');
  starter=lettersOnlyUpper(starter||'');
  if(!target || !starter || target.length!==starter.length) return 0;
  var cap=runYellowCapForDifficulty(difficulty);
  var count=0;
  for(var i=0;i<target.length;i++){
    var dist=Math.abs(aIdx(target[i]) - aIdx(starter[i]));
    if(dist>0 && dist<=cap) count++;
  }
  return count;
}
function runStarterStepRange(difficulty){
  var cap=runYellowCapForDifficulty(difficulty);
  var minStep=(effectiveDifficulty(difficulty)==='easy') ? 4 : 1;
  if(minStep>cap) minStep=1;
  return {min:minStep,max:Math.max(minStep, cap)};
}
function runMakeStarter(word, minYellow, difficulty){
  var chars=word.split('');
  if(!chars.length) return '';
  var need=Math.max(0, safeInt(minYellow,0));
  var stepRange=runStarterStepRange(difficulty);
  if(need<=0){
    var idx=(runRandom()*chars.length)|0;
    var base0=aIdx(chars[idx]);
    var step0=stepRange.min + ((runRandom()*(stepRange.max-stepRange.min+1))|0);
    if(runRandom()<0.5) step0*=-1;
    var nextIdx0=base0+step0;
    if(nextIdx0<0) nextIdx0=base0+Math.abs(step0);
    if(nextIdx0>25) nextIdx0=base0-Math.abs(step0);
    nextIdx0=clamp(nextIdx0,0,25);
    if(nextIdx0===base0) nextIdx0=(base0===25)?24:base0+1;
    chars[idx]=String.fromCharCode(65+nextIdx0);
    return chars.join('');
  }
  var picks=Math.min(chars.length, need);
  var used={};
  for(var n=0;n<picks;n++){
    var at=(runRandom()*chars.length)|0;
    while(used[at]) at=(at+1)%chars.length;
    used[at]=true;
    var base=aIdx(chars[at]);
    var step=stepRange.min + ((runRandom()*(stepRange.max-stepRange.min+1))|0);
    if(runRandom()<0.5) step*=-1;
    var nextIdx=base+step;
    if(nextIdx<0) nextIdx=base+Math.abs(step);
    if(nextIdx>25) nextIdx=base-Math.abs(step);
    nextIdx=clamp(nextIdx,0,25);
    if(nextIdx===base) nextIdx=(base===25)?24:base+1;
    chars[at]=String.fromCharCode(65+nextIdx);
  }
  return chars.join('');
}
function runEnsureLifelineStarter(target, starter, difficulty){
  target=lettersOnlyUpper(target||'');
  if(!target) return '';
  var out=lettersOnlyUpper(starter||'');
  if(out.length!==target.length) out='';
  var yellows=runCountStarterYellows(target, out, difficulty);
  if(yellows>=2) return out;
  return runMakeStarter(target, 2, difficulty);
}
function runAddLink(a,b){
  runCampaign.links.push([a,b]);
}
function runStageY(packStage, isBoss){
  var maxStage=RUN_CLUSTER_DEPTH+1;
  var stage=clamp(safeInt(packStage,1),1,maxStage);
  var top=12, bottom=90;
  var t=(maxStage<=1) ? 0 : ((stage-1)/(maxStage-1));
  var y=bottom - (bottom-top)*t;
  if(!isBoss){ y += (runRandom()*3.6)-1.8; }
  return clamp(y, 8, 94);
}
function runBranchOffsets(total){
  if(total<=1) return [0];
  if(total===2) return [-0.7,0.7];
  if(total===3) return [-1,0,1];
  if(total===4) return [-1.5,-0.5,0.5,1.5];
  var out=[];
  var half=(total-1)/2;
  for(var i=0;i<total;i++){ out.push(i-half); }
  return out;
}
function runPackX(slot, total, parentX, stage){
  total=Math.max(1, safeInt(total,1));
  var anchor=(typeof parentX==='number' && isFinite(parentX)) ? parentX : 50;
  var offsets=runBranchOffsets(total);
  var idx=clamp(safeInt(slot,0), 0, offsets.length-1);
  var spread=clamp(11 + safeInt(stage,1)*0.8, 10, 22);
  var jitter=(runRandom()*5)-2.5;
  return clamp(anchor + offsets[idx]*spread + jitter, 8, 92);
}
function runPickArchetypes(count, opts){
  opts=opts || {};
  count=Math.max(1, safeInt(count,1));
  var cluster=safeInt(opts.cluster, runCampaign ? runCampaign.cluster : 1);
  var isBoss=!!opts.boss;
  var pool=RUN_ARCHETYPES.slice();
  var chosen=[];
  while(pool.length && chosen.length<count){
    var total=0;
    var weights=[];
    for(var i=0;i<pool.length;i++){
      var w=runArchetypeWeight(pool[i], cluster, isBoss);
      if(!isFinite(w) || w<0) w=0;
      weights.push(w);
      total += w;
    }
    var pickIdx=0;
    if(total<=0){
      pickIdx=(runRandom()*pool.length)|0;
    }else{
      var roll=runRandom()*total;
      for(var j=0;j<weights.length;j++){
        roll -= weights[j];
        if(roll<=0){ pickIdx=j; break; }
      }
    }
    chosen.push(pool.splice(pickIdx,1)[0]);
  }
  return chosen;
}

function runPickUpgradeId(exclude){
  var blocked=exclude || {};
  var pool=RUN_UPGRADES.filter(function(up){ return runUpgradeCanRoll(up, blocked); });
  if(!pool.length){
    pool=RUN_UPGRADES.filter(function(up){
      if(blocked[up.id]) return false;
      if(!up.stackable) return false;
      var owned=runUpgradeOwnedCount(up.id);
      if(typeof up.maxStacks==='number' && owned>=up.maxStacks) return false;
      return true;
    });
  }
  if(!pool.length){
    pool=RUN_UPGRADES.filter(function(up){ return !blocked[up.id]; });
  }
  if(!pool.length) pool=RUN_UPGRADES.slice();
  return pool[(runRandom()*pool.length)|0].id;
}
function runCreatePackNode(arch, packStage, slot, isBoss, opts){
  opts=opts || {};
  var elite=!!opts.elite && !isBoss;
  var lenRange=runClusterWordLenRange(runCampaign.cluster);
  var baseLen=clamp(safeInt(arch.lengthBase,5), lenRange.min, lenRange.max);
  var len=clamp(baseLen + (((runRandom()*3)|0)-1), lenRange.min, lenRange.max);
  if(runRandom()<0.25){
    len=lenRange.min + ((runRandom()*(lenRange.max-lenRange.min+1))|0);
  }
  var count=elite ? clamp(6 + ((runRandom()*2)|0), 6, 7) : clamp(5 + ((runRandom()*3)|0), 5, 7);
  var mut=Object.assign({}, arch.mutators || {});
  if(elite){
    mut.noisyArrows=true;
    mut.doubleVision=true;
    mut.copycat=true;
    mut.copycatMin=Math.max(2, safeInt(mut.copycatMin,2));
    mut.minDistance=true;
    mut.minDistanceVal=clampMinDistance((mut.minDistanceVal||10)+1);
    if(runCampaign.cluster>=2) mut.hotPotato=true;
    if(runCampaign.cluster>=3) mut.phantomLetter=true;
    if(mut.countdown){
      mut.countdownSec=Math.max(6, (mut.countdownSec||24)-1);
    }else{
      mut.countdown=true;
      mut.countdownAutoStart=true;
      mut.countdownSec=22;
      mut.countdownKeyCenti=3;
    }
  }
  if(mut.countdown){
    mut.countdownSec=Math.max(6, (mut.countdownSec||24) - (runCampaign.cluster-1)*2 - (packStage-1));
    mut.countdownKeyCenti=Math.min(9, (mut.countdownKeyCenti||3) + Math.max(0,runCampaign.cluster-1));
  }
  if(mut.budget){
    mut.budgetPoints=Math.max(22, (mut.budgetPoints||60) - (runCampaign.cluster-1)*6 - (packStage-1)*3);
  }
  if(isBoss){
    mut.noisyArrows=true;
    mut.doubleVision=true;
    mut.copycat=true;
    mut.copycatMin=Math.max(2, safeInt(mut.copycatMin,2));
    if(runCampaign.cluster>=2) mut.hotPotato=true;
    if(runCampaign.cluster>=3) mut.phantomLetter=true;
  }
  var words=[];
  var baseDiff=isBoss?'hard':(elite?'hard':arch.difficulty);
  var needYellow=mut.lifeline ? 2 : 0;
  for(var i=0;i<count;i++){
    var w=runPickWord(len, {preferSeed:false});
    words.push({
      word:w,
      starter:arch.starter ? runMakeStarter(w, needYellow, baseDiff) : (needYellow>0 ? runMakeStarter(w, needYellow, baseDiff) : '')
    });
  }
  var id=runNextNodeId();
  var mapX=(typeof opts.mapX==='number' && isFinite(opts.mapX)) ? clamp(opts.mapX,8,92) : runPackX(slot, 3, 50, packStage);
  var mapY=(typeof opts.mapY==='number' && isFinite(opts.mapY)) ? clamp(opts.mapY,8,94) : runStageY(packStage, isBoss);
  var title=isBoss
    ? ('Cluster '+runCampaign.cluster+' Boss')
    : (elite ? (arch.title+' Elite') : arch.title);
  var intro=isBoss
    ? 'Boss round. Clear this and the next cluster unlocks. If you lose, the run resets.'
    : (elite
      ? 'Elite node. Extra mutators, bigger payout, and no safety net.'
      : arch.intro);
  var reward=isBoss
    ? (12 + runCampaign.cluster*3 + Math.max(0,safeInt(runCampaign.depth,0)))
    : (elite ? (12 + runCampaign.cluster*2 + packStage) : (6 + runCampaign.cluster + packStage));
  var maxGuesses=(arch.maxGuesses||6);
  if(elite) maxGuesses=Math.max(4, maxGuesses-1);
  if(isBoss) maxGuesses=Math.max(4, maxGuesses-1);
  var node={
    id:id,
    type:isBoss?'boss':(elite?'elite':'pack'),
    cluster:runCampaign.cluster,
    packStage:packStage,
    archetype:arch.id,
    title:title,
    difficulty:baseDiff,
    displayDifficulty:isBoss?'insane':(elite?'elite':(arch.displayDifficulty||arch.difficulty)),
    intro:intro,
    mutators:mut,
    maxGuesses:maxGuesses,
    skipPenalty:0,
    wordLen:len,
    words:words,
    reward:reward,
    map:{x:mapX,y:mapY}
  };
  runCampaign.nodes[id]=node;
  return node;
}
function runCreateUpgradeNode(packStage, mapX, usedUpgrades){
  var upId=runPickUpgradeId(usedUpgrades);
  var up=runGetUpgrade(upId);
  var id=runNextNodeId();
  var x=(typeof mapX==='number' && isFinite(mapX)) ? clamp(mapX,8,92) : 50;
  var y=clamp(runStageY(packStage,false)+6+((runRandom()*3)-1.5),8,94);
  var node={
    id:id,
    type:'upgrade',
    cluster:runCampaign.cluster,
    packStage:packStage,
    title:up ? up.label : 'Upgrade',
    displayDifficulty:'upgrade',
    intro:up ? up.desc : 'Apply a run upgrade.',
    upgradeId:upId,
    reward:0,
    map:{x:x,y:y}
  };
  runCampaign.nodes[id]=node;
  return node;
}
function runCreateRoot(){
  var rootArch={
    id:'root',
    title:'Entry Pack',
    difficulty:'normal',
    displayDifficulty:'normal',
    intro:'Start your run here. Clear packs, pick upgrades, beat the boss, and climb clusters.',
    maxGuesses:7,
    lengthBase:5,
    wordCount:6,
    starter:true,
    mutators:{lifeline:true,lifelineCount:1}
  };
  var node=runCreatePackNode(rootArch, 1, 0, false, {mapX:50, mapY:runStageY(1,false)});
  node.title='Entry Pack';
  node.intro='Root node. Clear this to branch into new packs.';
  runCampaign.frontier=[node.id];
}
function runStageHasUpgrade(stage){
  return RUN_UPGRADE_STAGES.indexOf(stage)!==-1;
}
function runStageBranchCount(stage){
  if(runStageHasUpgrade(stage)) return 2;
  return 3 + ((runRandom()*2)|0);
}
function runEliteSlotForStage(stage, branchCount){
  if(runStageHasUpgrade(stage)) return -1;
  if(stage>=RUN_CLUSTER_DEPTH) return -1;
  if(stage===4 || stage===7){
    return (runRandom()*branchCount)|0;
  }
  if(stage>4 && runRandom()<0.35){
    return (runRandom()*branchCount)|0;
  }
  return -1;
}
function runGenerateChoices(fromNodeId){
  var stage=runCampaign.depth+1;
  var fromNode=runCampaign.nodes[fromNodeId] || null;
  var parentX=(fromNode && fromNode.map && typeof fromNode.map.x==='number') ? fromNode.map.x : 50;
  var hasUpgrade=runStageHasUpgrade(stage);
  var branchCount=runStageBranchCount(stage);
  var arches=runPickArchetypes(Math.max(2,branchCount), {cluster:runCampaign.cluster, boss:false});
  while(arches.length<branchCount){
    var extra=runPickArchetypes(1, {cluster:runCampaign.cluster, boss:false});
    arches.push(extra.length ? extra[0] : RUN_ARCHETYPES[(runRandom()*RUN_ARCHETYPES.length)|0]);
  }
  var usedUpgrades={};
  var frontier=[];
  var eliteSlot=runEliteSlotForStage(stage, branchCount);

  for(var i=0;i<branchCount;i++){
    var mapX=runPackX(i, branchCount, parentX, stage);
    var node=runCreatePackNode(arches[i], stage, i, false, {
      mapX:mapX,
      elite:(i===eliteSlot)
    });
    runAddLink(fromNodeId, node.id);
    frontier.push(node.id);
  }

  if(hasUpgrade){
    var upLeft=runCreateUpgradeNode(stage, clamp(parentX-9+((runRandom()*5)-2.5),8,92), usedUpgrades);
    usedUpgrades[upLeft.upgradeId]=true;
    var upRight=runCreateUpgradeNode(stage, clamp(parentX+9+((runRandom()*5)-2.5),8,92), usedUpgrades);
    usedUpgrades[upRight.upgradeId]=true;
    runAddLink(fromNodeId,upLeft.id);
    runAddLink(fromNodeId,upRight.id);
    frontier.push(upLeft.id, upRight.id);
  }
  runCampaign.frontier=frontier;
}
function runGenerateBoss(fromNodeId){
  var bossPick=runPickArchetypes(1, {cluster:runCampaign.cluster, boss:true});
  var bossArch=bossPick.length ? bossPick[0] : RUN_ARCHETYPES[(runRandom()*RUN_ARCHETYPES.length)|0];
  var fromNode=runCampaign.nodes[fromNodeId] || null;
  var parentX=(fromNode && fromNode.map && typeof fromNode.map.x==='number') ? fromNode.map.x : 50;
  var boss=runCreatePackNode(bossArch, RUN_CLUSTER_DEPTH+1, 0, true, {
    mapX:clamp(parentX + ((runRandom()*7)-3.5), 18, 82),
    mapY:runStageY(RUN_CLUSTER_DEPTH+1, true)
  });
  runAddLink(fromNodeId,boss.id);
  runCampaign.frontier=[boss.id];
}
function runClearNodeSessions(nodesObj){
  Object.keys(nodesObj||{}).forEach(function(id){
    removeKey(campaignKey(RUN_SET_PREFIX+id));
  });
}
function runRestartCampaign(){
  if(runCampaign && runCampaign.nodes){ runClearNodeSessions(runCampaign.nodes); }
  runCampaign=runCreateState();
  RUN_RUNTIME_SETS={};
  runCreateRoot();
  runSave();
}
function runAdvanceCluster(openShop){
  if(runCampaign && runCampaign.nodes){ runClearNodeSessions(runCampaign.nodes); }
  var nextCluster=safeInt(runCampaign.cluster,1)+1;
  var keepUpgrades=(runCampaign.upgrades||[]).slice();
  var keepPerm=Object.assign(runDefaultPermBuffs(), runCampaign.permanentBuffs || {});
  var keepTraits=(runCampaign.clusterTraits||[]).slice();
  runCampaign=runCreateState(runCampaign.seed);
  runCampaign.cluster=nextCluster;
  runCampaign.upgrades=keepUpgrades;
  runCampaign.permanentBuffs=keepPerm;
  runCampaign.clusterTraits=keepTraits;
  RUN_RUNTIME_SETS={};
  runCreateRoot();
  if(openShop){
    runPrepareClusterShop();
  }
  runSave();
}
function ensureRunCampaign(){
  if(!runCampaign || runCampaign.version!==5){
    runRestartCampaign();
    return runCampaign;
  }
  if(!runCampaign.permanentBuffs){ runCampaign.permanentBuffs=runDefaultPermBuffs(); }
  if(!runCampaign.tempBuffs){ runCampaign.tempBuffs=runDefaultTempBuffs(); }
  if(!Array.isArray(runCampaign.clusterTraits)){ runCampaign.clusterTraits=[]; }
  if(typeof runCampaign.pendingShop==='undefined'){ runCampaign.pendingShop=null; }
  if(!runCampaign.nodes || !Object.keys(runCampaign.nodes).length){
    runCampaign.nodes={}; runCampaign.links=[]; runCampaign.frontier=[];
    runCreateRoot();
    runSave();
  }
  return runCampaign;
}
function runRefreshFrontierWordsFromRemote(){
  if(!runCampaign || !runCampaign.nodes) return 0;
  if(!remoteDictLen || !remoteDictLen.size) return 0;
  var changed=0;
  var frontier=(runCampaign.frontier||[]).slice();
  frontier.forEach(function(id){
    var node=runCampaign.nodes[id];
    if(!node || !runIsPackNodeType(node.type)) return;
    if(runCampaign.completed[id]) return;
    if(id===runCampaign.activeNodeId) return;
    var setId=RUN_SET_PREFIX+id;
    if(load(campaignKey(setId), null)) return;
    if(!Array.isArray(node.words) || !node.words.length) return;

    var needYellow=(node.mutators && node.mutators.lifeline) ? 2 : 0;
    var diff=(node.type==='boss') ? 'hard' : (node.difficulty || 'normal');
    var nextWords=[];
    for(var i=0;i<node.words.length;i++){
      var entry=node.words[i];
      var oldWord=(typeof entry==='string') ? entry : lettersOnlyUpper((entry && entry.word) || '');
      var range=runClusterWordLenRange(node.cluster || runCampaign.cluster);
      var len=oldWord.length || clamp(safeInt(node.wordLen,5), range.min, range.max);
      len=clamp(len, range.min, range.max);
      var picked=runPickWord(len, {preferSeed:false});
      var hadStarter=!!(entry && typeof entry==='object' && entry.starter);
      var starter=(hadStarter || needYellow>0) ? runMakeStarter(picked, needYellow, diff) : '';
      nextWords.push({word:picked, starter:starter});
    }
    node.words=nextWords;
    delete RUN_RUNTIME_SETS[setId];
    changed++;
  });
  if(changed>0){
    runCampaign.wordSource='remote';
    runSave();
  }
  return changed;
}
function runRefreshFrontierWordsForReview(){
  if(!runCampaign || !runCampaign.nodes) return 0;
  var changed=0;
  var frontier=(runCampaign.frontier||[]).slice();
  frontier.forEach(function(id){
    var node=runCampaign.nodes[id];
    if(!node || !runIsPackNodeType(node.type)) return;
    if(runCampaign.completed[id]) return;
    if(id===runCampaign.activeNodeId) return;
    var setId=RUN_SET_PREFIX+id;
    if(load(campaignKey(setId), null)) return;
    if(!Array.isArray(node.words) || !node.words.length) return;

    var touched=false;
    var needYellow=(node.mutators && node.mutators.lifeline) ? 2 : 0;
    var diff=(node.type==='boss') ? 'hard' : (node.difficulty || 'normal');
    for(var i=0;i<node.words.length;i++){
      var entry=node.words[i];
      var oldWord=(typeof entry==='string') ? entry : lettersOnlyUpper((entry && entry.word) || '');
      if(!oldWord || !runWordReview.rejected[oldWord]) continue;
      var range=runClusterWordLenRange(node.cluster || runCampaign.cluster);
      var len=oldWord.length || clamp(safeInt(node.wordLen,5), range.min, range.max);
      len=clamp(len, range.min, range.max);
      var picked=runPickWord(len, {preferSeed:false});
      var hadStarter=!!(entry && typeof entry==='object' && entry.starter);
      var starter=(hadStarter || needYellow>0) ? runMakeStarter(picked, needYellow, diff) : '';
      node.words[i]={word:picked, starter:starter};
      touched=true;
    }
    if(touched){
      delete RUN_RUNTIME_SETS[setId];
      changed++;
    }
  });
  if(changed>0){
    runSave();
  }
  return changed;
}
function runApplyUpgradeToSet(set, upId){
  if(!set || !set.mutators) return;
  var mut=set.mutators;
  if(upId==='uplife'){
    mut.lifeline=true;
    mut.lifelineCount=clampLifeCount((mut.lifelineCount||0)+1);
  }else if(upId==='uptime'){
    if(mut.countdown){
      mut.countdownSec=(mut.countdownSec||22)+5;
      mut.countdownKeyCenti=Math.max(0,(mut.countdownKeyCenti||0)-1);
    }else{
      mut.countdown=true;
      mut.countdownAutoStart=true;
      mut.countdownSec=22;
      mut.countdownKeyCenti=3;
    }
  }else if(upId==='upguess'){
    set.maxGuesses=clamp((set.maxGuesses||6)+1,3,20);
  }else if(upId==='upsignal'){
    delete mut.noisyArrows;
    delete mut.phantomLetter;
  }else if(upId==='upwild'){
    mut.wildcard=true;
  }else if(upId==='upbudget'){
    if(mut.budget){
      mut.budgetPoints=clampBudget((mut.budgetPoints||45)+12);
    }
  }else if(upId==='upclarity'){
    delete mut.doubleVision;
    delete mut.bloodMirage;
  }else if(upId==='upstability'){
    delete mut.drift;
    delete mut.randomKeyboard;
  }else if(upId==='upreward'){
    set.reward=Math.max(0, safeInt(set.reward,0)+2);
  }else if(upId==='upstarter'){
    if(Array.isArray(set.words)){
      for(var i=0;i<set.words.length;i++){
        var entry=set.words[i];
        if(typeof entry==='string'){
          set.words[i]={word:entry, starter:runMakeStarter(entry, 1, set.difficulty)};
          continue;
        }
        if(!entry) continue;
        var w=lettersOnlyUpper(entry.word||'');
        if(!w) continue;
        entry.starter=runMakeStarter(w, 1, set.difficulty);
      }
    }
  }
}
function runGetShopConsumable(id){
  for(var i=0;i<RUN_SHOP_CONSUMABLES.length;i++){
    if(RUN_SHOP_CONSUMABLES[i].id===id) return RUN_SHOP_CONSUMABLES[i];
  }
  return null;
}
function runGetShopPermanent(id){
  for(var i=0;i<RUN_SHOP_PERMANENTS.length;i++){
    if(RUN_SHOP_PERMANENTS[i].id===id) return RUN_SHOP_PERMANENTS[i];
  }
  return null;
}
function runGetClusterTrait(id){
  for(var i=0;i<RUN_CLUSTER_TRAITS.length;i++){
    if(RUN_CLUSTER_TRAITS[i].id===id) return RUN_CLUSTER_TRAITS[i];
  }
  return null;
}
function runRollShopPrice(min, max, isPermanent){
  var lo=safeInt(min, 1);
  var hi=Math.max(lo, safeInt(max, lo));
  var base=lo + ((runRandom()*(hi-lo+1))|0);
  var clusterScale=Math.max(0, safeInt(runCampaign.cluster,1)-1);
  var extra=clusterScale * (isPermanent ? 7 : 3);
  return clamp(base+extra, 1, 999);
}
function runPickDistinctFromList(pool, count){
  var src=(pool||[]).slice();
  var out=[];
  while(src.length && out.length<count){
    var idx=(runRandom()*src.length)|0;
    out.push(src.splice(idx,1)[0]);
  }
  return out;
}
function runPrepareClusterShop(){
  ensureRunCampaign();
  if(runCampaign.pendingShop && runCampaign.pendingShop.cluster===runCampaign.cluster){
    return runCampaign.pendingShop;
  }
  var consumables=runPickDistinctFromList(RUN_SHOP_CONSUMABLES, Math.min(6, RUN_SHOP_CONSUMABLES.length)).map(function(item){
    return {id:item.id, price:runRollShopPrice(item.min, item.max, false)};
  });
  var permanents=runPickDistinctFromList(RUN_SHOP_PERMANENTS, Math.min(3, RUN_SHOP_PERMANENTS.length)).map(function(item){
    return {id:item.id, price:runRollShopPrice(item.min, item.max, true)};
  });
  var availableTraits=RUN_CLUSTER_TRAITS.filter(function(tr){
    return (runCampaign.clusterTraits||[]).indexOf(tr.id)===-1;
  });
  if(availableTraits.length<2){ availableTraits=RUN_CLUSTER_TRAITS.slice(); }
  var freeTraits=runPickDistinctFromList(availableTraits, 2).map(function(tr){ return tr.id; });
  while(freeTraits.length<2){
    var fallback=RUN_CLUSTER_TRAITS[(runRandom()*RUN_CLUSTER_TRAITS.length)|0];
    if(freeTraits.indexOf(fallback.id)===-1){ freeTraits.push(fallback.id); }
  }
  runCampaign.pendingShop={
    cluster:runCampaign.cluster,
    consumables:consumables,
    permanents:permanents,
    freeTraits:freeTraits,
    bought:{},
    chosenTrait:null
  };
  runSave();
  return runCampaign.pendingShop;
}
function runApplyConsumablePurchase(id){
  var tmp=Object.assign(runDefaultTempBuffs(), runCampaign.tempBuffs || {});
  if(id==='c_guess') tmp.guess += 1;
  else if(id==='c_life') tmp.lifeline += 1;
  else if(id==='c_time') tmp.countdown += 6;
  else if(id==='c_budget') tmp.budget += 14;
  else if(id==='c_reward') tmp.reward += 2;
  else if(id==='c_clean') tmp.signalClean = true;
  else if(id==='c_relief') tmp.minDistanceRelief += 2;
  else if(id==='c_wild') tmp.wildcard = true;
  runCampaign.tempBuffs=tmp;
}
function runApplyPermanentPurchase(id){
  var perm=Object.assign(runDefaultPermBuffs(), runCampaign.permanentBuffs || {});
  if(id==='p_guess') perm.guess += 1;
  else if(id==='p_life') perm.lifeline += 1;
  else if(id==='p_time') perm.countdown += 4;
  else if(id==='p_budget') perm.budget += 10;
  else if(id==='p_reward') perm.reward += 2;
  else if(id==='p_clean') perm.signalClean = true;
  runCampaign.permanentBuffs=perm;
}
function runApplyClusterTraitToSet(set, traitId){
  if(!set || !set.mutators) return;
  var mut=set.mutators;
  if(traitId==='t_glass'){
    set.reward += 4;
    set.maxGuesses=clamp(set.maxGuesses-1,2,20);
  }else if(traitId==='t_guard'){
    set.maxGuesses=clamp(set.maxGuesses+1,2,20);
    mut.lifeline=true;
    mut.lifelineCount=clampLifeCount((mut.lifelineCount||0)+1);
    if(mut.countdown){ mut.countdownSec=Math.max(5,(mut.countdownSec||20)-4); }
    if(mut.budget){ mut.budgetPoints=clampBudget((mut.budgetPoints||45)-8); }
  }else if(traitId==='t_surge'){
    if(mut.countdown){ mut.countdownSec=Math.max(5,(mut.countdownSec||20)+8); }
    else{
      mut.countdown=true;
      mut.countdownAutoStart=true;
      mut.countdownSec=28;
      mut.countdownKeyCenti=3;
    }
    delete mut.noisyArrows;
    delete mut.phantomLetter;
    mut.minDistance=true;
    mut.minDistanceVal=clampMinDistance((mut.minDistanceVal||10)+2);
  }else if(traitId==='t_hoard'){
    if(mut.budget){ mut.budgetPoints=clampBudget((mut.budgetPoints||45)+22); }
    else{
      mut.budget=true;
      mut.budgetPoints=clampBudget(66);
    }
    mut.wildcard=true;
    set.reward=Math.max(0, safeInt(set.reward,0)-2);
    if(Array.isArray(set.words)){
      for(var i=0;i<set.words.length;i++){
        if(typeof set.words[i]==='string') set.words[i]={word:set.words[i],starter:''};
        else if(set.words[i]) set.words[i].starter='';
      }
    }
  }else if(traitId==='t_precision'){
    set.reward += 1;
    set.maxGuesses=clamp(set.maxGuesses+1,2,20);
    mut.hotPotato=true;
    mut.minDistance=true;
    mut.minDistanceVal=clampMinDistance((mut.minDistanceVal||9)+1);
  }
}
function runApplyStoreBuffsToSet(set, node){
  if(!set || !set.mutators) return;
  var mut=set.mutators;
  var tmp=Object.assign(runDefaultTempBuffs(), runCampaign.tempBuffs || {});
  var perm=Object.assign(runDefaultPermBuffs(), runCampaign.permanentBuffs || {});

  var guessDelta=safeInt(tmp.guess,0)+safeInt(perm.guess,0);
  if(guessDelta){ set.maxGuesses=clamp(set.maxGuesses+guessDelta,2,20); }

  var lifeDelta=safeInt(tmp.lifeline,0)+safeInt(perm.lifeline,0);
  if(lifeDelta){
    mut.lifeline=true;
    mut.lifelineCount=clampLifeCount((mut.lifelineCount||0)+lifeDelta);
  }

  var timeDelta=safeInt(tmp.countdown,0)+safeInt(perm.countdown,0);
  if(timeDelta){
    if(mut.countdown){ mut.countdownSec=Math.max(5,(mut.countdownSec||20)+timeDelta); }
    else if(timeDelta>0){
      mut.countdown=true;
      mut.countdownAutoStart=true;
      mut.countdownSec=22+timeDelta;
      mut.countdownKeyCenti=3;
    }
  }

  var budgetDelta=safeInt(tmp.budget,0)+safeInt(perm.budget,0);
  if(budgetDelta){
    if(mut.budget){ mut.budgetPoints=clampBudget((mut.budgetPoints||45)+budgetDelta); }
    else if(budgetDelta>0){
      mut.budget=true;
      mut.budgetPoints=clampBudget(44+budgetDelta);
    }
  }

  if(tmp.wildcard){ mut.wildcard=true; }
  var rewardDelta=safeInt(tmp.reward,0)+safeInt(perm.reward,0);
  if(rewardDelta){ set.reward=Math.max(0,safeInt(set.reward,0)+rewardDelta); }

  if(tmp.signalClean || perm.signalClean){
    delete mut.noisyArrows;
    delete mut.phantomLetter;
  }
  if(tmp.minDistanceRelief>0 && mut.minDistance){
    mut.minDistanceVal=clampMinDistance((mut.minDistanceVal||10)-safeInt(tmp.minDistanceRelief,0));
  }

  (runCampaign.clusterTraits||[]).forEach(function(traitId){
    runApplyClusterTraitToSet(set, traitId, node);
  });
}
function runBuildSetFromNode(node){
  if(!node) return null;
  var setId=RUN_SET_PREFIX+node.id;
  if(RUN_RUNTIME_SETS[setId]) return RUN_RUNTIME_SETS[setId];
  var set={
    id:setId,
    nodeId:node.id,
    title:node.title,
    intro:node.intro,
    difficulty:node.difficulty || 'normal',
    displayDifficulty:node.displayDifficulty || node.difficulty || 'normal',
    mutators:normalizeMutators(Object.assign({}, node.mutators || {})),
    maxGuesses:clamp(safeInt(node.maxGuesses,6),3,20),
    words:runClone(node.words || []),
    reward:safeInt(node.reward,0),
    nodeType:node.type
  };
  var penalty=safeInt(node.skipPenalty,0);
  if(penalty>0){
    set.maxGuesses=clamp(set.maxGuesses-penalty,2,20);
  }
  (runCampaign.upgrades||[]).forEach(function(upId){
    runApplyUpgradeToSet(set, upId);
  });
  runApplyStoreBuffsToSet(set, node);
  runApplyCountdownVariance(set.mutators, node.cluster || runCampaign.cluster, node.type);
  set.mutators=normalizeMutators(set.mutators);
  set.mutators.lifelineCount=clampLifeCount(set.mutators.lifelineCount);
  set.mutators.budgetPoints=clampBudget(set.mutators.budgetPoints);
  set.reward=Math.max(0, safeInt(set.reward,0));
  if(set.mutators.lifeline && Array.isArray(set.words)){
    for(var i=0;i<set.words.length;i++){
      var entry=set.words[i];
      if(!entry) continue;
      if(typeof entry==='string'){
        set.words[i]={word:entry, starter:runMakeStarter(entry,2,set.difficulty)};
        continue;
      }
      var word=lettersOnlyUpper(entry.word||'');
      if(!word) continue;
      entry.starter=runEnsureLifelineStarter(word, entry.starter || '', set.difficulty);
    }
  }
  if((runCampaign.clusterTraits||[]).indexOf('t_hoard')!==-1 && Array.isArray(set.words)){
    for(var hs=0; hs<set.words.length; hs++){
      var hsEntry=set.words[hs];
      if(typeof hsEntry==='string') set.words[hs]={word:hsEntry, starter:''};
      else if(hsEntry) hsEntry.starter='';
    }
  }
  RUN_RUNTIME_SETS[setId]=set;
  return set;
}
function runLockVisibleUpgrades(chosenNodeId, applyPenalty){
  var frontier=(runCampaign.frontier||[]).slice();
  if(!frontier.length) return 0;
  var keep=[];
  var skipped=0;
  for(var i=0;i<frontier.length;i++){
    var id=frontier[i];
    var node=runCampaign.nodes[id];
    if(!node){ continue; }
    if(id===chosenNodeId){ keep.push(id); continue; }
    if(node.type==='upgrade'){
      runCampaign.skipped[id]=true;
      skipped++;
      continue;
    }
    keep.push(id);
  }
  runCampaign.frontier=keep;
  if(applyPenalty && skipped>0 && chosenNodeId && runCampaign.nodes[chosenNodeId]){
    var chosen=runCampaign.nodes[chosenNodeId];
    if(chosen.type==='pack' || chosen.type==='boss' || chosen.type==='elite'){
      chosen.skipPenalty=clamp(safeInt(chosen.skipPenalty,0)+skipped,0,4);
      delete RUN_RUNTIME_SETS[RUN_SET_PREFIX+chosen.id];
    }
  }
  return skipped;
}
function runApplyUpgradeNode(node){
  if(!node || node.type!=='upgrade') return;
  var upId=node.upgradeId;
  if(upId){
    var up=runGetUpgrade(upId);
    if(up && up.stackable){
      var count=runUpgradeOwnedCount(upId);
      if(typeof up.maxStacks!=='number' || count<up.maxStacks){
        runCampaign.upgrades.push(upId);
      }
    }else if((runCampaign.upgrades||[]).indexOf(upId)===-1){
      runCampaign.upgrades.push(upId);
    }
  }
  runLockVisibleUpgrades(node.id, false);
  runCampaign.completed[node.id]=true;
  runCampaign.frontier=(runCampaign.frontier||[]).filter(function(id){ return id!==node.id; });
  Object.keys(RUN_RUNTIME_SETS).forEach(function(setId){
    var nId=runNodeFromSetId(setId);
    if(nId && runCampaign.frontier.indexOf(nId)!==-1){ delete RUN_RUNTIME_SETS[setId]; }
  });
  runSave();
}
function runResolveNodeForSet(set){
  if(!set) return null;
  var run=ensureRunCampaign();
  if(set.nodeId && run.nodes[set.nodeId]) return run.nodes[set.nodeId];
  var nodeId=runNodeFromSetId(set.id||'');
  if(nodeId && run.nodes[nodeId]) return run.nodes[nodeId];
  return null;
}
function runShopEsc(v){
  return (v==null?'':String(v)).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function runRenderShop(){
  if(!campaignShopEl || !shopConsumablesEl || !shopPermanentsEl || !shopFreeChoiceEl) return;
  ensureRunCampaign();
  var shop=runCampaign.pendingShop;
  if(!shop || shop.cluster!==runCampaign.cluster){
    campaignShopEl.classList.remove('open');
    return;
  }
  if(shopSubtitleEl){
    shopSubtitleEl.textContent='Cluster '+runCampaign.cluster+' shop - Coins: '+currency;
  }
  var bought=shop.bought || {};

  var consHtml=(shop.consumables||[]).map(function(entry){
    var item=runGetShopConsumable(entry.id);
    if(!item) return '';
    var key='consumable:'+entry.id;
    var sold=!!bought[key];
    var canBuy=!sold && currency>=entry.price;
    var btnTxt=sold?'Sold':(canBuy?'Buy':'Need '+entry.price);
    return '<article class="shop-item'+(sold?' sold':'')+'">'+
      '<div class="shop-item-head"><h4>'+runShopEsc(item.label)+'</h4><span class="shop-price">'+entry.price+' coins</span></div>'+
      '<p>'+runShopEsc(item.desc)+'</p>'+
      '<div class="shop-actions"><button class="'+(canBuy?'primary':'secondary')+'" data-shop-kind="consumable" data-shop-id="'+runShopEsc(entry.id)+'"'+(sold?' disabled':'')+'>'+btnTxt+'</button></div>'+
    '</article>';
  }).join('');
  shopConsumablesEl.innerHTML=consHtml || '<div class="shop-note">No consumables rolled this time.</div>';

  var permHtml=(shop.permanents||[]).map(function(entry){
    var item=runGetShopPermanent(entry.id);
    if(!item) return '';
    var key='permanent:'+entry.id;
    var sold=!!bought[key];
    var canBuy=!sold && currency>=entry.price;
    var btnTxt=sold?'Sold':(canBuy?'Buy':'Need '+entry.price);
    return '<article class="shop-item'+(sold?' sold':'')+'">'+
      '<div class="shop-item-head"><h4>'+runShopEsc(item.label)+'</h4><span class="shop-price expensive">'+entry.price+' coins</span></div>'+
      '<p>'+runShopEsc(item.desc)+'</p>'+
      '<div class="shop-actions"><button class="'+(canBuy?'primary':'secondary')+'" data-shop-kind="permanent" data-shop-id="'+runShopEsc(entry.id)+'"'+(sold?' disabled':'')+'>'+btnTxt+'</button></div>'+
    '</article>';
  }).join('');
  shopPermanentsEl.innerHTML=permHtml || '<div class="shop-note">No permanent upgrades rolled this time.</div>';

  var chosen=shop.chosenTrait || '';
  var traitHtml=(shop.freeTraits||[]).map(function(id){
    var trait=runGetClusterTrait(id);
    if(!trait) return '';
    var picked=(chosen===id);
    var locked=!!chosen && !picked;
    var btnTxt=picked?'Chosen':(locked?'Locked':'Choose');
    return '<article class="shop-item'+(picked?' free-picked':'')+'">'+
      '<div class="shop-item-head"><h4>'+runShopEsc(trait.label)+'</h4><span class="shop-price">Free</span></div>'+
      '<div class="shop-updown"><div class="shop-up">UP: '+runShopEsc(trait.up)+'</div><div class="shop-down">DOWN: '+runShopEsc(trait.down)+'</div></div>'+
      '<div class="shop-actions"><button class="'+(picked?'secondary':'primary')+'" data-shop-kind="trait" data-shop-id="'+runShopEsc(id)+'"'+(locked||picked?' disabled':'')+'>'+btnTxt+'</button></div>'+
    '</article>';
  }).join('');
  shopFreeChoiceEl.innerHTML=traitHtml;

  if(shopContinueBtn){
    var ready=!!shop.chosenTrait;
    shopContinueBtn.classList.toggle('disabled', !ready);
    shopContinueBtn.textContent=ready ? 'Continue' : 'Choose free upgrade';
  }
}
function runChooseShopTrait(id){
  ensureRunCampaign();
  var shop=runCampaign.pendingShop;
  if(!shop) return;
  if(shop.chosenTrait){ return; }
  if((shop.freeTraits||[]).indexOf(id)===-1) return;
  shop.chosenTrait=id;
  if((runCampaign.clusterTraits||[]).indexOf(id)===-1){ runCampaign.clusterTraits.push(id); }
  runSave();
  runRenderShop();
  var trait=runGetClusterTrait(id);
  toast((trait?trait.label:'Trait')+' selected.');
}
function runBuyShopEntry(kind, id){
  ensureRunCampaign();
  var shop=runCampaign.pendingShop;
  if(!shop) return;
  var key=kind+':'+id;
  if(shop.bought && shop.bought[key]) return;
  var list=(kind==='consumable') ? (shop.consumables||[]) : (shop.permanents||[]);
  var entry=null;
  for(var i=0;i<list.length;i++){
    if(list[i].id===id){ entry=list[i]; break; }
  }
  if(!entry) return;
  if(currency<entry.price){ toast('Not enough coins.'); return; }
  currency-=entry.price;
  saveCurrency();
  if(!shop.bought) shop.bought={};
  shop.bought[key]=true;
  if(kind==='consumable') runApplyConsumablePurchase(id);
  else runApplyPermanentPurchase(id);
  runSave();
  runRenderShop();
  var item=(kind==='consumable')?runGetShopConsumable(id):runGetShopPermanent(id);
  toast('Bought '+(item?item.label:'upgrade')+'.');
}
function closeCampaignShop(){
  if(campaignShopEl) campaignShopEl.classList.remove('open');
}
function finishCampaignShop(){
  ensureRunCampaign();
  var shop=runCampaign.pendingShop;
  if(!shop){ closeCampaignShop(); return true; }
  if(!shop.chosenTrait){
    toast('Pick one free cluster upgrade first.');
    return false;
  }
  runCampaign.pendingShop=null;
  runSave();
  closeCampaignShop();
  buildCampaignMenu();
  requestAnimationFrame(focusCampaignMap);
  return true;
}
function maybeOpenCampaignShop(){
  ensureRunCampaign();
  if(!campaignShopEl) return;
  var shop=runCampaign.pendingShop;
  if(!shop || shop.cluster!==runCampaign.cluster) return;
  runRenderShop();
  campaignShopEl.classList.add('open');
}

function packFee(set){ return 0; }
function packReward(set){
  if(set && typeof set.reward==='number') return set.reward;
  return 8 + Math.max(0, safeInt(runCampaign && runCampaign.cluster,1)-1);
}
function displayDifficulty(set){
  return (set && set.displayDifficulty) ? set.displayDifficulty : (set ? set.difficulty : '');
}
function getCampaignSet(id){
  var setId=id;
  if(!setId) return null;
  if(RUN_RUNTIME_SETS[setId]) return RUN_RUNTIME_SETS[setId];
  var run=ensureRunCampaign();
  var nodeId=runNodeFromSetId(setId);
  if(nodeId && run.nodes[nodeId]){
    return runBuildSetFromNode(run.nodes[nodeId]);
  }
  if(run.nodes[setId]){
    return runBuildSetFromNode(run.nodes[setId]);
  }
  return null;
}
function runCompleteNodeAndAdvance(node, set, opts){
  opts=opts || {};
  if(!node || !set) return '';
  removeKey(campaignKey(set.id));
  if(node.type==='upgrade'){
    runApplyUpgradeNode(node);
    return 'upgrade';
  }
  runCampaign.completed[node.id]=true;
  runCampaign.activeNodeId=null;
  currency += packReward(set);
  saveCurrency();
  if(node.type==='boss'){
    setCampaignBossMode(false);
    runAdvanceCluster(true);
    return 'boss';
  }
  var prevFrontier=(runCampaign.frontier||[]).slice();
  prevFrontier.forEach(function(id){
    if(id!==node.id){ runCampaign.skipped[id]=true; }
  });
  runCampaign.frontier=[];
  runCampaign.depth = safeInt(runCampaign.depth,0) + 1;
  if(runCampaign.depth>=RUN_CLUSTER_DEPTH){
    runGenerateBoss(node.id);
    runSave();
    return 'boss_unlocked';
  }
  runGenerateChoices(node.id);
  runSave();
  return 'pack_unlocked';
}

function showCampaignIntro(set, onStart){
  var modal=$('#campaignIntro'); if(!modal) return onStart();
  $('#introTitle').textContent = (set.title || 'Run Node');
  $('#introDesc').textContent = set.intro || 'Begin this node.';
  var meta=$('#introMeta');
  if(meta){
    meta.innerHTML='';
    updateCampaignIntroMeta(set, meta);
  }
  modal.classList.add('open');
  var btn=$('#introStart');
  var back=$('#introBack');
  var clear=$('#introClear');
  var autoBtn=$('#introAutoComplete');
  var isUpgrade=(set.nodeType==='upgrade');
  var saved=!isUpgrade ? load(campaignKey(set.id), null) : null;
  if(btn){ btn.textContent = isUpgrade ? 'Claim upgrade' : (saved ? 'Resume node' : 'Start node'); }
  if(clear){
    clear.style.display = saved ? 'inline-flex' : 'none';
    clear.textContent='Clear save';
  }
  if(btn){
    btn.disabled=false;
    btn.classList.remove('disabled');
  }
  var handler=function(){
    var proceed = true;
    if(onStart){ proceed = (onStart() !== false); }
    if(!proceed) return;
    modal.classList.remove('open');
    btn.removeEventListener('click', handler);
    back.removeEventListener('click', onBack);
    if(clear) clear.removeEventListener('click', onClear);
    if(autoBtn) autoBtn.removeEventListener('click', onAuto);
  };
  var onBack=function(){
    modal.classList.remove('open');
    btn.removeEventListener('click', handler);
    back.removeEventListener('click', onBack);
    if(clear) clear.removeEventListener('click', onClear);
    if(autoBtn) autoBtn.removeEventListener('click', onAuto);
  };
  var onClear=function(){
    removeKey(campaignKey(set.id));
    if(clear) clear.style.display='none';
    if(meta) updateCampaignIntroMeta(set, meta);
  };
  var onAuto=function(){
    if(set.nodeId){
      var run=ensureRunCampaign();
      var node=run.nodes[set.nodeId];
      var autoResult='';
      if(node && node.type==='upgrade'){
        runApplyUpgradeNode(node);
        autoResult='upgrade';
        toast('Upgrade claimed (auto).');
      }else if(node){
        autoResult=runCompleteNodeAndAdvance(node, set, {auto:true});
        if(autoResult==='boss'){
          toast('Boss auto-completed. Next cluster unlocked.');
        }else if(autoResult==='boss_unlocked'){
          toast('Node auto-completed. Boss node unlocked.');
        }else if(autoResult==='pack_unlocked'){
          toast('Node auto-completed. New paths generated.');
        }else{
          toast('Node marked complete.');
        }
      }
      buildCampaignMenu();
      updateCampaignProgress();
      if(autoResult==='boss'){ setTimeout(maybeOpenCampaignShop, 90); }
    }
    modal.classList.remove('open');
    btn.removeEventListener('click', handler);
    back.removeEventListener('click', onBack);
    if(clear) clear.removeEventListener('click', onClear);
    if(autoBtn) autoBtn.removeEventListener('click', onAuto);
  };
  btn.addEventListener('click', handler);
  back.addEventListener('click', onBack);
  if(clear && saved){ clear.addEventListener('click', onClear); }
  if(autoBtn){ autoBtn.addEventListener('click', onAuto); }
}
function updateCampaignIntroMeta(set, meta){
  meta.innerHTML='';
  var run=ensureRunCampaign();
  var node=runResolveNodeForSet(set) || run.nodes[set.nodeId] || null;
  var mutList = describeMutators((set && set.mutators) ? set.mutators : null);
  if(node && node.type==='upgrade'){
    var up=runGetUpgrade(node.upgradeId);
    addIntroItem(meta,'Type','UPGRADE');
    addIntroItem(meta,'Cluster',''+run.cluster);
    addIntroItem(meta,'Effect',(up && up.desc) ? up.desc : 'Run modifier');
    addIntroItem(meta,'Owned Upgrades',''+(run.upgrades||[]).length);
    return;
  }
  var stats=packWordStats(set);
  var range=packGuessRange(set, stats);
  var lens=stats.min ? (stats.min===stats.max ? ''+stats.min : (stats.min+'-'+stats.max)) : '?';
  var guesses=range.min ? (range.min===range.max ? ''+range.min : (range.min+'-'+range.max)) : '?';
  addIntroItem(meta,'Type', (node && node.type==='boss') ? 'BOSS' : ((node && node.type==='elite') ? 'ELITE PACK' : 'PACK'));
  addIntroItem(meta,'Cluster',''+run.cluster);
  var depthLabel=(node && node.type==='boss')
    ? 'Boss'
    : (((node && node.packStage) ? node.packStage : (run.depth+1)) + '/'+RUN_CLUSTER_DEPTH);
  addIntroItem(meta,'Depth', depthLabel);
  addIntroItem(meta,'Difficulty', (displayDifficulty(set)||'').toUpperCase());
  addIntroItem(meta,'Levels', ''+stats.total);
  addIntroItem(meta,'Word length', lens);
  addIntroItem(meta,'Guess cap', guesses+(range.fixed?'':' (by length)'));
  addIntroItem(meta,'Mutators', mutList);
  addIntroItem(meta,'Reward', packReward(set)+' coins');
  if(node && safeInt(node.skipPenalty,0)>0){
    addIntroItem(meta,'Penalty','-'+safeInt(node.skipPenalty,0)+' guess'+(safeInt(node.skipPenalty,0)===1?'':'es')+' (skipped upgrades)');
  }
  if(run.upgrades && run.upgrades.length){
    var upTags=run.upgrades.map(function(id){
      var up=runGetUpgrade(id);
      return up ? up.label : id;
    });
    addIntroItem(meta,'Run Upgrades', upTags);
  }else{
    addIntroItem(meta,'Run Upgrades','None');
  }
  if(run.clusterTraits && run.clusterTraits.length){
    var traitTags=run.clusterTraits.map(function(id){
      var tr=runGetClusterTrait(id);
      return tr ? tr.label : id;
    });
    addIntroItem(meta,'Cluster Traits', traitTags);
  }
  if(run.tempBuffs){
    var buffs=[];
    if(run.tempBuffs.guess){ buffs.push('Guess +'+run.tempBuffs.guess); }
    if(run.tempBuffs.lifeline){ buffs.push('Lifeline +'+run.tempBuffs.lifeline); }
    if(run.tempBuffs.countdown){ buffs.push('Countdown +'+run.tempBuffs.countdown+'s'); }
    if(run.tempBuffs.budget){ buffs.push('Budget +'+run.tempBuffs.budget); }
    if(run.tempBuffs.reward){ buffs.push('Reward +'+run.tempBuffs.reward); }
    if(run.tempBuffs.signalClean){ buffs.push('Signal Clean'); }
    if(run.tempBuffs.minDistanceRelief){ buffs.push('Min Dist -'+run.tempBuffs.minDistanceRelief); }
    if(run.tempBuffs.wildcard){ buffs.push('Wildcard On'); }
    if(buffs.length){ addIntroItem(meta,'Cluster Buffs', buffs); }
  }
}
function describeMutators(mut){
  if(!mut) return [];
  var list=[];
  if(mut.blindStart) list.push({key:'blindStart', label:'Blind Start'});
  if(mut.echo) list.push({key:'echo', label:'Echo'});
  if(mut.vowelsOnly) list.push({key:'vowelsOnly', label:'Vowel Gate'});
  if(mut.mirror) list.push({key:'mirror', label:'Mirror Board'});
  if(mut.staticTile) list.push({key:'staticTile', label:'Static Tile'});
  if(mut.drift) list.push({key:'drift', label:'Drift'});
  if(mut.fog) list.push({key:'fog', label:'Fog of War'});
  if(mut.budget) list.push({key:'budget', label:'Budget '+clampBudget(mut.budgetPoints)+' LP'});
  if(mut.doubleVision) list.push({key:'doubleVision', label:'Double Vision'});
  if(mut.bloodMirage) list.push({key:'bloodMirage', label:'Blood Mirage'});
  if(mut.randomKeyboard) list.push({key:'randomKeyboard', label:'Random Keyboard'});
  if(mut.lifeline) list.push({key:'lifeline', label:'Lifeline x'+clampLifeCount(mut.lifelineCount)});
  if(mut.wildcard) list.push({key:'wildcard', label:'Wildcard'});
  if(mut.noisyArrows) list.push({key:'noisyArrows', label:'Noisy Arrows'});
  if(mut.hotPotato) list.push({key:'hotPotato', label:'Hot Potato'});
  if(mut.phantomLetter) list.push({key:'phantomLetter', label:'Phantom Letter'});
  if(mut.copycat) list.push({key:'copycat', label:'Copycat '+(mut.copycatMin || 2)});
  if(mut.minDistance) list.push({key:'minDistance', label:'Min Distance '+clampMinDistance(mut.minDistanceVal)});
  if(mut.countdown) list.push({key:'countdown', label:'Countdown '+(mut.countdownSec || 30)+'s'});
  return list;
}
function buildCampaignMenu(){
  ensureRunCampaign();
  if(!campaignNodesEl || !campaignSvg) return;
  if(campaignMapEl){ campaignMapEl.style.setProperty('--cluster-hue', runClusterHueDeg(runCampaign.cluster)+'deg'); }
  var mapSub=$('.map-sub');
  if(mapSub){ mapSub.textContent='Cluster '+runCampaign.cluster+' - clear '+RUN_CLUSTER_DEPTH+' nodes, then beat the boss.'; }
  campaignNodesEl.innerHTML='';
  while(campaignSvg.firstChild) campaignSvg.removeChild(campaignSvg.firstChild);
  var nodes=Object.keys(runCampaign.nodes).map(function(id){ return runCampaign.nodes[id]; });
  nodes.sort(function(a,b){
    if(a.map.y!==b.map.y) return b.map.y-a.map.y;
    return a.map.x-b.map.x;
  });
  nodes.forEach(function(node){
    var setId=RUN_SET_PREFIX+node.id;
    var saved=(node.type!=='upgrade') ? load(campaignKey(setId), null) : null;
    var completed=!!runCampaign.completed[node.id];
    var skipped=!!runCampaign.skipped[node.id];
    var choiceLocked=(node.type==='upgrade' && skipped);
    var available=(runCampaign.frontier||[]).indexOf(node.id)!==-1;
    var locked=!available && !completed && !saved;
    var isNonPack=!runIsPackNodeType(node.type);
    var cls='map-node'+(locked?' locked':'')+(saved?' resume':'')+(completed?' complete':'');
    if(node.type==='upgrade') cls+=' upgrade-node';
    if(node.type==='elite') cls+=' elite-node';
    if(choiceLocked) cls+=' choice-locked';
    else if(skipped) cls+=' teaser';
    var badge=choiceLocked ? 'CHOICE LOCKED' : ((node.type==='upgrade')?'UPGRADE':(node.type==='boss'?'BOSS':(node.type==='elite'?'ELITE':(displayDifficulty(node)||'').toUpperCase())));
    var title=node.title || node.id;
    var btn=document.createElement('button');
    btn.className=cls;
    btn.setAttribute('data-set', node.id);
    btn.innerHTML='<span class="map-diff">'+badge+'</span><span class="dot"></span>'+title;
    btn.style.left=(node.map && node.map.x || 50)+'%';
    btn.style.top=(node.map && node.map.y || 50)+'%';
    if(locked){
      btn.title=choiceLocked ? 'Choice locked: picked another upgrade' : (skipped ? 'Skipped path' : 'Locked');
    }else if(saved){
      btn.title='Resume';
    }else if(completed){
      btn.title='Complete';
    }else{
      btn.title='Start';
    }
    btn.addEventListener('click', function(){
      if(locked || completed) return;
      startCampaign(node.id);
    });
    campaignNodesEl.appendChild(btn);
  });
  (runCampaign.links||[]).forEach(function(link){
    var from=runCampaign.nodes[link[0]];
    var to=runCampaign.nodes[link[1]];
    if(!from || !to) return;
    var linkTouchesNonPack=!runIsPackNodeType(from.type) || !runIsPackNodeType(to.type);
    var eliteLink=(from.type==='elite' || to.type==='elite');
    var choiceLockedLink=(to.type==='upgrade' && !!runCampaign.skipped[to.id]);
    var line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', from.map.x+'%');
    line.setAttribute('y1', from.map.y+'%');
    line.setAttribute('x2', to.map.x+'%');
    line.setAttribute('y2', to.map.y+'%');
    if(choiceLockedLink){
      line.setAttribute('class','campaign-link-choice-locked');
    }else if(eliteLink){
      line.setAttribute('class','campaign-link-elite');
    }else{
      line.setAttribute('class', linkTouchesNonPack ? 'campaign-link-upgrade' : 'campaign-link-pack');
    }
    if(linkTouchesNonPack && !choiceLockedLink){
      line.style.animationDelay=(Math.random()*3).toFixed(2)+'s';
      line.style.strokeDashoffset=((Math.random()*24)|0)+'';
    }
    campaignSvg.appendChild(line);
    for(var i=1;i<=6;i++){
      var cx=from.map.x + (to.map.x - from.map.x)*(i/7);
      var cy=from.map.y + (to.map.y - from.map.y)*(i/7);
      var dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx', cx+'%');
      dot.setAttribute('cy', cy+'%');
      dot.setAttribute('r', eliteLink ? 3.7 : (linkTouchesNonPack ? 3.6 : 3.2));
      dot.setAttribute('fill', choiceLockedLink ? 'rgba(255,154,154,.95)' : (eliteLink ? 'rgba(255,126,126,.95)' : (linkTouchesNonPack ? 'rgba(255,200,138,.95)' : 'rgba(146,196,255,.95)')));
      if(choiceLockedLink){ dot.setAttribute('class','map-link-dot-choice-locked'); }
      else if(eliteLink){ dot.setAttribute('class','map-link-dot-elite'); }
      else if(linkTouchesNonPack){ dot.setAttribute('class','map-link-dot-upgrade'); }
      campaignSvg.appendChild(dot);
    }
  });
  saveCurrency();
}
function isPackUnlocked(set){
  ensureRunCampaign();
  if(!set || !set.id || !runCampaign.nodes[set.id]) return false;
  return !!runCampaign.completed[set.id] || (runCampaign.frontier||[]).indexOf(set.id)!==-1;
}
function isCampaignUnlocked(set){ return isPackUnlocked(set); }
function pickCampaignFocusSet(){
  ensureRunCampaign();
  var targetId=null;
  for(var i=0;i<(runCampaign.frontier||[]).length;i++){
    var fid=runCampaign.frontier[i];
    var node=runCampaign.nodes[fid];
    if(!node) continue;
    if(node.type!=='upgrade'){ targetId=fid; break; }
    if(!targetId) targetId=fid;
  }
  if(!targetId){
    var keys=Object.keys(runCampaign.completed||{});
    if(keys.length) targetId=keys[keys.length-1];
  }
  if(!targetId){
    var ids=Object.keys(runCampaign.nodes||{});
    targetId=ids.length?ids[0]:null;
  }
  return targetId ? runCampaign.nodes[targetId] : null;
}
function focusCampaignMap(){
  if(!campaignMapEl || !campaignPanEl) return;
  var target=pickCampaignFocusSet();
  if(!target) return;
  var mapW=campaignMapEl.clientWidth;
  var mapH=campaignMapEl.clientHeight;
  var panW=campaignPanEl.clientWidth;
  var panH=campaignPanEl.clientHeight;
  if(!mapW || !mapH || !panW || !panH){
    requestAnimationFrame(focusCampaignMap);
    return;
  }
  var pos=target.map || {x:50,y:50};
  var tx=mapW/2 - panW*(pos.x/100);
  var ty=mapH/2 - panH*(pos.y/100);
  if(campaignPanEl.__setPan){ campaignPanEl.__setPan(Math.round(tx), Math.round(ty), true); }
  else{ campaignPanEl.style.transform='translate('+Math.round(tx)+'px,'+Math.round(ty)+'px)'; }
}
function campaignMaxGuesses(set, len, starter){
  if(set && typeof set.maxGuesses==='number'){ return clamp(set.maxGuesses,2,20); }
  var difficulty=(set && set.difficulty) ? set.difficulty : 'normal';
  if(difficulty==='easy') return clamp(len + (starter?1:2), 4, 10);
  if(difficulty==='hard') return clamp(len, 4, 8);
  return clamp(len+1,4,9);
}
function wordEntry(set, index){
  var entry=(set && set.words) ? set.words[index] : null;
  if(typeof entry==='string'){ return {word:entry, starter:'', mutators:null}; }
  return {
    word: entry && entry.word ? entry.word : '',
    starter: entry && entry.starter ? entry.starter : '',
    mutators: entry && entry.mutators ? entry.mutators : null
  };
}
function beginCampaignWord(set, index){
  cleanupGameplayTimers();
  var entry=wordEntry(set, index);
  var w=lettersOnlyUpper(entry.word);
  if(!w) return;
  activeCampaign={setId:set.id, index:index, nodeId:set.nodeId || runNodeFromSetId(set.id)};
  runCampaign.activeNodeId=activeCampaign.nodeId || null;
  runSave();
  state.mode='campaign';
  state.pendingCampaignTimeout=false;
  setBodyMode('campaign');
  var node=runResolveNodeForSet(set);
  setCampaignBossMode(!!(node && node.type==='boss'));
  var mergedMutators = Object.assign({}, set.mutators || null, entry.mutators || null);
  state.campaignMutators = normalizeMutators(mergedMutators);
  state.campaignMutators.lifelineCount=clampLifeCount(state.campaignMutators.lifelineCount);
  state.campaignMutators.budgetPoints=clampBudget(state.campaignMutators.budgetPoints);
  resetKeyboardLayout();
  state.target=w;
  state.max=campaignMaxGuesses(set, w.length, entry.starter);
  state.difficulty=set.difficulty;
  state.enforce=true;
  buildBoard(false);
  saveSession();
  if(entry.starter){ seedStarterGuess(entry.starter); }
  requestAnimationFrame(playCampaignIntroAnimation);
}
function advanceCampaign(set){
  var next=activeCampaign.index+1;
  if(next<(set.words||[]).length){
    beginCampaignWord(set, next);
    return;
  }
  var node=runResolveNodeForSet(set);
  if(!node){
    showMenu();
    return;
  }
  celebrate();
  var result=runCompleteNodeAndAdvance(node, set, {auto:false});
  if(result==='boss'){
    toast('Boss clear! Cluster '+runCampaign.cluster+' unlocked. Shop open.');
    setTimeout(showCampaignMenu, 700);
    return;
  }
  if(result==='boss_unlocked'){
    toast('Depth '+RUN_CLUSTER_DEPTH+' reached. Boss node unlocked.');
  }else{
    toast('Node clear! Choose your next pack or grab an upgrade.');
  }
  setTimeout(showCampaignMenu, 650);
}
function showCampaignFail(set){
  var modal=$('#campaignFail');
  if(!modal) return;
  runFailPendingReset=true;
  var node=runResolveNodeForSet(set);
  $('#failMsg').textContent = (node && node.type==='boss')
    ? 'Boss failed. The run resets.'
    : 'Run failed. Start a new run?';
  var btnRestart=$('#failRestart');
  btnRestart.textContent='Start new run';
  btnRestart.disabled=false;
  modal.classList.add('open');
  var onMenu=function(){
    modal.classList.remove('open');
    btnRestart.removeEventListener('click', onRestart);
    $('#failMenu').removeEventListener('click', onMenu);
    runFailPendingReset=false;
    runRestartCampaign();
    activeCampaign=null;
    showMenu();
  };
  var onRestart=function(){
    modal.classList.remove('open');
    btnRestart.removeEventListener('click', onRestart);
    $('#failMenu').removeEventListener('click', onMenu);
    runFailPendingReset=false;
    runRestartCampaign();
    activeCampaign=null;
    showCampaignMenu();
  };
  $('#failMenu').addEventListener('click', onMenu);
  btnRestart.addEventListener('click', onRestart);
}
function startCampaign(nodeId){
  ensureRunCampaign();
  var node=runCampaign.nodes[nodeId];
  if(!node){
    toast('Node unavailable.');
    return;
  }
  var available=(runCampaign.frontier||[]).indexOf(node.id)!==-1;
  var set=node.type==='upgrade'
    ? {id:RUN_SET_PREFIX+node.id,nodeId:node.id,nodeType:'upgrade',title:node.title,intro:node.intro,difficulty:'normal',displayDifficulty:'upgrade',mutators:null,words:[],maxGuesses:0,reward:0}
    : runBuildSetFromNode(node);
  var saved=(node.type!=='upgrade') ? load(campaignKey(set.id), null) : null;
  if(!available && !saved){
    toast('Node is locked.');
    return;
  }
  showCampaignIntro(set, function(){
    if(node.type==='upgrade'){
      runApplyUpgradeNode(node);
      toast(node.title+' unlocked.');
      buildCampaignMenu();
      updateCampaignProgress();
      return true;
    }
    var savedSession=load(campaignKey(set.id), null);
    if(available && !savedSession){
      var lockedUpgrades=runLockVisibleUpgrades(node.id, true);
      if(lockedUpgrades>0){
        runSave();
        delete RUN_RUNTIME_SETS[set.id];
        set=runBuildSetFromNode(node);
        toast('Skipped '+lockedUpgrades+' upgrade'+(lockedUpgrades===1?'':'s')+'. -'+lockedUpgrades+' guess'+(lockedUpgrades===1?'':'es')+' this node.');
      }
    }
    menuScreen.classList.remove('active');
    campaignMenuScreen.classList.remove('active');
    $('#app').classList.add('active');
    if(!started){
      started=true;
      buildKeyboard();
    }
    state.mode='campaign';
    setBodyMode('campaign');
    setCampaignBossMode(!!(node && node.type==='boss'));
    state.enforce=true;
    state.difficulty=set.difficulty;
    document.documentElement.style.setProperty('--vh', window.innerHeight+'px');
    save('lastVisit', Date.now());
    setTimeout(downloadDict,50);
    if(savedSession && savedSession.campaignId===set.id && typeof savedSession.campaignIndex==='number' && !savedSession.gameOver){
      activeCampaign={setId:set.id, index:clamp(savedSession.campaignIndex,0,(set.words||[]).length-1), nodeId:node.id};
      runCampaign.activeNodeId=node.id;
      runSave();
      state.campaignMutators=normalizeMutators(set.mutators || savedSession.campaignMutators || null);
      state.campaignMutators.lifelineCount=clampLifeCount(state.campaignMutators.lifelineCount);
      state.campaignMutators.budgetPoints=clampBudget(state.campaignMutators.budgetPoints);
      resetKeyboardLayout();
      applySessionSettings(savedSession);
      state.difficulty=set.difficulty;
      state.enforce=true;
      applySessionProgress(savedSession);
      applyCampaignResumeDecay(savedSession);
      buildBoard(true);
      if(state.pendingCampaignTimeout){
        state.pendingCampaignTimeout=false;
        setTimeout(function(){ failCampaignLevel('Time expired while away.'); }, 80);
        return true;
      }
      scheduleScrollToActiveRow();
      return true;
    }
    beginCampaignWord(set, 0);
    return true;
  });
}
function updateCampaignProgress(){
  var el=$('#campaignProgress');
  if(!el) return;
  if(state.mode!=='campaign' || !activeCampaign){ el.textContent=''; return; }
  ensureRunCampaign();
  var node=runResolveNodeForSet(getCampaignSet(activeCampaign.setId));
  if(!node){ el.textContent=''; return; }
  var seg='Cluster '+runCampaign.cluster+' ';
  if(node.type==='boss'){ seg += ' - Boss'; }
  else if(node.type==='elite'){ seg += ' - Elite '+Math.max(1,node.packStage||1)+'/'+RUN_CLUSTER_DEPTH; }
  else{ seg += ' - Pack '+Math.max(1,node.packStage||1)+'/'+RUN_CLUSTER_DEPTH; }
  var set=getCampaignSet(activeCampaign.setId);
  var total=set && set.words ? set.words.length : 0;
  var idx=(typeof activeCampaign.index==='number') ? (activeCampaign.index+1) : 0;
  if(total>0){ seg += ' â€¢ Level '+idx+'/'+total; }
  el.textContent=seg;
}

function showMenu(){
  saveSession();
  cleanupGameplayTimers();
  hidePassOverlay();
  if(state.mode==='hotseat'){ state.hotseat=null; }
  menuScreen.classList.add('active');
  campaignMenuScreen.classList.remove('active');
  $('#app').classList.remove('active');
  state.mode='menu';
  activeCampaign=null;
  document.body.classList.remove('campaign-intro');
  if(campaignIntroTimer){ clearTimeout(campaignIntroTimer); campaignIntroTimer=null; }
  setBodyMode(null);
  setCampaignBossMode(false);
  closeCampaignShop();
  buildCampaignMenu();
  resetKeyboardLayout();
  updateCampaignProgress();
}

function openOptions(){
  var modal=$('#optionsModal');
  if(modal) modal.classList.add('open');
  var inp=$('#optWordReviewUrl');
  if(inp) inp.value=runWordReviewFileUrl;
}
function closeOptions(){
  var modal=$('#optionsModal');
  if(modal) modal.classList.remove('open');
}
function applySandboxDefaults(){
  var t=lettersOnlyUpper(load('target','CRANE')) || 'CRANE';
  var maxGuess=safeInt(load('max', recGuesses(t.length)), recGuesses(t.length));
  state.target=t;
  state.max=clamp(maxGuess,3,20);
  state.difficulty=load('difficulty','normal') || 'normal';
  state.fadeColor=!!load('fadeColor',false);
  state.enforce=load('enforce',true);
  state.dictUrl=load('dictUrl', state.dictUrl);
  state.mutators=normalizeMutators(load('mutators', null));
  state.mutators.lifelineCount=clampLifeCount(state.mutators.lifelineCount);
  state.mutators.budgetPoints=clampBudget(state.mutators.budgetPoints);
  var theme=load('theme', state.theme) || 'classic';
  state.theme=theme;
  document.documentElement.setAttribute('data-theme', theme);
}
function showCampaignMenu(){
  saveSession();
  cleanupGameplayTimers();
  menuScreen.classList.remove('active');
  campaignMenuScreen.classList.add('active');
  $('#app').classList.remove('active');
  state.mode='menu';
  activeCampaign=null;
  setBodyMode('atlas');
  setCampaignBossMode(false);
  setTimeout(downloadDict,50);
  runLoadWordReviewFromFile({silent:true});
  buildCampaignMenu();
  resetKeyboardLayout();
  requestAnimationFrame(focusCampaignMap);
  setTimeout(maybeOpenCampaignShop, 90);
}
function startHotseat(){
  cleanupGameplayTimers();
  var target=hotseatPickTarget();
  if(!target) return;
  menuScreen.classList.remove('active');
  campaignMenuScreen.classList.remove('active');
  $('#app').classList.add('active');
  setBodyMode('hotseat');
  setCampaignBossMode(false);
  state.mode='hotseat';
  if(!started){
    started=true;
    buildKeyboard();
  }
  resetKeyboardLayout();
  state.target=target;
  state.max=12;
  state.difficulty='normal';
  state.fadeColor=false;
  state.enforce=false;
  hotseatResetMatch();
  document.documentElement.style.setProperty('--vh', window.innerHeight+'px');
  buildBoard(false);
  if(SCROLL){ SCROLL.scrollTop=0; }
  scheduleScrollToActiveRow();
  hotseatStartRound();
  setTimeout(downloadDict,50);
}
function startSandbox(){
  cleanupGameplayTimers();
  var session=load('session', null);
  var proceed=function(resume){
    menuScreen.classList.remove('active');
    campaignMenuScreen.classList.remove('active');
    $('#app').classList.add('active');
    setBodyMode('sandbox');
    setCampaignBossMode(false);
    state.mode='sandbox';
    if(!started){
      started=true;
      buildKeyboard();
    }
    if(started && !mutOn('randomKeyboard')) resetKeyboardLayout();
    applySandboxDefaults();
    document.documentElement.style.setProperty('--vh', window.innerHeight+'px');
    save('lastVisit', Date.now());
    if(session && hasProgress(session)){
      applySessionSettings(session);
      if(resume){
        applySessionProgress(session);
        if(mutOn('mirror') && state.hintsRaw && state.hintsRaw[0] && state.row>1){
          state.hints[0]=state.hintsRaw[0];
          state.hintsRaw[0]=null;
        }
      }
    }
    buildBoard(!!resume);
    if(resume) scheduleScrollToActiveRow();
    setTimeout(downloadDict,50);
  };
  if(session && hasProgress(session)){
    var modal = $('#resumePrompt');
    if(modal){
      $('#app').classList.remove('active');
      campaignMenuScreen.classList.remove('active');
      menuScreen.classList.add('active');
      modal.classList.add('open');
      var onYes = function(){
        modal.classList.remove('open');
        $('#resumeYes').removeEventListener('click', onYes);
        $('#resumeNew').removeEventListener('click', onNew);
        proceed(true);
      };
      var onNew = function(){
        modal.classList.remove('open');
        $('#resumeYes').removeEventListener('click', onYes);
        $('#resumeNew').removeEventListener('click', onNew);
        proceed(false);
      };
      $('#resumeYes').addEventListener('click', onYes);
      $('#resumeNew').addEventListener('click', onNew);
      return;
    }
  }
  proceed(false);
}

if(optionsBtn){ optionsBtn.addEventListener('click', openOptions); }
sandboxBtn.addEventListener('click', startSandbox);
if(hotseatBtn){ hotseatBtn.addEventListener('click', openHotseatLobby); }
if(wordReviewBtn){ wordReviewBtn.addEventListener('click', openWordReviewModal); }
menuBtn.addEventListener('click', showMenu);
campaignOpenBtn.addEventListener('click', showCampaignMenu);
campaignBackBtn.addEventListener('click', showMenu);
menuFsBtn.addEventListener('click', function(){ var b=$('#btnFS'); if(b) b.click(); });
if(campaignShopEl){
  campaignShopEl.addEventListener('click', function(e){
    var btn=(e.target.closest && e.target.closest('button[data-shop-kind]')) ? e.target.closest('button[data-shop-kind]') : null;
    if(btn){
      var kind=btn.getAttribute('data-shop-kind');
      var id=btn.getAttribute('data-shop-id');
      if(kind==='trait') runChooseShopTrait(id);
      else if(kind==='consumable' || kind==='permanent') runBuyShopEntry(kind, id);
      return;
    }
    if(e.target===campaignShopEl){ finishCampaignShop(); }
  });
}
if(shopSkipBtn){ shopSkipBtn.addEventListener('click', finishCampaignShop); }
if(shopContinueBtn){ shopContinueBtn.addEventListener('click', finishCampaignShop); }
var optClose=$('#optClose');
if(optClose){ optClose.addEventListener('click', closeOptions); }
var optResetCampaign=$('#optResetCampaign');
if(optResetCampaign){
  optResetCampaign.addEventListener('click', function(){
    if(!confirm('Reset all campaign progress, sessions, and coins?')) return;
    if(runCampaign && runCampaign.nodes){ runClearNodeSessions(runCampaign.nodes); }
    removeKey(RUN_CAMPAIGN_KEY);
    runCampaign=null;
    ensureRunCampaign();
    removeKey('campaign_done');
    currency=0;
    saveCurrency();
    activeCampaign=null;
    buildCampaignMenu();
    focusCampaignMap();
    toast('Campaign progress reset.');
  });
}
var optClearSandbox=$('#optClearSandbox');
if(optClearSandbox){
  optClearSandbox.addEventListener('click', function(){
    if(!confirm('Clear the saved sandbox session?')) return;
    removeKey('session');
    toast('Sandbox session cleared.');
  });
}
var optWordReviewUrl=$('#optWordReviewUrl');
var optWordReviewReload=$('#optWordReviewReload');
if(optWordReviewReload){
  optWordReviewReload.addEventListener('click', function(){
    var nextUrl=optWordReviewUrl ? optWordReviewUrl.value : runWordReviewFileUrl;
    runSetWordReviewFileUrl(nextUrl);
    runLoadWordReviewFromFile({silent:false, force:true}).then(function(){
      runRenderWordReview(true);
    });
  });
}
if(optWordReviewUrl){
  optWordReviewUrl.addEventListener('change', function(){
    runSetWordReviewFileUrl(optWordReviewUrl.value);
  });
}
if(hsWordSource){
  hsWordSource.addEventListener('change', toggleHotseatCustomRow);
  hsWordSource.addEventListener('click', toggleHotseatCustomRow);
}
if(hsStartBtn){
  hsStartBtn.addEventListener('click', function(){
    applyHotseatSettingsFromUI();
    if(state.hotseatSettings && state.hotseatSettings.wordSource==='custom'){
      var w=lettersOnlyUpper(state.hotseatSettings.customWord || '');
      if(w.length!==6){ toast('Custom word must be 6 letters.'); return; }
    }
    closeHotseatLobby();
    startHotseat();
  });
}
if(hsCloseBtn){ hsCloseBtn.addEventListener('click', closeHotseatLobby); }
if(hotseatLobby){
  hotseatLobby.addEventListener('click', function(e){
    var sw = (e.target.closest && e.target.closest('.switch')) ? e.target.closest('.switch') : null;
    if(sw){ toggleSwitch(sw); }
    var label = (e.target.closest && e.target.closest('.row label')) ? e.target.closest('.row label') : null;
    if(label){
      var row = label.closest('.row');
      if(row){
        var sw2 = row.querySelector('.switch');
        if(sw2){ toggleSwitch(sw2); }
      }
    }
    if(e.target.id==='hotseatLobby') closeHotseatLobby();
  });
}
runUpdateWordReviewControls();
if(wrCloseBtn){ wrCloseBtn.addEventListener('click', closeWordReviewModal); }
if(wrListEl){
  wrListEl.addEventListener('click', function(e){
    var btn=(e.target.closest && e.target.closest('button[data-wr-action]')) ? e.target.closest('button[data-wr-action]') : null;
    if(!btn) return;
    var action=btn.getAttribute('data-wr-action');
    var word=lettersOnlyUpper(btn.getAttribute('data-word') || '');
    if(!word) return;
    if(action==='approve') runApplyWordReviewDecision(word, true);
    else if(action==='reject') runApplyWordReviewDecision(word, false);
    else if(action==='skip') runSkipWordReviewWord(word);
  });
}
if(wrBindFileBtn){ wrBindFileBtn.addEventListener('click', function(){ runBindWordReviewFile(); }); }
if(wrSaveFileBtn){ wrSaveFileBtn.addEventListener('click', function(){ var useRemote=runWordReviewRemoteWritable(); runSaveWordReviewToFile({silent:useRemote}).then(function(ok){ if(ok) return; return runSaveWordReviewToRemote({silent:false}); }); }); }
if(wrReloadBtn){ wrReloadBtn.addEventListener('click', function(){ runLoadWordReviewFromFile({silent:false, force:true}).then(function(){ runRenderWordReview(true); }); }); }
if(wordReviewModal){
  wordReviewModal.addEventListener('click', function(e){
    if(e.target===wordReviewModal) closeWordReviewModal();
  });
}
if(PASS_OVERLAY){ PASS_OVERLAY.addEventListener('click', hidePassOverlay); }
buildCampaignMenu();
showMenu();
runLoadWordReviewFromFile({silent:true});
if(campaignPanEl){
  (function(){
    var isDown=false, startX=0, startY=0, curX=0, curY=0, targetX=0, targetY=0;
    var rafId=null, hasPan=false, activePointer=null;
    function updateParallax(x,y){
      if(!campaignMapEl) return;
      var px=Math.max(-36, Math.min(36, x*0.2));
      var py=Math.max(-52, Math.min(52, y*0.3));
      var px2=Math.max(-22, Math.min(22, x*0.1));
      var py2=Math.max(-32, Math.min(32, y*0.16));
      campaignMapEl.style.setProperty('--parallax-x', px.toFixed(1)+'px');
      campaignMapEl.style.setProperty('--parallax-y', py.toFixed(1)+'px');
      campaignMapEl.style.setProperty('--parallax-x2', px2.toFixed(1)+'px');
      campaignMapEl.style.setProperty('--parallax-y2', py2.toFixed(1)+'px');
    }
    function applyPos(x,y){
      campaignPanEl.style.transform='translate('+x.toFixed(1)+'px,'+y.toFixed(1)+'px)';
      updateParallax(x,y);
    }
    function tick(){
      var dx=targetX-curX, dy=targetY-curY;
      if(Math.abs(dx)<0.1 && Math.abs(dy)<0.1){
        curX=targetX; curY=targetY;
        applyPos(curX, curY);
        rafId=null;
        return;
      }
      curX+=dx*0.2;
      curY+=dy*0.2;
      applyPos(curX, curY);
      rafId=requestAnimationFrame(tick);
    }
    function ensureTick(){ if(!rafId) rafId=requestAnimationFrame(tick); }
    function setPos(x,y,snap){
      targetX=x; targetY=y;
      if(snap || !hasPan){
        curX=x; curY=y; hasPan=true;
        applyPos(curX, curY);
      }else{
        ensureTick();
      }
    }
    campaignPanEl.__setPan=setPos;
    function endPan(){
      if(!isDown) return;
      isDown=false;
      if(campaignMapEl.releasePointerCapture && activePointer!==null){
        try{ campaignMapEl.releasePointerCapture(activePointer); }catch(e){}
      }
      activePointer=null;
    }
    campaignMapEl.addEventListener('pointerdown', function(e){
      if(e.target && e.target.closest && e.target.closest('.map-node')) return;
      isDown=true;
      activePointer=e.pointerId;
      startX=e.clientX-curX;
      startY=e.clientY-curY;
      if(campaignMapEl.setPointerCapture){
        try{ campaignMapEl.setPointerCapture(e.pointerId); }catch(e){}
      }
      e.preventDefault();
    });
    campaignMapEl.addEventListener('pointermove', function(e){
      if(!isDown || (activePointer!==null && e.pointerId!==activePointer)) return;
      targetX=e.clientX-startX;
      targetY=e.clientY-startY;
      ensureTick();
      e.preventDefault();
    });
    campaignMapEl.addEventListener('pointerup', endPan);
    campaignMapEl.addEventListener('pointercancel', endPan);
    campaignMapEl.addEventListener('pointerleave', endPan);
    window.addEventListener('blur', endPan);
  })();
}
window.addEventListener('beforeunload', function(){
  if(runFailPendingReset){
    runRestartCampaign();
    activeCampaign=null;
    runFailPendingReset=false;
  }
  save('lastVisit', Date.now());
  persistSettings();
});
})();
</script>

<script>
// --- Enhanced candidate generator using all prior hints (compat-safe) ---
(function(){
  function aIdx(ch){ return ch.charCodeAt(0)-65 }
  function idxToChar(i){ if(i<0) i=0; if(i>25) i=25; return String.fromCharCode(65+i) }
  function effectiveDifficulty(d){ return (d==='beginner') ? 'normal' : (d||'normal'); }
  var ALPHA='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  var BOARD = document.getElementById('board');
  var KBD = document.getElementById('kbd');
  var toastEl = document.getElementById('toast');
  var toastTimer=null;
  function toast(msg,ms){
    ms=ms||1200;
    toastEl.textContent=msg;
    toastEl.classList.add('show');
    if(toastTimer){ clearTimeout(toastTimer); toastTimer=null; }
    toastTimer=setTimeout(function(){ toastEl.classList.remove('show'); },ms);
  }
  function clearKbdHints(){
    KBD.classList.remove('kbd-hints-on');
    var keys = KBD.querySelectorAll('.key[data-key]');
    for(var i=0;i<keys.length;i++){ keys[i].classList.remove('cand','nocand'); }
    if(window.__wordshift_state) window.__wordshift_state.kbdHintsOn=false;
  }
  function clearTypingPreview(){
    KBD.classList.remove('kbd-preview-on');
    var keys = KBD.querySelectorAll('.key[data-key]');
    for(var i=0;i<keys.length;i++){ keys[i].classList.remove('pcand','pnocand'); }
  }
  function intersect(a,b){
    if(!a) return b; if(!b) return a;
    var o=new Set(); a.forEach(function(x){ if(b.has(x)) o.add(x) }); return o;
  }
  function setFromArray(arr){ var s=new Set(); for(var i=0;i<arr.length;i++) s.add(arr[i]); return s; }
  function activeMutators(st){
    return (st && st.mode==='campaign' ? st.campaignMutators : st.mutators) || st.mutators || st.campaignMutators || {};
  }
  function isDoubleVisionMask(st, r, c){
    if(!st) return false;
    var mut=activeMutators(st);
    if(!mut.doubleVision) return false;
    if(st.gameOver) return false;
    var active=st.row-1;
    if(active<1 || r!==active) return false;
    var dv=st.doubleVision || {};
    return (typeof dv[r]==='number') && dv[r]===c;
  }

  // Build candidate set from one hint row for a specific column
  function candidatesFromHintForColumn(r, c, allowDV, allowFog){
    var S = new Set();
    var st = window.__wordshift_state; if(!st) return S;
    var hint = (st.hints && st.hints[r]) ? st.hints[r][c] : null;
    var guessCh = (st.grid && st.grid[r] && st.grid[r][c]) ? st.grid[r][c] : '';
    if(!allowDV && isDoubleVisionMask(st, r, c)) return null;
    if(!hint || hint.hidden || !guessCh) return null; // no info
    if(hint.noisyArrow) return null;
    if(!allowFog && st.mutators && st.mutators.fog && r!==(st.gameOver ? st.row : st.row-1)) return null;
    if(hint.exact){ S.add(guessCh); return S; }
    var gi = aIdx(guessCh);
    if(hint.showNumber){
      var dirN = hint.dir>0 ? +1 : -1;
      S.add(idxToChar(gi + dirN*hint.dist));
      return S;
    }

    if(hint.grayed){
      var dnameG = effectiveDifficulty(st.difficulty);
      if(dnameG==='impossible'){
        // |T-gi| >= 4
        for(var i=0;i<26;i++){ if(Math.abs(i-gi)>=4) S.add(idxToChar(i)); }
      }else{
        // |T-gi| >= 10
        for(var i2=0;i2<26;i2++){ if(Math.abs(i2-gi)>=10) S.add(idxToChar(i2)); }
      }
      return S;
    }
    // Otherwise use direction & (if needed) difficulty rules
    var dname = effectiveDifficulty(st.difficulty);
    var dir = hint.dir>0 ? +1 : -1;
    if(dname==='easy'){
      // Any distance in the given direction; if within 3 we know exact number
      if(hint.dist<=3){
        S.add(idxToChar(gi + dir*hint.dist));
      }else{
        for(var d=1; d<=25; d++){
          var i = gi + dir*d; if(i>=0&&i<26) S.add(idxToChar(i));
        }
      }
    }else if(dname==='normal'){
      for(var d=1; d<=25; d++){
        var i = gi + dir*d; if(i>=0&&i<26) S.add(idxToChar(i));
      }
    }else if(dname==='hard'){
      for(var d=1; d<=25; d++){
        var i = gi + dir*d; if(i>=0&&i<26) S.add(idxToChar(i));
      }
    }else if(dname==='insane'){
      // arrows only shown when <=3; otherwise no arrow (handled by caller as no info)
      if(hint.showArrow){
        for(var d=1; d<=3; d++){
          var i = gi + dir*d; if(i>=0&&i<26) S.add(idxToChar(i));
        }
      } else {
        // If we didn't have an arrow but also not grayed, then 4..9 in any dir
        for(var d=4; d<=9; d++){
          if(gi+d<26) S.add(idxToChar(gi+d));
          if(gi-d>=0) S.add(idxToChar(gi-d));
        }
      }
    }else if(dname==='impossible'){
      // No arrows; if not grayed then 1..3 any dir
      for(var d=1; d<=3; d++){
        if(gi+d<26) S.add(idxToChar(gi+d));
        if(gi-d>=0) S.add(idxToChar(gi-d));
      }
    }
    return S;
  }

  // Capture-phase handler to override the older click logic
  var lastTapAt=0, lastTapKey='';
  function enhancedTileTap(e){
    var tile = (e.target.closest && e.target.closest('.tile')) ? e.target.closest('.tile') : null;
    if(!tile) return;
    var st = window.__wordshift_state || window.state || null;
    if(!st) { return; }
    if(st.mode==='hotseat'){ return; }
    var r = parseInt(tile.getAttribute('data-row'),10);
    var c = parseInt(tile.getAttribute('data-col'),10);
    // We only act on last submitted row
    var lastRow = st.gameOver ? st.row : (st.row-1);
    if(r!==lastRow) return;
    if(tile.classList.contains('fogged') || tile.classList.contains('hidden')) return;
    var isDV = isDoubleVisionMask(st, r, c);
    var tapRow = isDV ? (r-1) : r;
    if(tapRow<0) return;
    var hintTap = (st.hints && st.hints[tapRow]) ? st.hints[tapRow][c] : null;
    var tapKey = r+':'+c;
    var now = Date.now();
    var isDouble = (tapKey===lastTapKey && (now-lastTapAt)<320);
    lastTapAt=now; lastTapKey=tapKey;
    if(isDouble && window.__wordshift_lifelineReveal && !isDV){
      window.__wordshift_lifelineReveal(r,c);
    }
    e.stopPropagation(); e.stopImmediatePropagation(); // prevent original handler
    clearTypingPreview();
    var wildcardMsg = (hintTap && hintTap.wildcardWord) ? ('Wildcard: '+hintTap.wildcardWord) : '';
    // Fold candidates across all prior rows that have info
    var combined = null;
    var fogOn = st.mutators && st.mutators.fog;
    var fogRow = isDV ? tapRow : lastRow;
    for(var rr=0; rr<=lastRow; rr++){
      if(isDV && rr===lastRow) continue;
      var hint = (st.hints && st.hints[rr]) ? st.hints[rr][c] : null;
      if(!hint || hint.hidden) continue;
      if(isDoubleVisionMask(st, rr, c)) continue;
      if(fogOn && rr!==fogRow) continue;
      // Use rows that offered information
      var dname = effectiveDifficulty(st.difficulty);
      var hasInfo = !hint.noisyArrow && (hint.exact || hint.grayed || hint.showArrow || hint.showNumber || (dname==='insane' && !hint.grayed) || (dname==='impossible' && !hint.grayed));
      if(!hasInfo) continue;
      var set = candidatesFromHintForColumn(rr,c, false, isDV && fogOn && rr===tapRow);
      if(set && set.size>0){
        combined = intersect(combined, set);
      }
    }
    // Fallback to last-row-only if nothing combined
    if(!combined || combined.size===0){
      combined = candidatesFromHintForColumn((isDV ? tapRow : lastRow),c, false, isDV && fogOn) || new Set();
    }
    if(!combined || combined.size===0){
      combined = new Set(ALPHA);
    }
    // Paint keyboard
    clearKbdHints();
    KBD.classList.add('kbd-hints-on');
    if(st) st.kbdHintsOn=true;
    var n=0; var keys = KBD.querySelectorAll('.key[data-key]');
    for(var i=0;i<keys.length;i++){
      var ch=keys[i].getAttribute('data-key');
      if(ch && ch.length===1){
        if(combined.has(ch)){ keys[i].classList.add('cand'); n++; }
        else { keys[i].classList.add('nocand'); }
      }
    }
    toast((wildcardMsg ? (wildcardMsg+' â€¢ ') : '')+'Possible letters: '+n);
  }
  // attach capture listener once
  var attached = false;
  if(!attached){
    BOARD.addEventListener('click', enhancedTileTap, true); // capture
    attached = true;
  }
  // expose state hook: the main game stores state in a closure; mirror a reference so we can read it
  // The game code sets window.__wordshift_state when building board.
  // If not present, set a timer to retry:
  if(!window.__wordshift_state){
    var tries=0; var id=setInterval(function(){
      tries++; if(window.__wordshift_state || tries>50) clearInterval(id);
    },200);
  }
})();
</script>

<script>
(function(){
  if(!('serviceWorker' in navigator)) return;
  var host=(location && location.hostname) ? location.hostname : '';
  var isLocal=(host==='localhost' || host==='127.0.0.1' || host==='::1');
  if(location.protocol!=='https:' && !isLocal) return;
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('./sw.js').catch(function(err){
      console.warn('[pwa] service worker registration failed', err);
    });
  });
})();
</script>
</body>
</html>








